<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.63" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://mister-hope.github.io/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html"><meta property="og:site_name" content="huamus"><meta property="og:title" content="Spring IOC å®¹å™¨æºç åˆ†æ"><meta property="og:description" content="åŸæ–‡é“¾æ¥ï¼šhttps://www.javadoop.com/post/design-pattern ä½œè€…ï¼šJavadoop Spring æœ€é‡è¦çš„æ¦‚å¿µæ˜¯ IOC å’Œ AOPï¼Œæœ¬ç¯‡æ–‡ç« å…¶å®å°±æ˜¯è¦å¸¦é¢†å¤§å®¶æ¥åˆ†æä¸‹ Spring çš„ IOC å®¹å™¨ã€‚æ—¢ç„¶å¤§å®¶å¹³æ—¶éƒ½è¦ç”¨åˆ° Springï¼Œæ€ä¹ˆå¯ä»¥ä¸å¥½å¥½äº†è§£ Spring å‘¢ï¼Ÿé˜…è¯»æœ¬æ–‡å¹¶ä¸èƒ½è®©ä½ æˆä¸º Spring ä¸“å®¶ï¼Œä¸è¿‡ä¸€å®šæœ‰åŠ©äºå¤§å®¶ç†è§£ Spring çš„å¾ˆå¤šæ¦‚å¿µï¼Œå¸®åŠ©å¤§å®¶æ’æŸ¥åº”ç”¨ä¸­å’Œ Spring ç›¸å…³çš„ä¸€äº›é—®é¢˜ã€‚"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-07-21T08:36:07.000Z"><meta property="article:author" content="huamus"><meta property="article:modified_time" content="2023-07-21T08:36:07.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Spring IOC å®¹å™¨æºç åˆ†æ","image":[""],"dateModified":"2023-07-21T08:36:07.000Z","author":[{"@type":"Person","name":"huamus"}]}</script><title>Spring IOC å®¹å™¨æºç åˆ†æ | huamus</title><meta name="description" content="åŸæ–‡é“¾æ¥ï¼šhttps://www.javadoop.com/post/design-pattern ä½œè€…ï¼šJavadoop Spring æœ€é‡è¦çš„æ¦‚å¿µæ˜¯ IOC å’Œ AOPï¼Œæœ¬ç¯‡æ–‡ç« å…¶å®å°±æ˜¯è¦å¸¦é¢†å¤§å®¶æ¥åˆ†æä¸‹ Spring çš„ IOC å®¹å™¨ã€‚æ—¢ç„¶å¤§å®¶å¹³æ—¶éƒ½è¦ç”¨åˆ° Springï¼Œæ€ä¹ˆå¯ä»¥ä¸å¥½å¥½äº†è§£ Spring å‘¢ï¼Ÿé˜…è¯»æœ¬æ–‡å¹¶ä¸èƒ½è®©ä½ æˆä¸º Spring ä¸“å®¶ï¼Œä¸è¿‡ä¸€å®šæœ‰åŠ©äºå¤§å®¶ç†è§£ Spring çš„å¾ˆå¤šæ¦‚å¿µï¼Œå¸®åŠ©å¤§å®¶æ’æŸ¥åº”ç”¨ä¸­å’Œ Spring ç›¸å…³çš„ä¸€äº›é—®é¢˜ã€‚">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/myblogs/assets/style-2cface98.css" as="style"><link rel="stylesheet" href="/myblogs/assets/style-2cface98.css">
    <link rel="modulepreload" href="/myblogs/assets/app-39e7b6f2.js"><link rel="modulepreload" href="/myblogs/assets/SpringIOCContainerSourceCodeAnalysis.html-9518d844.js"><link rel="modulepreload" href="/myblogs/assets/SpringIOCContainerSourceCodeAnalysis.html-eab41096.js"><link rel="modulepreload" href="/myblogs/assets/plugin-vue_export-helper-c27b6911.js"><link rel="prefetch" href="/myblogs/assets/index.html-81a9abfc.js" as="script"><link rel="prefetch" href="/myblogs/assets/intro.html-39e1e0a4.js" as="script"><link rel="prefetch" href="/myblogs/assets/slides.html-f9c5ab45.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-cae7638a.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-0dc9baf3.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-29d1515a.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-7793269b.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-916b651c.js" as="script"><link rel="prefetch" href="/myblogs/assets/IntruductionToSpringAOPUsage.html-dd28f4c4.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-11a57666.js" as="script"><link rel="prefetch" href="/myblogs/assets/SpringAOPSourceCodeParsing.html-e6e82807.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-d10e2315.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-724da181.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-de6c2376.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-668acac8.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-2954cf3e.js" as="script"><link rel="prefetch" href="/myblogs/assets/designPatternCanBeSimple.html-e252c176.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.1.html-c3b017d1.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-9178650a.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.1.html-a1fb27c2.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.2.html-65da77f5.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-d20035e3.js" as="script"><link rel="prefetch" href="/myblogs/assets/3.1.html-53dd567a.js" as="script"><link rel="prefetch" href="/myblogs/assets/3.8.html-c3b51598.js" as="script"><link rel="prefetch" href="/myblogs/assets/3.9.html-1fcf0590.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-892fe4cd.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.1.html-2787f9da.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.2.html-30671040.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-7423c168.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.1.html-3059b86c.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-013d588a.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.1.html-f7c0a62c.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-6645ae24.js" as="script"><link rel="prefetch" href="/myblogs/assets/10.1.html-412a41ce.js" as="script"><link rel="prefetch" href="/myblogs/assets/10.2.html-d646637a.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-4f8e5cd2.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.4.html-7b4110b8.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.6.html-2d4cf2af.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-90252028.js" as="script"><link rel="prefetch" href="/myblogs/assets/3.1.html-0f3f5939.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-dcb6ebd7.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.1.html-02bbe131.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.2.html-34f4a0f9.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.3.html-5047725f.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.5.html-bc88c5c5.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-fd8bf4d0.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.1.html-2236f073.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.2.html-d30190a5.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.3.html-e08f8107.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.4.html-3b77137e.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.5.html-f45d40e6.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.7.html-f6e5bc71.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-22fd464a.js" as="script"><link rel="prefetch" href="/myblogs/assets/6.1.html-5c8e8185.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-830351f1.js" as="script"><link rel="prefetch" href="/myblogs/assets/7.1.html-665ffa89.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-b8237bd0.js" as="script"><link rel="prefetch" href="/myblogs/assets/9.1.html-2209aca4.js" as="script"><link rel="prefetch" href="/myblogs/assets/9.2.html-11213097.js" as="script"><link rel="prefetch" href="/myblogs/assets/9.3.html-29c43d1d.js" as="script"><link rel="prefetch" href="/myblogs/assets/9.4.html-92961a25.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-d842ff69.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-5b63a12d.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-388051d0.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-134d075f.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-732b485c.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-1fa9d7b4.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-6994998a.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-3ef9e8d0.js" as="script"><link rel="prefetch" href="/myblogs/assets/3.html-6f8439a5.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.html-191fdfc9.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-ac930b6f.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-8d6f66e5.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-5790b7f5.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-f0fffb76.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-700ff5b8.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-829ed06a.js" as="script"><link rel="prefetch" href="/myblogs/assets/3.html-d699a774.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.html-2c6b23fa.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.html-5c18577f.js" as="script"><link rel="prefetch" href="/myblogs/assets/6.html-b4ac8a3f.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-82b76e15.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-8830ddf4.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-6295ee2f.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-db2dbcfc.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-e6e12a2e.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-92a58ebf.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-41e57843.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-7e98bed9.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-413fa225.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-98026304.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-4c6084d1.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-8829ca52.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-a3981e06.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-225dc381.js" as="script"><link rel="prefetch" href="/myblogs/assets/3.html-f96b4626.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-eddbe98c.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-68469716.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-16d12d89.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-17f897d5.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-75f89789.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-6827ecf9.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-d866d77d.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-8f9906f4.js" as="script"><link rel="prefetch" href="/myblogs/assets/404.html-60ca5acc.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-c41bb8f4.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-a0b85eba.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-9a60e4a5.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-cbeb7b6a.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-4ff53da1.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-a5aa7f6c.js" as="script"><link rel="prefetch" href="/myblogs/assets/intro.html-ef03120f.js" as="script"><link rel="prefetch" href="/myblogs/assets/slides.html-c5febff4.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-c29088fa.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-87f64d46.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-919c21c5.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-5045a795.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-15a0f5a1.js" as="script"><link rel="prefetch" href="/myblogs/assets/IntruductionToSpringAOPUsage.html-90a566de.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-e5de4d1e.js" as="script"><link rel="prefetch" href="/myblogs/assets/SpringAOPSourceCodeParsing.html-2deb71f9.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-26bcb0f8.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-fb62ea46.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-507d68dc.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-9215cfbf.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-ad2c7eef.js" as="script"><link rel="prefetch" href="/myblogs/assets/designPatternCanBeSimple.html-2b3e4976.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.1.html-b5f63757.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-8c3d9dba.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.1.html-716f0663.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.2.html-65cd7b72.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-fb63b22b.js" as="script"><link rel="prefetch" href="/myblogs/assets/3.1.html-2906739c.js" as="script"><link rel="prefetch" href="/myblogs/assets/3.8.html-02dfa5b9.js" as="script"><link rel="prefetch" href="/myblogs/assets/3.9.html-21383809.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-fc4dc2d4.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.1.html-7ea3248e.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.2.html-78481f4d.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-35d05bcb.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.1.html-21b048e4.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-3f246d4f.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.1.html-09c99745.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-936e341b.js" as="script"><link rel="prefetch" href="/myblogs/assets/10.1.html-156be05e.js" as="script"><link rel="prefetch" href="/myblogs/assets/10.2.html-4d266496.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-ded9af63.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.4.html-c734b6cc.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.6.html-2a90a211.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-bc0ee3bb.js" as="script"><link rel="prefetch" href="/myblogs/assets/3.1.html-fe62b826.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-7e713b33.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.1.html-f81cbfc7.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.2.html-a3b4b08b.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.3.html-681776f3.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.5.html-447b392a.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-54f5754f.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.1.html-84ef85cd.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.2.html-d69cc0c3.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.3.html-d753a58a.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.4.html-79e292b5.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.5.html-3167b685.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.7.html-a6bff328.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-4c9ce717.js" as="script"><link rel="prefetch" href="/myblogs/assets/6.1.html-97bbee01.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-c9c8af36.js" as="script"><link rel="prefetch" href="/myblogs/assets/7.1.html-1b110349.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-1959d591.js" as="script"><link rel="prefetch" href="/myblogs/assets/9.1.html-7252fb44.js" as="script"><link rel="prefetch" href="/myblogs/assets/9.2.html-78e96bf2.js" as="script"><link rel="prefetch" href="/myblogs/assets/9.3.html-aab15e20.js" as="script"><link rel="prefetch" href="/myblogs/assets/9.4.html-fc6d0e29.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-f4ce93bd.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-86bf00d5.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-1ae3c3a2.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-7691e745.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-8ec43d41.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-7725ddd4.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-8c446f14.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-fccdbde2.js" as="script"><link rel="prefetch" href="/myblogs/assets/3.html-54156608.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.html-f1b89111.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-53d7ccc2.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-531ca152.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-2c0e4488.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-b9779f7b.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-818ab909.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-ec711914.js" as="script"><link rel="prefetch" href="/myblogs/assets/3.html-5bfadab7.js" as="script"><link rel="prefetch" href="/myblogs/assets/4.html-49bf5b03.js" as="script"><link rel="prefetch" href="/myblogs/assets/5.html-26f6d196.js" as="script"><link rel="prefetch" href="/myblogs/assets/6.html-14af4cab.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-90ab0579.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-51f4285d.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-ae8e0e24.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-973c907e.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-f061df1e.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-3a66720e.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-02eaaca1.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-124a0982.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-f9a61f9b.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-b5f76b6c.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-4c14d6b1.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-f393db14.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-bffc41f9.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-1f406e77.js" as="script"><link rel="prefetch" href="/myblogs/assets/3.html-3a300075.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-0144f01a.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-46667fcb.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-50b14960.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-95281a4b.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-c4dca987.js" as="script"><link rel="prefetch" href="/myblogs/assets/1.html-866b86ab.js" as="script"><link rel="prefetch" href="/myblogs/assets/2.html-49a1cc58.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-30283bb5.js" as="script"><link rel="prefetch" href="/myblogs/assets/404.html-baaf8469.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-8ad4c16d.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-fd133806.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-9c409c8b.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-e0e0b02b.js" as="script"><link rel="prefetch" href="/myblogs/assets/index.html-5469ca95.js" as="script"><link rel="prefetch" href="/myblogs/assets/waline-meta-a31b78ed.js" as="script"><link rel="prefetch" href="/myblogs/assets/component-8df2bd62.js" as="script"><link rel="prefetch" href="/myblogs/assets/auto-fa8841cf.js" as="script"><link rel="prefetch" href="/myblogs/assets/index-ae8c1e74.js" as="script"><link rel="prefetch" href="/myblogs/assets/flowchart-d65a1d8e.js" as="script"><link rel="prefetch" href="/myblogs/assets/mermaid.core-1c41ad74.js" as="script"><link rel="prefetch" href="/myblogs/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/myblogs/assets/markdown.esm-0191f9da.js" as="script"><link rel="prefetch" href="/myblogs/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/myblogs/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/myblogs/assets/reveal.esm-ec5549c1.js" as="script"><link rel="prefetch" href="/myblogs/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/myblogs/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/myblogs/assets/VuePlayground-07b9f866.js" as="script"><link rel="prefetch" href="/myblogs/assets/photoswipe.esm-2450701e.js" as="script"><link rel="prefetch" href="/myblogs/assets/pageview-7906dfb1.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar hide-icon"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/myblogs/"><img class="vp-nav-logo" src="https://huamus.github.io/mynotes/logo.jpg" alt="huamus"><!----><span class="vp-site-name hide-in-pad">huamus</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/myblogs/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>åšå®¢ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="çŸ¥è¯†åº“"><span class="title"><!---->çŸ¥è¯†åº“</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="vp-link nav-link" href="/myblogs/knowledgeBase/JavaCompanion/"><!---->java æŒ‡å—<!----></a></li><li class="dropdown-item"><a class="vp-link nav-link" href="/myblogs/knowledgeBase/xiaolinCoding/"><!---->å°æ—codingæ•´ç†ç‰ˆ<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="åšæ–‡"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>åšæ–‡</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>è‹¹æœ</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="vp-link nav-link" href="/myblogs/posts/apple/1.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>è‹¹æœ1<!----></a></li><li class="dropdown-subitem"><a class="vp-link nav-link" href="/myblogs/posts/apple/2.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>è‹¹æœ2<!----></a></li><li class="dropdown-subitem"><a class="vp-link nav-link" href="/myblogs/posts/apple/3.html"><!---->/posts/apple/3<!----></a></li><li class="dropdown-subitem"><a class="vp-link nav-link" href="/myblogs/posts/apple/4.html"><!---->/posts/apple/4<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>é¦™è•‰</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="vp-link nav-link" href="/myblogs/posts/banana/1.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>é¦™è•‰ 1<!----></a></li><li class="dropdown-subitem"><a class="vp-link nav-link" href="/myblogs/posts/banana/2.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>é¦™è•‰ 2<!----></a></li><li class="dropdown-subitem"><a class="vp-link nav-link" href="/myblogs/posts/banana/3.html"><!---->/posts/banana/3<!----></a></li><li class="dropdown-subitem"><a class="vp-link nav-link" href="/myblogs/posts/banana/4.html"><!---->/posts/banana/4<!----></a></li></ul></li><li class="dropdown-item"><a class="vp-link nav-link" href="/myblogs/posts/cherry.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>æ¨±æ¡ƒ<!----></a></li><li class="dropdown-item"><a class="vp-link nav-link" href="/myblogs/posts/dragonfruit.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>ç«é¾™æœ<!----></a></li><li class="dropdown-item"><a class="vp-link nav-link" href="/myblogs/posts/tomato.html"><!---->/posts/tomato<!----></a></li><li class="dropdown-item"><a class="vp-link nav-link" href="/myblogs/posts/strawberry.html"><!---->/posts/strawberry<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="https://theme-hope.vuejs.press/zh/" rel="noopener noreferrer" target="_blank" aria-label="V2 æ–‡æ¡£" class="nav-link"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>V2 æ–‡æ¡£<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">å°æ—codingæ•´ç†ç‰ˆ</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">java æŒ‡å—</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">æŠ€æœ¯æ–‡ç« æ‘˜å½•</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Java</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">Spring</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/IntruductionToSpringAOPUsage.html"><!---->Spring AOP ä½¿ç”¨ä»‹ç»ï¼Œä»å‰ä¸–åˆ°ä»Šç”Ÿ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringAOPSourceCodeParsing.html"><!---->Spring AOP æºç è§£æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html"><!---->Spring IOC å®¹å™¨æºç åˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#å¼•è¨€"><!---->å¼•è¨€<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#beanfactory-ç®€ä»‹"><!---->BeanFactory ç®€ä»‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#å¯åŠ¨è¿‡ç¨‹åˆ†æ"><!---->å¯åŠ¨è¿‡ç¨‹åˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#åˆ›å»º-bean-å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ"><!---->åˆ›å»º Bean å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#åˆ›å»º-bean-å®¹å™¨-åŠ è½½å¹¶æ³¨å†Œ-bean"><!---->åˆ›å»º Bean å®¹å™¨ï¼ŒåŠ è½½å¹¶æ³¨å†Œ Bean<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#bean-å®¹å™¨å®ä¾‹åŒ–å®Œæˆå"><!---->Bean å®¹å™¨å®ä¾‹åŒ–å®Œæˆå<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#å‡†å¤‡-bean-å®¹å™¨-preparebeanfactory"><!---->å‡†å¤‡ Bean å®¹å™¨: prepareBeanFactory<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#åˆå§‹åŒ–æ‰€æœ‰çš„-singleton-beans"><!---->åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#é™„å½•"><!---->é™„å½•<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#id-å’Œ-name"><!---->id å’Œ name<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#é…ç½®æ˜¯å¦å…è®¸-bean-è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–"><!---->é…ç½®æ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#profile"><!---->profile<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#å·¥å‚æ¨¡å¼ç”Ÿæˆ-bean"><!---->å·¥å‚æ¨¡å¼ç”Ÿæˆ Bean<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#factorybean"><!---->FactoryBean<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#åˆå§‹åŒ–-bean-çš„å›è°ƒ"><!---->åˆå§‹åŒ– Bean çš„å›è°ƒ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#é”€æ¯-bean-çš„å›è°ƒ"><!---->é”€æ¯ Bean çš„å›è°ƒ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#conversionservice"><!---->ConversionService<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#bean-ç»§æ‰¿"><!---->Bean ç»§æ‰¿<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#æ–¹æ³•æ³¨å…¥"><!---->æ–¹æ³•æ³¨å…¥<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#beanpostprocessor"><!---->BeanPostProcessor<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html#æ€»ç»“"><!---->æ€»ç»“<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li></ul></section></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Spring IOC å®¹å™¨æºç åˆ†æ</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">huamus</span></span><span property="author" content="huamus"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-07-20T14:40:01.000Z"></span><span class="page-pageview-info" aria-label="è®¿é—®é‡ğŸ”¢" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="waline-pageview-count" data-path="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.html">...</span></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 62 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT62M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/myblogs/#å¼•è¨€">å¼•è¨€</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/myblogs/#beanfactory-ç®€ä»‹">BeanFactory ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/myblogs/#å¯åŠ¨è¿‡ç¨‹åˆ†æ">å¯åŠ¨è¿‡ç¨‹åˆ†æ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#åˆ›å»º-bean-å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ">åˆ›å»º Bean å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#åˆ›å»º-bean-å®¹å™¨-åŠ è½½å¹¶æ³¨å†Œ-bean">åˆ›å»º Bean å®¹å™¨ï¼ŒåŠ è½½å¹¶æ³¨å†Œ Bean</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#bean-å®¹å™¨å®ä¾‹åŒ–å®Œæˆå">Bean å®¹å™¨å®ä¾‹åŒ–å®Œæˆå</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#å‡†å¤‡-bean-å®¹å™¨-preparebeanfactory">å‡†å¤‡ Bean å®¹å™¨: prepareBeanFactory</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#åˆå§‹åŒ–æ‰€æœ‰çš„-singleton-beans">åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/myblogs/#é™„å½•">é™„å½•</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#id-å’Œ-name">id å’Œ name</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#é…ç½®æ˜¯å¦å…è®¸-bean-è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–">é…ç½®æ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#profile">profile</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#å·¥å‚æ¨¡å¼ç”Ÿæˆ-bean">å·¥å‚æ¨¡å¼ç”Ÿæˆ Bean</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#factorybean">FactoryBean</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#åˆå§‹åŒ–-bean-çš„å›è°ƒ">åˆå§‹åŒ– Bean çš„å›è°ƒ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#é”€æ¯-bean-çš„å›è°ƒ">é”€æ¯ Bean çš„å›è°ƒ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#conversionservice">ConversionService</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#bean-ç»§æ‰¿">Bean ç»§æ‰¿</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#æ–¹æ³•æ³¨å…¥">æ–¹æ³•æ³¨å…¥</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/myblogs/#beanpostprocessor">BeanPostProcessor</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/myblogs/#æ€»ç»“">æ€»ç»“</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><blockquote><p>åŸæ–‡é“¾æ¥ï¼š<a href="https://www.javadoop.com/post/design-pattern" target="_blank" rel="noopener noreferrer">https://www.javadoop.com/post/design-pattern<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>ä½œè€…ï¼šJavadoop</p></blockquote><p>Spring æœ€é‡è¦çš„æ¦‚å¿µæ˜¯ IOC å’Œ AOPï¼Œæœ¬ç¯‡æ–‡ç« å…¶å®å°±æ˜¯è¦å¸¦é¢†å¤§å®¶æ¥åˆ†æä¸‹ Spring çš„ IOC å®¹å™¨ã€‚æ—¢ç„¶å¤§å®¶å¹³æ—¶éƒ½è¦ç”¨åˆ° Springï¼Œæ€ä¹ˆå¯ä»¥ä¸å¥½å¥½äº†è§£ Spring å‘¢ï¼Ÿé˜…è¯»æœ¬æ–‡å¹¶ä¸èƒ½è®©ä½ æˆä¸º Spring ä¸“å®¶ï¼Œä¸è¿‡ä¸€å®šæœ‰åŠ©äºå¤§å®¶ç†è§£ Spring çš„å¾ˆå¤šæ¦‚å¿µï¼Œå¸®åŠ©å¤§å®¶æ’æŸ¥åº”ç”¨ä¸­å’Œ Spring ç›¸å…³çš„ä¸€äº›é—®é¢˜ã€‚</p><p>æœ¬æ–‡é‡‡ç”¨çš„æºç ç‰ˆæœ¬æ˜¯ 4.3.11.RELEASEï¼Œç®—æ˜¯ 5.0.x å‰æ¯”è¾ƒæ–°çš„ç‰ˆæœ¬äº†ã€‚ä¸ºäº†é™ä½éš¾åº¦ï¼Œæœ¬æ–‡æ‰€è¯´çš„æ‰€æœ‰çš„å†…å®¹éƒ½æ˜¯åŸºäº xml çš„é…ç½®çš„æ–¹å¼ï¼Œå®é™…ä½¿ç”¨å·²ç»å¾ˆå°‘äººè¿™ä¹ˆåšäº†ï¼Œè‡³å°‘ä¸æ˜¯çº¯ xml é…ç½®ï¼Œä¸è¿‡ä»ç†è§£æºç çš„è§’åº¦æ¥çœ‹ç”¨è¿™ç§æ–¹å¼æ¥è¯´æ— ç–‘æ˜¯æœ€åˆé€‚çš„ã€‚</p><p>é˜…è¯»å»ºè®®ï¼šè¯»è€…è‡³å°‘éœ€è¦çŸ¥é“æ€ä¹ˆé…ç½® Springï¼Œäº†è§£ Spring ä¸­çš„å„ç§æ¦‚å¿µï¼Œå°‘éƒ¨åˆ†å†…å®¹æˆ‘è¿˜å‡è®¾è¯»è€…ä½¿ç”¨è¿‡ SpringMVCã€‚æœ¬æ–‡è¦è¯´çš„ IOC æ€»ä½“æ¥è¯´æœ‰ä¸¤å¤„åœ°æ–¹æœ€é‡è¦ï¼Œä¸€ä¸ªæ˜¯åˆ›å»º Bean å®¹å™¨ï¼Œä¸€ä¸ªæ˜¯åˆå§‹åŒ– Beanï¼Œå¦‚æœè¯»è€…è§‰å¾—ä¸€æ¬¡æ€§çœ‹å®Œæœ¬æ–‡å‹åŠ›æœ‰ç‚¹å¤§ï¼Œé‚£ä¹ˆå¯ä»¥æŒ‰è¿™ä¸ªæ€è·¯åˆ†ä¸¤æ¬¡æ¶ˆåŒ–ã€‚è¯»è€…ä¸ä¸€å®šå¯¹ Spring å®¹å™¨çš„æºç æ„Ÿå…´è¶£ï¼Œä¹Ÿè®¸é™„å½•éƒ¨åˆ†ä»‹ç»çš„çŸ¥è¯†å¯¹è¯»è€…æœ‰äº›è®¸ä½œç”¨ã€‚</p><p>å¸Œæœ›é€šè¿‡æœ¬æ–‡å¯ä»¥è®©è¯»è€…ä¸æƒ§æ€•é˜…è¯» Spring æºç ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶èƒ½åé¦ˆè¡¨è¿°é”™è¯¯æˆ–ä¸åˆç†çš„åœ°æ–¹ã€‚</p><h2 id="å¼•è¨€" tabindex="-1"><a class="header-anchor" href="#å¼•è¨€" aria-hidden="true">#</a> å¼•è¨€</h2><p>å…ˆçœ‹ä¸‹æœ€åŸºæœ¬çš„å¯åŠ¨ Spring å®¹å™¨çš„ä¾‹å­ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:applicationfile.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šä»£ç å°±å¯ä»¥åˆ©ç”¨é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ä¸€ä¸ª Spring å®¹å™¨äº†ï¼Œè¯·<strong>ä½¿ç”¨ maven çš„å°ä¼™ä¼´ç›´æ¥åœ¨ dependencies ä¸­åŠ ä¸Šä»¥ä¸‹ä¾èµ–</strong>å³å¯ï¼Œä¸ªäººæ¯”è¾ƒåå¯¹é‚£äº›ä¸çŸ¥é“è¦æ·»åŠ ä»€ä¹ˆä¾èµ–ï¼Œç„¶åæŠŠ Spring çš„æ‰€æœ‰ç›¸å…³çš„ä¸œè¥¿éƒ½åŠ è¿›æ¥çš„æ–¹å¼ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
  <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>context<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">4.3</span><span class="token number">.11</span><span class="token punctuation">.</span><span class="token constant">RELEASE</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>spring-context ä¼šè‡ªåŠ¨å°† spring-coreã€spring-beansã€spring-aopã€spring-expression è¿™å‡ ä¸ªåŸºç¡€ jar åŒ…å¸¦è¿›æ¥ã€‚</p><p>å¤šè¯´ä¸€å¥ï¼Œå¾ˆå¤šå¼€å‘è€…å…¥é—¨å°±ç›´æ¥æ¥è§¦çš„ SpringMVCï¼Œå¯¹ Spring å…¶å®ä¸æ˜¯å¾ˆäº†è§£ï¼ŒSpring æ˜¯æ¸è¿›å¼çš„å·¥å…·ï¼Œå¹¶ä¸å…·æœ‰å¾ˆå¼ºçš„ä¾µå…¥æ€§ï¼Œå®ƒçš„æ¨¡å—ä¹Ÿåˆ’åˆ†å¾—å¾ˆåˆç†ï¼Œå³ä½¿ä½ çš„åº”ç”¨ä¸æ˜¯ web åº”ç”¨ï¼Œæˆ–è€…ä¹‹å‰å®Œå…¨æ²¡æœ‰ä½¿ç”¨åˆ° Springï¼Œè€Œä½ å°±æƒ³ç”¨ Spring çš„ä¾èµ–æ³¨å…¥è¿™ä¸ªåŠŸèƒ½ï¼Œå…¶å®å®Œå…¨æ˜¯å¯ä»¥çš„ï¼Œå®ƒçš„å¼•å…¥ä¸ä¼šå¯¹å…¶ä»–çš„ç»„ä»¶äº§ç”Ÿå†²çªã€‚</p><p>åºŸè¯è¯´å®Œï¼Œæˆ‘ä»¬ç»§ç»­ã€‚<code>ApplicationContext context = new ClassPathXmlApplicationContext(...)</code>å…¶å®å¾ˆå¥½ç†è§£ï¼Œä»åå­—ä¸Šå°±å¯ä»¥çŒœå‡ºä¸€äºŒï¼Œå°±æ˜¯åœ¨ ClassPath ä¸­å¯»æ‰¾ xml é…ç½®æ–‡ä»¶ï¼Œæ ¹æ® xml æ–‡ä»¶å†…å®¹æ¥æ„å»º ApplicationContextã€‚å½“ç„¶ï¼Œé™¤äº† ClassPathXmlApplicationContext ä»¥å¤–ï¼Œæˆ‘ä»¬ä¹Ÿè¿˜æœ‰å…¶ä»–æ„å»º ApplicationContext çš„æ–¹æ¡ˆå¯ä¾›é€‰æ‹©ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¤§ä½“çš„ç»§æ‰¿ç»“æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼š</p><figure><img src="https://raw.githubusercontent.com/huamus/picture-bed/main/202307202238058.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>è¯»è€…å¯ä»¥å¤§è‡´çœ‹ä¸€ä¸‹ç±»åï¼Œæºç åˆ†æçš„æ—¶å€™ä¸è‡³äºæ‰¾ä¸ç€çœ‹å“ªä¸ªç±»ï¼Œå› ä¸º Spring ä¸ºäº†é€‚åº”å„ç§ä½¿ç”¨åœºæ™¯ï¼Œæä¾›çš„å„ä¸ªæ¥å£éƒ½å¯èƒ½æœ‰å¾ˆå¤šçš„å®ç°ç±»ã€‚å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œå°±æ˜¯æªç€ä¸€ä¸ªå®Œæ•´çš„åˆ†æ”¯çœ‹å®Œã€‚</p><p>å½“ç„¶ï¼Œè¯»æœ¬æ–‡çš„æ—¶å€™è¯»è€…ä¹Ÿä¸å¿…å¤ªæ‹…å¿ƒï¼Œæ¯ä¸ªä»£ç å—åˆ†æçš„æ—¶å€™ï¼Œæˆ‘éƒ½ä¼šå‘Šè¯‰è¯»è€…æˆ‘ä»¬åœ¨è¯´å“ªä¸ªç±»ç¬¬å‡ è¡Œã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒClassPathXmlApplicationContext å…œå…œè½¬è½¬äº†å¥½ä¹…æ‰åˆ° ApplicationContext æ¥å£ï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ç»¿é¢œè‰²çš„ FileSystemXmlApplicationContext å’Œ AnnotationConfigApplicationContext è¿™ä¸¤ä¸ªç±»ã€‚</p><p>1ã€FileSystemXmlApplicationContext çš„æ„é€ å‡½æ•°éœ€è¦ä¸€ä¸ª xml é…ç½®æ–‡ä»¶åœ¨ç³»ç»Ÿä¸­çš„è·¯å¾„ï¼Œå…¶ä»–å’Œ ClassPathXmlApplicationContext åŸºæœ¬ä¸Šä¸€æ ·ã€‚</p><p>2ã€AnnotationConfigApplicationContext æ˜¯åŸºäºæ³¨è§£æ¥ä½¿ç”¨çš„ï¼Œå®ƒä¸éœ€è¦é…ç½®æ–‡ä»¶ï¼Œé‡‡ç”¨ java é…ç½®ç±»å’Œå„ç§æ³¨è§£æ¥é…ç½®ï¼Œæ˜¯æ¯”è¾ƒç®€å•çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯å¤§åŠ¿æ‰€è¶‹å§ã€‚</p><p>ä¸è¿‡æœ¬æ–‡æ—¨åœ¨å¸®åŠ©å¤§å®¶ç†è§£æ•´ä¸ªæ„å»ºæµç¨‹ï¼Œæ‰€ä»¥å†³å®šä½¿ç”¨ ClassPathXmlApplicationContext è¿›è¡Œåˆ†æã€‚</p><p>æˆ‘ä»¬å…ˆæ¥ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹çœ‹æ€ä¹ˆå®ä¾‹åŒ– ApplicationContextã€‚</p><p>é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªæ¥å£ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MessageService</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®šä¹‰æ¥å£å®ç°ç±»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MessageService</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ <strong>resources ç›®å½•æ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶åéšæ„ï¼Œé€šå¸¸å« application.xml æˆ– application-xxx.xml</strong> å°±å¯ä»¥äº†ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd<span class="token punctuation">&quot;</span></span> <span class="token attr-name">default-autowire</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>byName<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>messageService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.javadoop.example.MessageServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·‘èµ·æ¥äº†ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç”¨æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ä¸€ä¸ª ApplicationContext</span>
        <span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:application.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;context å¯åŠ¨æˆåŠŸ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ä» context ä¸­å–å‡ºæˆ‘ä»¬çš„ Beanï¼Œè€Œä¸æ˜¯ç”¨ new MessageServiceImpl() è¿™ç§æ–¹å¼</span>
        <span class="token class-name">MessageService</span> messageService <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">MessageService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¿™å¥å°†è¾“å‡º: hello world</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>messageService<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šä¾‹å­å¾ˆç®€å•ï¼Œä¸è¿‡ä¹Ÿå¤Ÿå¼•å‡ºæœ¬æ–‡çš„ä¸»é¢˜äº†ï¼Œå°±æ˜¯æ€ä¹ˆæ ·é€šè¿‡é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ Spring çš„ ApplicationContext ï¼Ÿä¹Ÿå°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦åˆ†æçš„ IOC çš„æ ¸å¿ƒäº†ã€‚<strong>ApplicationContext å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šè´Ÿè´£åˆ›å»ºå®ä¾‹ Beanï¼Œå¾€å„ä¸ª Bean ä¸­æ³¨å…¥ä¾èµ–ç­‰ã€‚</strong></p><h2 id="beanfactory-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#beanfactory-ç®€ä»‹" aria-hidden="true">#</a> BeanFactory ç®€ä»‹</h2><p><strong>BeanFactoryï¼Œä»åå­—ä¸Šä¹Ÿå¾ˆå¥½ç†è§£ï¼Œç”Ÿäº§ bean çš„å·¥å‚ï¼Œå®ƒè´Ÿè´£ç”Ÿäº§å’Œç®¡ç†å„ä¸ª bean å®ä¾‹ã€‚</strong></p><p>åˆå­¦è€…å¯åˆ«ä»¥ä¸ºæˆ‘ä¹‹å‰è¯´é‚£ä¹ˆå¤šå’Œ BeanFactory æ— å…³ï¼Œå‰é¢è¯´çš„ <strong>ApplicationContext å…¶å®å°±æ˜¯ä¸€ä¸ª BeanFactory</strong>ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹å’Œ BeanFactory æ¥å£ç›¸å…³çš„ä¸»è¦çš„ç»§æ‰¿ç»“æ„ï¼š</p><figure><img src="https://raw.githubusercontent.com/huamus/picture-bed/main/202307202238034.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>æˆ‘æƒ³ï¼Œå¤§å®¶çœ‹å®Œè¿™ä¸ªå›¾ä»¥åï¼Œå¯èƒ½å°±ä¸æ˜¯å¾ˆå¼€å¿ƒäº†ã€‚ApplicationContext å¾€ä¸‹çš„ç»§æ‰¿ç»“æ„å‰é¢ä¸€å¼ å›¾è¯´è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸é‡å¤äº†ã€‚è¿™å¼ å›¾å‘¢ï¼ŒèƒŒä¸‹æ¥è‚¯å®šæ˜¯ä¸éœ€è¦çš„ï¼Œæœ‰å‡ ä¸ªé‡ç‚¹å’Œå¤§å®¶è¯´æ˜ä¸‹å°±å¥½ã€‚</p><ol><li>ApplicationContext ç»§æ‰¿äº† ListableBeanFactoryï¼Œè¿™ä¸ª Listable çš„æ„æ€å°±æ˜¯ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥è·å–å¤šä¸ª Beanï¼Œå¤§å®¶çœ‹æºç ä¼šå‘ç°ï¼Œ<strong>æœ€é¡¶å±‚ BeanFactory æ¥å£çš„æ–¹æ³•éƒ½æ˜¯è·å–å•ä¸ª Bean çš„ã€‚</strong></li><li>ApplicationContext ç»§æ‰¿äº† HierarchicalBeanFactoryï¼ŒHierarchical å•è¯æœ¬èº«å·²ç»èƒ½è¯´æ˜é—®é¢˜äº†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬<strong>å¯ä»¥åœ¨åº”ç”¨ä¸­èµ·å¤šä¸ª BeanFactoryï¼Œç„¶åå¯ä»¥å°†å„ä¸ª BeanFactory è®¾ç½®ä¸ºçˆ¶å­å…³ç³»ã€‚</strong></li><li>AutowireCapableBeanFactory è¿™ä¸ªåå­—ä¸­çš„ Autowire å¤§å®¶éƒ½éå¸¸ç†Ÿæ‚‰ï¼Œå®ƒå°±æ˜¯ç”¨æ¥<strong>è‡ªåŠ¨è£…é… Bean</strong> ç”¨çš„ï¼Œä½†æ˜¯ä»”ç»†çœ‹ä¸Šå›¾ï¼ŒApplicationContext å¹¶æ²¡æœ‰ç»§æ‰¿å®ƒï¼Œä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œä¸ä½¿ç”¨ç»§æ‰¿ï¼Œä¸ä»£è¡¨ä¸å¯ä»¥ä½¿ç”¨ç»„åˆï¼Œå¦‚æœä½ çœ‹åˆ° ApplicationContext æ¥å£å®šä¹‰ä¸­çš„æœ€åä¸€ä¸ªæ–¹æ³• getAutowireCapableBeanFactory() å°±çŸ¥é“äº†ã€‚</li><li>ConfigurableListableBeanFactory ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ¥å£ï¼Œçœ‹å›¾ï¼Œç‰¹æ®Šä¹‹å¤„åœ¨äºå®ƒç»§æ‰¿äº†ç¬¬äºŒå±‚æ‰€æœ‰çš„ä¸‰ä¸ªæ¥å£ï¼Œè€Œ ApplicationContext æ²¡æœ‰ã€‚è¿™ç‚¹ä¹‹åä¼šç”¨åˆ°ã€‚</li><li>è¯·å…ˆä¸ç”¨èŠ±æ—¶é—´åœ¨å…¶ä»–çš„æ¥å£å’Œç±»ä¸Šï¼Œå…ˆç†è§£æˆ‘è¯´çš„è¿™å‡ ç‚¹å°±å¯ä»¥äº†ã€‚</li></ol><p>ç„¶åï¼Œè¯·è¯»è€…æ‰“å¼€ç¼–è¾‘å™¨ï¼Œç¿»ä¸€ä¸‹ BeanFactoryã€ListableBeanFactoryã€HierarchicalBeanFactoryã€AutowireCapableBeanFactoryã€ApplicationContext è¿™å‡ ä¸ªæ¥å£çš„ä»£ç ï¼Œå¤§æ¦‚çœ‹ä¸€ä¸‹å„ä¸ªæ¥å£ä¸­çš„æ–¹æ³•ï¼Œå¤§å®¶å¿ƒé‡Œè¦æœ‰åº•ï¼Œé™äºç¯‡å¹…ï¼Œæˆ‘å°±ä¸è´´ä»£ç ä»‹ç»äº†ã€‚</p><h2 id="å¯åŠ¨è¿‡ç¨‹åˆ†æ" tabindex="-1"><a class="header-anchor" href="#å¯åŠ¨è¿‡ç¨‹åˆ†æ" aria-hidden="true">#</a> å¯åŠ¨è¿‡ç¨‹åˆ†æ</h2><p>ä¸‹é¢å°†ä¼šæ˜¯å†—é•¿çš„ä»£ç åˆ†æï¼Œè®°ä½ï¼Œä¸€å®šè¦è‡ªå·±æ‰“å¼€æºç æ¥çœ‹ï¼Œä¸ç„¶çº¯çœ‹æ˜¯å¾ˆç´¯çš„ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬è‚¯å®šè¦ä» ClassPathXmlApplicationContext çš„æ„é€ æ–¹æ³•è¯´èµ·ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassPathXmlApplicationContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractXmlApplicationContext</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">Resource</span><span class="token punctuation">[</span><span class="token punctuation">]</span> configResources<span class="token punctuation">;</span>

  <span class="token comment">// å¦‚æœå·²ç»æœ‰ ApplicationContext å¹¶éœ€è¦é…ç½®æˆçˆ¶å­å…³ç³»ï¼Œé‚£ä¹ˆè°ƒç”¨è¿™ä¸ªæ„é€ æ–¹æ³•</span>
  <span class="token keyword">public</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">public</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> configLocations<span class="token punctuation">,</span> <span class="token keyword">boolean</span> refresh<span class="token punctuation">,</span> <span class="token class-name">ApplicationContext</span> parent<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>

    <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ ¹æ®æä¾›çš„è·¯å¾„ï¼Œå¤„ç†æˆé…ç½®æ–‡ä»¶æ•°ç»„(ä»¥åˆ†å·ã€é€—å·ã€ç©ºæ ¼ã€tabã€æ¢è¡Œç¬¦åˆ†å‰²)</span>
    <span class="token function">setConfigLocations</span><span class="token punctuation">(</span>configLocations<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>refresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ ¸å¿ƒæ–¹æ³•</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯ refresh()ï¼Œè¿™é‡Œç®€å•è¯´ä¸‹ä¸ºä»€ä¹ˆæ˜¯ refresh()ï¼Œè€Œä¸æ˜¯ init() è¿™ç§åå­—çš„æ–¹æ³•ã€‚å› ä¸º ApplicationContext å»ºç«‹èµ·æ¥ä»¥åï¼Œå…¶å®æˆ‘ä»¬æ˜¯å¯ä»¥é€šè¿‡è°ƒç”¨ refresh() è¿™ä¸ªæ–¹æ³•é‡å»ºçš„ï¼Œrefresh() ä¼šå°†åŸæ¥çš„ ApplicationContext é”€æ¯ï¼Œç„¶åå†é‡æ–°æ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–æ“ä½œã€‚</p><p>å¾€ä¸‹çœ‹ï¼Œrefresh() æ–¹æ³•é‡Œé¢è°ƒç”¨äº†é‚£ä¹ˆå¤šæ–¹æ³•ï¼Œå°±çŸ¥é“è‚¯å®šä¸ç®€å•äº†ï¼Œè¯·è¯»è€…å…ˆçœ‹ä¸ªå¤§æ¦‚ï¼Œç»†èŠ‚ä¹‹åä¼šè¯¦ç»†è¯´ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
   <span class="token comment">// æ¥ä¸ªé”ï¼Œä¸ç„¶ refresh() è¿˜æ²¡ç»“æŸï¼Œä½ åˆæ¥ä¸ªå¯åŠ¨æˆ–é”€æ¯å®¹å™¨çš„æ“ä½œï¼Œé‚£ä¸å°±ä¹±å¥—äº†å˜›</span>
   <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment">// å‡†å¤‡å·¥ä½œï¼Œè®°å½•ä¸‹å®¹å™¨çš„å¯åŠ¨æ—¶é—´ã€æ ‡è®°â€œå·²å¯åŠ¨â€çŠ¶æ€ã€å¤„ç†é…ç½®æ–‡ä»¶ä¸­çš„å ä½ç¬¦</span>
      <span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// è¿™æ­¥æ¯”è¾ƒå…³é”®ï¼Œè¿™æ­¥å®Œæˆåï¼Œé…ç½®æ–‡ä»¶å°±ä¼šè§£ææˆä¸€ä¸ªä¸ª Bean å®šä¹‰ï¼Œæ³¨å†Œåˆ° BeanFactory ä¸­ï¼Œ</span>
      <span class="token comment">// å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„ Bean è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåªæ˜¯é…ç½®ä¿¡æ¯éƒ½æå–å‡ºæ¥äº†ï¼Œ</span>
      <span class="token comment">// æ³¨å†Œä¹Ÿåªæ˜¯å°†è¿™äº›ä¿¡æ¯éƒ½ä¿å­˜åˆ°äº†æ³¨å†Œä¸­å¿ƒ(è¯´åˆ°åº•æ ¸å¿ƒæ˜¯ä¸€ä¸ª beanName-&gt; beanDefinition çš„ map)</span>
      <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæ·»åŠ å‡ ä¸ª BeanPostProcessorï¼Œæ‰‹åŠ¨æ³¨å†Œå‡ ä¸ªç‰¹æ®Šçš„ bean</span>
      <span class="token comment">// è¿™å—å¾…ä¼šä¼šå±•å¼€è¯´</span>
      <span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// ã€è¿™é‡Œéœ€è¦çŸ¥é“ BeanFactoryPostProcessor è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼ŒBean å¦‚æœå®ç°äº†æ­¤æ¥å£ï¼Œ</span>
         <span class="token comment">// é‚£ä¹ˆåœ¨å®¹å™¨åˆå§‹åŒ–ä»¥åï¼ŒSpring ä¼šè´Ÿè´£è°ƒç”¨é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•ã€‚ã€‘</span>

         <span class="token comment">// è¿™é‡Œæ˜¯æä¾›ç»™å­ç±»çš„æ‰©å±•ç‚¹ï¼Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ Bean éƒ½åŠ è½½ã€æ³¨å†Œå®Œæˆäº†ï¼Œä½†æ˜¯éƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–</span>
         <span class="token comment">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™æ­¥çš„æ—¶å€™æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„ BeanFactoryPostProcessor çš„å®ç°ç±»æˆ–åšç‚¹ä»€ä¹ˆäº‹</span>
         <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// è°ƒç”¨ BeanFactoryPostProcessor å„ä¸ªå®ç°ç±»çš„ postProcessBeanFactory(factory) æ–¹æ³•</span>
         <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æ³¨å†Œ BeanPostProcessor çš„å®ç°ç±»ï¼Œæ³¨æ„çœ‹å’Œ BeanFactoryPostProcessor çš„åŒºåˆ«</span>
         <span class="token comment">// æ­¤æ¥å£ä¸¤ä¸ªæ–¹æ³•: postProcessBeforeInitialization å’Œ postProcessAfterInitialization</span>
         <span class="token comment">// ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰å’Œåˆå§‹åŒ–ä¹‹åå¾—åˆ°æ‰§è¡Œã€‚æ³¨æ„ï¼Œåˆ°è¿™é‡Œ Bean è¿˜æ²¡åˆå§‹åŒ–</span>
         <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„ MessageSourceï¼Œå›½é™…åŒ–è¿™é‡Œå°±ä¸å±•å¼€è¯´äº†ï¼Œä¸ç„¶æ²¡å®Œæ²¡äº†äº†</span>
         <span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„äº‹ä»¶å¹¿æ’­å™¨ï¼Œè¿™é‡Œä¹Ÿä¸å±•å¼€äº†</span>
         <span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// ä»æ–¹æ³•åå°±å¯ä»¥çŸ¥é“ï¼Œå…¸å‹çš„æ¨¡æ¿æ–¹æ³•(é’©å­æ–¹æ³•)ï¼Œ</span>
         <span class="token comment">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–ä¸€äº›ç‰¹æ®Šçš„ Beanï¼ˆåœ¨åˆå§‹åŒ– singleton beans ä¹‹å‰ï¼‰</span>
         <span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬å™¨éœ€è¦å®ç° ApplicationListener æ¥å£ã€‚è¿™ä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œè¿‡</span>
         <span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// é‡ç‚¹ï¼Œé‡ç‚¹ï¼Œé‡ç‚¹</span>
         <span class="token comment">// åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans</span>
         <span class="token comment">//ï¼ˆlazy-init çš„é™¤å¤–ï¼‰</span>
         <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æœ€åï¼Œå¹¿æ’­äº‹ä»¶ï¼ŒApplicationContext åˆå§‹åŒ–å®Œæˆ</span>
         <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Exception encountered during context initialization - &quot;</span> <span class="token operator">+</span>
                  <span class="token string">&quot;cancelling refresh attempt: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

         <span class="token comment">// Destroy already created singletons to avoid dangling resources.</span>
         <span class="token comment">// é”€æ¯å·²ç»åˆå§‹åŒ–çš„ singleton çš„ Beansï¼Œä»¥å…æœ‰äº› bean ä¼šä¸€ç›´å ç”¨èµ„æº</span>
         <span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// Reset &#39;active&#39; flag.</span>
         <span class="token function">cancelRefresh</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æŠŠå¼‚å¸¸å¾€å¤–æŠ›</span>
         <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         <span class="token comment">// Reset common introspection caches in Spring&#39;s core, since we</span>
         <span class="token comment">// might not ever need metadata for singleton beans anymore...</span>
         <span class="token function">resetCommonCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹ä¸€æ­¥æ­¥æ¥è‚¢è§£è¿™ä¸ª refresh() æ–¹æ³•ã€‚</p><h3 id="åˆ›å»º-bean-å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º-bean-å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ" aria-hidden="true">#</a> åˆ›å»º Bean å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ</h3><p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œç›´æ¥çœ‹ä»£ç ä¸­çš„å‡ ä¸ªæ³¨é‡Šå³å¯ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// è®°å½•å¯åŠ¨æ—¶é—´ï¼Œ</span>
   <span class="token comment">// å°† active å±æ€§è®¾ç½®ä¸º trueï¼Œclosed å±æ€§è®¾ç½®ä¸º falseï¼Œå®ƒä»¬éƒ½æ˜¯ AtomicBoolean ç±»å‹</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>startupDate <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>closed<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Refreshing &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// Initialize any placeholder property sources in the context environment</span>
   <span class="token function">initPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ ¡éªŒ xml é…ç½®æ–‡ä»¶</span>
   <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validateRequiredProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationEvents <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åˆ›å»º-bean-å®¹å™¨-åŠ è½½å¹¶æ³¨å†Œ-bean" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º-bean-å®¹å™¨-åŠ è½½å¹¶æ³¨å†Œ-bean" aria-hidden="true">#</a> åˆ›å»º Bean å®¹å™¨ï¼ŒåŠ è½½å¹¶æ³¨å†Œ Bean</h3><p>æˆ‘ä»¬å›åˆ° refresh() æ–¹æ³•ä¸­çš„ä¸‹ä¸€è¡Œ obtainFreshBeanFactory()ã€‚</p><p>æ³¨æ„ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å…¨æ–‡æœ€é‡è¦çš„éƒ¨åˆ†ä¹‹ä¸€ï¼Œè¿™é‡Œå°†ä¼šåˆå§‹åŒ– BeanFactoryã€åŠ è½½ Beanã€æ³¨å†Œ Bean ç­‰ç­‰ã€‚</p><p>å½“ç„¶ï¼Œè¿™æ­¥ç»“æŸåï¼ŒBean å¹¶æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ã€‚è¿™é‡ŒæŒ‡çš„æ˜¯ Bean å®ä¾‹å¹¶æœªåœ¨è¿™ä¸€æ­¥ç”Ÿæˆã€‚</p><p>// AbstractApplicationContext.java</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">ConfigurableListableBeanFactory</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// å…³é—­æ—§çš„ BeanFactory (å¦‚æœæœ‰)ï¼Œåˆ›å»ºæ–°çš„ BeanFactoryï¼ŒåŠ è½½ Bean å®šä¹‰ã€æ³¨å†Œ Bean ç­‰ç­‰</span>
   <span class="token function">refreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è¿”å›åˆšåˆšåˆ›å»ºçš„ BeanFactory</span>
   <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Bean factory for &quot;</span> <span class="token operator">+</span> <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> beanFactory<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>// AbstractRefreshableApplicationContext.java 120</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">refreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
   <span class="token comment">// å¦‚æœ ApplicationContext ä¸­å·²ç»åŠ è½½è¿‡ BeanFactory äº†ï¼Œé”€æ¯æ‰€æœ‰ Beanï¼Œå…³é—­ BeanFactory</span>
   <span class="token comment">// æ³¨æ„ï¼Œåº”ç”¨ä¸­ BeanFactory æœ¬æ¥å°±æ˜¯å¯ä»¥å¤šä¸ªçš„ï¼Œè¿™é‡Œå¯ä¸æ˜¯è¯´åº”ç”¨å…¨å±€æ˜¯å¦æœ‰ BeanFactoryï¼Œè€Œæ˜¯å½“å‰ ApplicationContext æ˜¯å¦æœ‰ BeanFactory</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">closeBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆå§‹åŒ–ä¸€ä¸ª DefaultListableBeanFactoryï¼Œä¸ºä»€ä¹ˆç”¨è¿™ä¸ªï¼Œæˆ‘ä»¬é©¬ä¸Šè¯´ã€‚</span>
      <span class="token class-name">DefaultListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">createBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ç”¨äº BeanFactory çš„åºåˆ—åŒ–ï¼Œæˆ‘æƒ³éƒ¨åˆ†äººåº”è¯¥éƒ½ç”¨ä¸åˆ°</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">setSerializationId</span><span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// ä¸‹é¢è¿™ä¸¤ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œåˆ«è·Ÿä¸¢äº†ï¼Œå…·ä½“ç»†èŠ‚ä¹‹åè¯´</span>
      <span class="token comment">// è®¾ç½® BeanFactory çš„ä¸¤ä¸ªé…ç½®å±æ€§ï¼šæ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯å¼•ç”¨</span>
      <span class="token function">customizeBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// åŠ è½½ Bean åˆ° BeanFactory ä¸­</span>
      <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactoryMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">=</span> beanFactory<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContextException</span><span class="token punctuation">(</span><span class="token string">&quot;I/O error parsing bean definition source for &quot;</span> <span class="token operator">+</span> <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çœ‹åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæˆ‘è§‰å¾—è¯»è€…å°±åº”è¯¥ç«™åœ¨é«˜å¤„çœ‹ ApplicationContext äº†ï¼ŒApplicationContext ç»§æ‰¿è‡ª BeanFactoryï¼Œä½†æ˜¯å®ƒä¸åº”è¯¥è¢«ç†è§£ä¸º BeanFactory çš„å®ç°ç±»ï¼Œè€Œæ˜¯è¯´<strong>å…¶å†…éƒ¨æŒæœ‰ä¸€ä¸ªå®ä¾‹åŒ–çš„ BeanFactoryï¼ˆDefaultListableBeanFactoryï¼‰</strong>ã€‚ä»¥åæ‰€æœ‰çš„ BeanFactory ç›¸å…³çš„æ“ä½œå…¶å®æ˜¯å§”æ‰˜ç»™è¿™ä¸ªå®ä¾‹æ¥å¤„ç†çš„ã€‚</p><p>æˆ‘ä»¬è¯´è¯´ä¸ºä»€ä¹ˆé€‰æ‹©å®ä¾‹åŒ– DefaultListableBeanFactory ï¼Ÿå‰é¢æˆ‘ä»¬è¯´äº†æœ‰ä¸ªå¾ˆé‡è¦çš„æ¥å£ ConfigurableListableBeanFactoryï¼Œå®ƒå®ç°äº† BeanFactory ä¸‹é¢ä¸€å±‚çš„æ‰€æœ‰ä¸‰ä¸ªæ¥å£ï¼Œæˆ‘æŠŠä¹‹å‰çš„ç»§æ‰¿å›¾å†æ‹¿è¿‡æ¥å¤§å®¶å†ä»”ç»†çœ‹ä¸€ä¸‹ï¼š</p><figure><img src="https://raw.githubusercontent.com/huamus/picture-bed/main/202307202238013.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° ConfigurableListableBeanFactory åªæœ‰ä¸€ä¸ªå®ç°ç±» DefaultListableBeanFactoryï¼Œè€Œä¸”å®ç°ç±» DefaultListableBeanFactory è¿˜é€šè¿‡å®ç°å³è¾¹çš„ AbstractAutowireCapableBeanFactory é€šåƒäº†å³è·¯ã€‚æ‰€ä»¥ç»“è®ºå°±æ˜¯ï¼Œæœ€åº•ä¸‹è¿™ä¸ªå®¶ä¼™ DefaultListableBeanFactory åŸºæœ¬ä¸Šæ˜¯æœ€ç‰›çš„ BeanFactory äº†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿™è¾¹ä¼šä½¿ç”¨è¿™ä¸ªç±»æ¥å®ä¾‹åŒ–çš„åŸå› ã€‚</p><p>å¦‚æœä½ æƒ³è¦åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™åŠ¨æ€å¾€ Spring IOC å®¹å™¨æ³¨å†Œæ–°çš„ beanï¼Œå°±ä¼šä½¿ç”¨åˆ°è¿™ä¸ªç±»ã€‚é‚£æˆ‘ä»¬æ€ä¹ˆåœ¨è¿è¡Œæ—¶è·å¾—è¿™ä¸ªå®ä¾‹å‘¢ï¼Ÿ</p><p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ ApplicationContext æ¥å£èƒ½è·å–åˆ° AutowireCapableBeanFactoryï¼Œå°±æ˜¯æœ€å³ä¸Šè§’é‚£ä¸ªï¼Œç„¶åå®ƒå‘ä¸‹è½¬å‹å°±èƒ½å¾—åˆ° DefaultListableBeanFactory äº†ã€‚</p><p>é‚£æ€ä¹ˆæ‹¿åˆ° ApplicationContext å®ä¾‹å‘¢ï¼Ÿå¦‚æœä½ ä¸ä¼šï¼Œè¯´æ˜ä½ æ²¡ç”¨è¿‡ Springã€‚</p><p>åœ¨ç»§ç»­å¾€ä¸‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ BeanDefinitionã€‚æˆ‘ä»¬è¯´ BeanFactory æ˜¯ Bean å®¹å™¨ï¼Œé‚£ä¹ˆ Bean åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>è¿™é‡Œçš„ BeanDefinition å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ Spring çš„ Beanï¼Œ<strong>æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å„ä¸ª Bean å…¶å®ä¼šè½¬æ¢æˆä¸€ä¸ªä¸ª BeanDefinition å­˜åœ¨äº Spring çš„ BeanFactory ä¸­</strong>ã€‚</p><p>æ‰€ä»¥ï¼Œå¦‚æœæœ‰äººé—®ä½  Bean æ˜¯ä»€ä¹ˆçš„æ—¶å€™ï¼Œä½ è¦çŸ¥é“ <strong>Bean åœ¨ä»£ç å±‚é¢ä¸Šå¯ä»¥ç®€å•è®¤ä¸ºæ˜¯ BeanDefinition çš„å®ä¾‹</strong>ã€‚</p><p><strong>BeanDefinition ä¸­ä¿å­˜äº†æˆ‘ä»¬çš„ Bean ä¿¡æ¯</strong>ï¼Œæ¯”å¦‚è¿™ä¸ª Bean æŒ‡å‘çš„æ˜¯å“ªä¸ªç±»ã€æ˜¯å¦æ˜¯å•ä¾‹çš„ã€æ˜¯å¦æ‡’åŠ è½½ã€è¿™ä¸ª Bean ä¾èµ–äº†å“ªäº› Bean ç­‰ç­‰ã€‚</p><h4 id="beandefinition-æ¥å£å®šä¹‰" tabindex="-1"><a class="header-anchor" href="#beandefinition-æ¥å£å®šä¹‰" aria-hidden="true">#</a> BeanDefinition æ¥å£å®šä¹‰</h4><p>æˆ‘ä»¬æ¥çœ‹ä¸‹ BeanDefinition çš„æ¥å£å®šä¹‰ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BeanDefinition</span> <span class="token keyword">extends</span> <span class="token class-name">AttributeAccessor</span><span class="token punctuation">,</span> <span class="token class-name">BeanMetadataElement</span> <span class="token punctuation">{</span>

   <span class="token comment">// æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤åªæä¾› sington å’Œ prototype ä¸¤ç§ï¼Œ</span>
   <span class="token comment">// å¾ˆå¤šè¯»è€…å¯èƒ½çŸ¥é“è¿˜æœ‰ request, session, globalSession, application, websocket è¿™å‡ ç§ï¼Œ</span>
   <span class="token comment">// ä¸è¿‡ï¼Œå®ƒä»¬å±äºåŸºäº web çš„æ‰©å±•ã€‚</span>
   <span class="token class-name">String</span> <span class="token constant">SCOPE_SINGLETON</span> <span class="token operator">=</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">SCOPE_SINGLETON</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> <span class="token constant">SCOPE_PROTOTYPE</span> <span class="token operator">=</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">SCOPE_PROTOTYPE</span><span class="token punctuation">;</span>

   <span class="token comment">// æ¯”è¾ƒä¸é‡è¦ï¼Œç›´æ¥è·³è¿‡å§</span>
   <span class="token keyword">int</span> <span class="token constant">ROLE_APPLICATION</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> <span class="token constant">ROLE_SUPPORT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> <span class="token constant">ROLE_INFRASTRUCTURE</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

   <span class="token comment">// è®¾ç½®çˆ¶ Beanï¼Œè¿™é‡Œæ¶‰åŠåˆ° bean ç»§æ‰¿ï¼Œä¸æ˜¯ java ç»§æ‰¿ã€‚è¯·å‚è§é™„å½•çš„è¯¦ç»†ä»‹ç»</span>
   <span class="token comment">// ä¸€å¥è¯å°±æ˜¯ï¼šç»§æ‰¿çˆ¶ Bean çš„é…ç½®ä¿¡æ¯è€Œå·²</span>
   <span class="token keyword">void</span> <span class="token function">setParentName</span><span class="token punctuation">(</span><span class="token class-name">String</span> parentName<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è·å–çˆ¶ Bean</span>
   <span class="token class-name">String</span> <span class="token function">getParentName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è®¾ç½® Bean çš„ç±»åç§°ï¼Œå°†æ¥æ˜¯è¦é€šè¿‡åå°„æ¥ç”Ÿæˆå®ä¾‹çš„</span>
   <span class="token keyword">void</span> <span class="token function">setBeanClassName</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è·å– Bean çš„ç±»åç§°</span>
   <span class="token class-name">String</span> <span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


   <span class="token comment">// è®¾ç½® bean çš„ scope</span>
   <span class="token keyword">void</span> <span class="token function">setScope</span><span class="token punctuation">(</span><span class="token class-name">String</span> scope<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">String</span> <span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è®¾ç½®æ˜¯å¦æ‡’åŠ è½½</span>
   <span class="token keyword">void</span> <span class="token function">setLazyInit</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> lazyInit<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">boolean</span> <span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è®¾ç½®è¯¥ Bean ä¾èµ–çš„æ‰€æœ‰çš„ Beanï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„ä¾èµ–ä¸æ˜¯æŒ‡å±æ€§ä¾èµ–(å¦‚ @Autowire æ ‡è®°çš„)ï¼Œ</span>
   <span class="token comment">// æ˜¯ depends-on=&quot;&quot; å±æ€§è®¾ç½®çš„å€¼ã€‚</span>
   <span class="token keyword">void</span> <span class="token function">setDependsOn</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> dependsOn<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è¿”å›è¯¥ Bean çš„æ‰€æœ‰ä¾èµ–</span>
   <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getDependsOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è®¾ç½®è¯¥ Bean æ˜¯å¦å¯ä»¥æ³¨å…¥åˆ°å…¶ä»– Bean ä¸­ï¼Œåªå¯¹æ ¹æ®ç±»å‹æ³¨å…¥æœ‰æ•ˆï¼Œ</span>
   <span class="token comment">// å¦‚æœæ ¹æ®åç§°æ³¨å…¥ï¼Œå³ä½¿è¿™è¾¹è®¾ç½®äº† falseï¼Œä¹Ÿæ˜¯å¯ä»¥çš„</span>
   <span class="token keyword">void</span> <span class="token function">setAutowireCandidate</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> autowireCandidate<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è¯¥ Bean æ˜¯å¦å¯ä»¥æ³¨å…¥åˆ°å…¶ä»– Bean ä¸­</span>
   <span class="token keyword">boolean</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// ä¸»è¦çš„ã€‚åŒä¸€æ¥å£çš„å¤šä¸ªå®ç°ï¼Œå¦‚æœä¸æŒ‡å®šåå­—çš„è¯ï¼ŒSpring ä¼šä¼˜å…ˆé€‰æ‹©è®¾ç½® primary ä¸º true çš„ bean</span>
   <span class="token keyword">void</span> <span class="token function">setPrimary</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> primary<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ˜¯å¦æ˜¯ primary çš„</span>
   <span class="token keyword">boolean</span> <span class="token function">isPrimary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// å¦‚æœè¯¥ Bean é‡‡ç”¨å·¥å‚æ–¹æ³•ç”Ÿæˆï¼ŒæŒ‡å®šå·¥å‚åç§°ã€‚å¯¹å·¥å‚ä¸ç†Ÿæ‚‰çš„è¯»è€…ï¼Œè¯·å‚åŠ é™„å½•</span>
   <span class="token comment">// ä¸€å¥è¯å°±æ˜¯ï¼šæœ‰äº›å®ä¾‹ä¸æ˜¯ç”¨åå°„ç”Ÿæˆçš„ï¼Œè€Œæ˜¯ç”¨å·¥å‚æ¨¡å¼ç”Ÿæˆçš„</span>
   <span class="token keyword">void</span> <span class="token function">setFactoryBeanName</span><span class="token punctuation">(</span><span class="token class-name">String</span> factoryBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// è·å–å·¥å‚åç§°</span>
   <span class="token class-name">String</span> <span class="token function">getFactoryBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// æŒ‡å®šå·¥å‚ç±»ä¸­çš„ å·¥å‚æ–¹æ³•åç§°</span>
   <span class="token keyword">void</span> <span class="token function">setFactoryMethodName</span><span class="token punctuation">(</span><span class="token class-name">String</span> factoryMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// è·å–å·¥å‚ç±»ä¸­çš„ å·¥å‚æ–¹æ³•åç§°</span>
   <span class="token class-name">String</span> <span class="token function">getFactoryMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ„é€ å™¨å‚æ•°</span>
   <span class="token class-name">ConstructorArgumentValues</span> <span class="token function">getConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// Bean ä¸­çš„å±æ€§å€¼ï¼Œåé¢ç»™ bean æ³¨å…¥å±æ€§å€¼çš„æ—¶å€™ä¼šè¯´åˆ°</span>
   <span class="token class-name">MutablePropertyValues</span> <span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ˜¯å¦ singleton</span>
   <span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ˜¯å¦ prototype</span>
   <span class="token keyword">boolean</span> <span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// å¦‚æœè¿™ä¸ª Bean æ˜¯è¢«è®¾ç½®ä¸º abstractï¼Œé‚£ä¹ˆä¸èƒ½å®ä¾‹åŒ–ï¼Œ</span>
   <span class="token comment">// å¸¸ç”¨äºä½œä¸º çˆ¶bean ç”¨äºç»§æ‰¿ï¼Œå…¶å®ä¹Ÿå¾ˆå°‘ç”¨......</span>
   <span class="token keyword">boolean</span> <span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">int</span> <span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> <span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">BeanDefinition</span> <span class="token function">getOriginatingBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ª BeanDefinition å…¶å®å·²ç»åŒ…å«å¾ˆå¤šçš„ä¿¡æ¯äº†ï¼Œæš‚æ—¶ä¸æ¸…æ¥šæ‰€æœ‰çš„æ–¹æ³•å¯¹åº”ä»€ä¹ˆä¸œè¥¿æ²¡å…³ç³»ï¼Œå¸Œæœ›çœ‹å®Œæœ¬æ–‡åè¯»è€…å¯ä»¥å½»åº•ææ¸…æ¥šé‡Œé¢çš„æ‰€æœ‰ä¸œè¥¿ã€‚</p><p><strong>è¿™é‡Œæ¥å£è™½ç„¶é‚£ä¹ˆå¤šï¼Œä½†æ˜¯æ²¡æœ‰ç±»ä¼¼ getInstance() è¿™ç§æ–¹æ³•æ¥è·å–æˆ‘ä»¬å®šä¹‰çš„ç±»çš„å®ä¾‹</strong>ï¼ŒçœŸæ­£çš„æˆ‘ä»¬å®šä¹‰çš„ç±»ç”Ÿæˆçš„å®ä¾‹åˆ°å“ªé‡Œå»äº†å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œè¿™ä¸ªè¦å¾ˆåé¢æ‰èƒ½è®²åˆ°ã€‚</p><p>æœ‰äº† BeanDefinition çš„æ¦‚å¿µä»¥åï¼Œæˆ‘ä»¬å†å¾€ä¸‹çœ‹ refreshBeanFactory() æ–¹æ³•ä¸­çš„å‰©ä½™éƒ¨åˆ†ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token function">customizeBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è™½ç„¶åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä½†è·¯è¿˜å¾ˆé•¿å•Šã€‚ã€‚ã€‚</p><h4 id="customizebeanfactory" tabindex="-1"><a class="header-anchor" href="#customizebeanfactory" aria-hidden="true">#</a> customizeBeanFactory</h4><p>customizeBeanFactory(beanFactory) æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯é…ç½®æ˜¯å¦å…è®¸ BeanDefinition è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯å¼•ç”¨ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">customizeBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">DefaultListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowBeanDefinitionOverriding <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ˜¯å¦å…è®¸ Bean å®šä¹‰è¦†ç›–</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">setAllowBeanDefinitionOverriding</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowBeanDefinitionOverriding<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ˜¯å¦å…è®¸ Bean é—´çš„å¾ªç¯ä¾èµ–</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">setAllowCircularReferences</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>BeanDefinition çš„è¦†ç›–é—®é¢˜å¯èƒ½ä¼šæœ‰å¼€å‘è€…ç¢°åˆ°è¿™ä¸ªå‘ï¼Œå°±æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ bean æ—¶ä½¿ç”¨äº†ç›¸åŒçš„ id æˆ– nameï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒallowBeanDefinitionOverriding å±æ€§ä¸º nullï¼Œå¦‚æœåœ¨åŒä¸€é…ç½®æ–‡ä»¶ä¸­é‡å¤äº†ï¼Œä¼šæŠ›é”™ï¼Œä½†æ˜¯å¦‚æœä¸æ˜¯åŒä¸€é…ç½®æ–‡ä»¶ä¸­ï¼Œä¼šå‘ç”Ÿè¦†ç›–ã€‚</p><p>å¾ªç¯å¼•ç”¨ä¹Ÿå¾ˆå¥½ç†è§£ï¼šA ä¾èµ– Bï¼Œè€Œ B ä¾èµ– Aã€‚æˆ– A ä¾èµ– Bï¼ŒB ä¾èµ– Cï¼Œè€Œ C ä¾èµ– Aã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring å…è®¸å¾ªç¯ä¾èµ–ï¼Œå½“ç„¶å¦‚æœä½ åœ¨ A çš„æ„é€ æ–¹æ³•ä¸­ä¾èµ– Bï¼Œåœ¨ B çš„æ„é€ æ–¹æ³•ä¸­ä¾èµ– A æ˜¯ä¸è¡Œçš„ã€‚</p><p>è‡³äºè¿™ä¸¤ä¸ªå±æ€§æ€ä¹ˆé…ç½®ï¼Ÿæˆ‘åœ¨é™„å½•ä¸­è¿›è¡Œäº†ä»‹ç»ï¼Œå°¤å…¶å¯¹äºè¦†ç›–é—®é¢˜ï¼Œå¾ˆå¤šäººéƒ½å¸Œæœ›ç¦æ­¢å‡ºç° Bean è¦†ç›–ï¼Œå¯æ˜¯ Spring é»˜è®¤æ˜¯ä¸åŒæ–‡ä»¶çš„æ—¶å€™å¯ä»¥è¦†ç›–çš„ã€‚</p><p>ä¹‹åçš„æºç ä¸­è¿˜ä¼šå‡ºç°è¿™ä¸¤ä¸ªå±æ€§ï¼Œè¯»è€…æœ‰ä¸ªå°è±¡å°±å¯ä»¥äº†ï¼Œå®ƒä»¬ä¸æ˜¯éå¸¸é‡è¦ã€‚</p><h4 id="åŠ è½½-bean-loadbeandefinitions" tabindex="-1"><a class="header-anchor" href="#åŠ è½½-bean-loadbeandefinitions" aria-hidden="true">#</a> åŠ è½½ Bean: loadBeanDefinitions</h4><p>æ¥ä¸‹æ¥æ˜¯æœ€é‡è¦çš„ <strong>loadBeanDefinitions(beanFactory) æ–¹æ³•äº†ï¼Œè¿™ä¸ªæ–¹æ³•å°†æ ¹æ®é…ç½®ï¼ŒåŠ è½½å„ä¸ª Beanï¼Œç„¶åæ”¾åˆ° BeanFactory ä¸­ã€‚</strong></p><p><strong>è¯»å–é…ç½®çš„æ“ä½œåœ¨ XmlBeanDefinitionReader ä¸­ï¼Œå…¶è´Ÿè´£åŠ è½½é…ç½®ã€è§£æã€‚</strong></p><p>// AbstractXmlApplicationContext.java 80</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/** æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ–¹æ³•å°†é€šè¿‡ä¸€ä¸ª XmlBeanDefinitionReader å®ä¾‹æ¥åŠ è½½å„ä¸ª Beanã€‚*/</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">DefaultListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
   <span class="token comment">// ç»™è¿™ä¸ª BeanFactory å®ä¾‹åŒ–ä¸€ä¸ª XmlBeanDefinitionReader</span>
   <span class="token class-name">XmlBeanDefinitionReader</span> beanDefinitionReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XmlBeanDefinitionReader</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// Configure the bean definition reader with this context&#39;s</span>
   <span class="token comment">// resource loading environment.</span>
   beanDefinitionReader<span class="token punctuation">.</span><span class="token function">setEnvironment</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanDefinitionReader<span class="token punctuation">.</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanDefinitionReader<span class="token punctuation">.</span><span class="token function">setEntityResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceEntityResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// åˆå§‹åŒ– BeanDefinitionReaderï¼Œå…¶å®è¿™ä¸ªæ˜¯æä¾›ç»™å­ç±»è¦†å†™çš„ï¼Œ</span>
   <span class="token comment">// æˆ‘çœ‹äº†ä¸€ä¸‹ï¼Œæ²¡æœ‰ç±»è¦†å†™è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å§‘ä¸”å½“åšä¸é‡è¦å§</span>
   <span class="token function">initBeanDefinitionReader</span><span class="token punctuation">(</span>beanDefinitionReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// é‡ç‚¹æ¥äº†ï¼Œç»§ç»­å¾€ä¸‹</span>
   <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>beanDefinitionReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨è¿˜åœ¨è¿™ä¸ªç±»ä¸­ï¼Œæ¥ä¸‹æ¥ç”¨åˆšåˆšåˆå§‹åŒ–çš„ Reader å¼€å§‹æ¥åŠ è½½ xml é…ç½®ï¼Œè¿™å—ä»£ç è¯»è€…å¯ä»¥é€‰æ‹©æ€§è·³è¿‡ï¼Œä¸æ˜¯å¾ˆé‡è¦ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹é¢è¿™ä¸ªä»£ç å—ï¼Œè¯»è€…å¯ä»¥å¾ˆè½»æ¾åœ°ç•¥è¿‡ã€‚</p><p>// AbstractXmlApplicationContext.java 120</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">XmlBeanDefinitionReader</span> reader<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
   <span class="token class-name">Resource</span><span class="token punctuation">[</span><span class="token punctuation">]</span> configResources <span class="token operator">=</span> <span class="token function">getConfigResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>configResources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¾€ä¸‹çœ‹</span>
      reader<span class="token punctuation">.</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>configResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> configLocations <span class="token operator">=</span> <span class="token function">getConfigLocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>configLocations <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2</span>
      reader<span class="token punctuation">.</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>configLocations<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ä¸Šé¢è™½ç„¶æœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸è¿‡ç¬¬äºŒä¸ªåˆ†æ”¯å¾ˆå¿«é€šè¿‡è§£æè·¯å¾„è½¬æ¢ä¸º Resource ä»¥åä¹Ÿä¼šè¿›åˆ°è¿™é‡Œ</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Resource</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>resources<span class="token punctuation">,</span> <span class="token string">&quot;Resource array must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token comment">// æ³¨æ„è¿™é‡Œæ˜¯ä¸ª for å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ª resource</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Resource</span> resource <span class="token operator">:</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ç»§ç»­å¾€ä¸‹çœ‹</span>
      counter <span class="token operator">+=</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// æœ€åè¿”å› counterï¼Œè¡¨ç¤ºæ€»å…±åŠ è½½äº†å¤šå°‘çš„ BeanDefinition</span>
   <span class="token keyword">return</span> counter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// XmlBeanDefinitionReader 303</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EncodedResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// XmlBeanDefinitionReader 314</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">EncodedResource</span> encodedResource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>encodedResource<span class="token punctuation">,</span> <span class="token string">&quot;EncodedResource must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Loading XML bean definitions from &quot;</span> <span class="token operator">+</span> encodedResource<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// ç”¨ä¸€ä¸ª ThreadLocal æ¥å­˜æ”¾é…ç½®æ–‡ä»¶èµ„æº</span>
   <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EncodedResource</span><span class="token punctuation">&gt;</span></span> currentResources <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcesCurrentlyBeingLoaded<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>currentResources <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentResources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EncodedResource</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>resourcesCurrentlyBeingLoaded<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currentResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentResources<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>encodedResource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>
            <span class="token string">&quot;Detected cyclic loading of &quot;</span> <span class="token operator">+</span> encodedResource <span class="token operator">+</span> <span class="token string">&quot; - check your import definitions!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> encodedResource<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token class-name">InputSource</span> inputSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputSource</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>encodedResource<span class="token punctuation">.</span><span class="token function">getEncoding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            inputSource<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span>encodedResource<span class="token punctuation">.</span><span class="token function">getEncoding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// æ ¸å¿ƒéƒ¨åˆ†æ˜¯è¿™é‡Œï¼Œå¾€ä¸‹é¢çœ‹</span>
         <span class="token keyword">return</span> <span class="token function">doLoadBeanDefinitions</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span> encodedResource<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>
            <span class="token string">&quot;IOException parsing XML document from &quot;</span> <span class="token operator">+</span> encodedResource<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      currentResources<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>encodedResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentResources<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>resourcesCurrentlyBeingLoaded<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// è¿˜åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œç¬¬ 388 è¡Œ</span>
<span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">doLoadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">InputSource</span> inputSource<span class="token punctuation">,</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿™é‡Œå°±ä¸çœ‹äº†ï¼Œå°† xml æ–‡ä»¶è½¬æ¢ä¸º Document å¯¹è±¡</span>
      <span class="token class-name">Document</span> doc <span class="token operator">=</span> <span class="token function">doLoadDocument</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span> resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ç»§ç»­</span>
      <span class="token keyword">return</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token comment">// è¿˜åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œç¬¬ 505 è¡Œ</span>
<span class="token comment">// è¿”å›å€¼ï¼šè¿”å›ä»å½“å‰é…ç½®æ–‡ä»¶åŠ è½½äº†å¤šå°‘æ•°é‡çš„ Bean</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Document</span> doc<span class="token punctuation">,</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>
   <span class="token class-name">BeanDefinitionDocumentReader</span> documentReader <span class="token operator">=</span> <span class="token function">createBeanDefinitionDocumentReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> countBefore <span class="token operator">=</span> <span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// è¿™é‡Œ</span>
   documentReader<span class="token punctuation">.</span><span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> <span class="token function">createReaderContext</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> countBefore<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// DefaultBeanDefinitionDocumentReader 90</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Document</span> doc<span class="token punctuation">,</span> <span class="token class-name">XmlReaderContext</span> readerContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>readerContext <span class="token operator">=</span> readerContext<span class="token punctuation">;</span>
   logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Loading bean definitions&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">Element</span> root <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">getDocumentElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// ä» xml æ ¹èŠ‚ç‚¹å¼€å§‹è§£ææ–‡ä»¶</span>
   <span class="token function">doRegisterBeanDefinitions</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç»è¿‡æ¼«é•¿çš„é“¾è·¯ï¼Œä¸€ä¸ªé…ç½®æ–‡ä»¶ç»ˆäºè½¬æ¢ä¸ºä¸€é¢— DOM æ ‘äº†ï¼Œæ³¨æ„ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯å…¶ä¸­ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¸æ˜¯æ‰€æœ‰çš„ï¼Œè¯»è€…å¯ä»¥çœ‹åˆ°ä¸Šé¢æœ‰ä¸ª for å¾ªç¯çš„ã€‚ä¸‹é¢å¼€å§‹ä»æ ¹èŠ‚ç‚¹å¼€å§‹è§£æï¼š</p><h5 id="doregisterbeandefinitions" tabindex="-1"><a class="header-anchor" href="#doregisterbeandefinitions" aria-hidden="true">#</a> doRegisterBeanDefinitionsï¼š</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// DefaultBeanDefinitionDocumentReader 116</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRegisterBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Element</span> root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// æˆ‘ä»¬çœ‹åå­—å°±çŸ¥é“ï¼ŒBeanDefinitionParserDelegate å¿…å®šæ˜¯ä¸€ä¸ªé‡è¦çš„ç±»ï¼Œå®ƒè´Ÿè´£è§£æ Bean å®šä¹‰ï¼Œ</span>
   <span class="token comment">// è¿™é‡Œä¸ºä»€ä¹ˆè¦å®šä¹‰ä¸€ä¸ª parent? çœ‹åˆ°åé¢å°±çŸ¥é“äº†ï¼Œæ˜¯é€’å½’é—®é¢˜ï¼Œ</span>
   <span class="token comment">// å› ä¸º &lt;beans /&gt; å†…éƒ¨æ˜¯å¯ä»¥å®šä¹‰ &lt;beans /&gt; çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•çš„ root å…¶å®ä¸ä¸€å®šå°±æ˜¯ xml çš„æ ¹èŠ‚ç‚¹ï¼Œä¹Ÿå¯ä»¥æ˜¯åµŒå¥—åœ¨é‡Œé¢çš„ &lt;beans /&gt; èŠ‚ç‚¹ï¼Œä»æºç åˆ†æçš„è§’åº¦ï¼Œæˆ‘ä»¬å½“åšæ ¹èŠ‚ç‚¹å°±å¥½äº†</span>
   <span class="token class-name">BeanDefinitionParserDelegate</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token function">createDelegate</span><span class="token punctuation">(</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿™å—è¯´çš„æ˜¯æ ¹èŠ‚ç‚¹ &lt;beans ... profile=&quot;dev&quot; /&gt; ä¸­çš„ profile æ˜¯å¦æ˜¯å½“å‰ç¯å¢ƒéœ€è¦çš„ï¼Œ</span>
      <span class="token comment">// å¦‚æœå½“å‰ç¯å¢ƒé…ç½®çš„ profile ä¸åŒ…å«æ­¤ profileï¼Œé‚£å°±ç›´æ¥ return äº†ï¼Œä¸å¯¹æ­¤ &lt;beans /&gt; è§£æ</span>
      <span class="token comment">// ä¸ç†Ÿæ‚‰ profile ä¸ºä½•ç‰©ï¼Œä¸ç†Ÿæ‚‰æ€ä¹ˆé…ç½® profile è¯»è€…çš„è¯·ç§»æ­¥é™„å½•åŒº</span>
      <span class="token class-name">String</span> profileSpec <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">PROFILE_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>profileSpec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specifiedProfiles <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span>
               profileSpec<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span><span class="token punctuation">.</span><span class="token constant">MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acceptsProfiles</span><span class="token punctuation">(</span>specifiedProfiles<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Skipped XML bean definition file due to specified profiles [&quot;</span> <span class="token operator">+</span> profileSpec <span class="token operator">+</span>
                     <span class="token string">&quot;] not matching: &quot;</span> <span class="token operator">+</span> <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token function">preProcessXml</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é’©å­</span>
   <span class="token comment">// å¾€ä¸‹çœ‹</span>
   <span class="token function">parseBeanDefinitions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">postProcessXml</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é’©å­</span>

   <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> parent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>preProcessXml(root) å’Œ postProcessXml(root) æ˜¯ç»™å­ç±»ç”¨çš„é’©å­æ–¹æ³•ï¼Œé‰´äºæ²¡æœ‰è¢«ä½¿ç”¨åˆ°ï¼Œä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œæˆ‘ä»¬ç›´æ¥è·³è¿‡ã€‚</p><p>è¿™é‡Œæ¶‰åŠåˆ°äº† profile çš„é—®é¢˜ï¼Œå¯¹äºä¸äº†è§£çš„è¯»è€…ï¼Œæˆ‘åœ¨é™„å½•ä¸­å¯¹ profile åšäº†ç®€å•çš„è§£é‡Šï¼Œè¯»è€…å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œçœ‹æ ¸å¿ƒè§£ææ–¹æ³• parseBeanDefinitions(root, this.delegate) :</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// default namespace æ¶‰åŠåˆ°çš„å°±å››ä¸ªæ ‡ç­¾ &lt;import /&gt;ã€&lt;alias /&gt;ã€&lt;bean /&gt; å’Œ &lt;beans /&gt;ï¼Œ</span>
<span class="token comment">// å…¶ä»–çš„å±äº custom çš„</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">parseBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Element</span> root<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">NodeList</span> nl <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">getChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nl<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">Node</span> node <span class="token operator">=</span> nl<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Element</span> ele <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token punctuation">)</span> node<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// è§£æ default namespace ä¸‹é¢çš„å‡ ä¸ªå…ƒç´ </span>
               <span class="token function">parseDefaultElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> delegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token comment">// è§£æå…¶ä»– namespace çš„å…ƒç´ </span>
               delegate<span class="token punctuation">.</span><span class="token function">parseCustomElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token punctuation">{</span>
      delegate<span class="token punctuation">.</span><span class="token function">parseCustomElement</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºæ¯ä¸ªé…ç½®æ¥è¯´ï¼Œåˆ†åˆ«è¿›å…¥åˆ° parseDefaultElement(ele, delegate); å’Œ delegate.parseCustomElement(ele); è¿™ä¸¤ä¸ªåˆ†æ”¯äº†ã€‚</p><p>parseDefaultElement(ele, delegate) ä»£è¡¨è§£æçš„èŠ‚ç‚¹æ˜¯ <!---->ã€<!---->ã€<!---->ã€<!----> è¿™å‡ ä¸ªã€‚</p><p>è¿™é‡Œçš„å››ä¸ªæ ‡ç­¾ä¹‹æ‰€ä»¥æ˜¯ default çš„ï¼Œæ˜¯å› ä¸ºå®ƒä»¬æ˜¯å¤„äºè¿™ä¸ª namespace ä¸‹å®šä¹‰çš„ï¼š</p><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>http://www.springframework.org/schema/beans
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åˆåˆ°åˆå­¦è€…ç§‘æ™®æ—¶é—´ï¼Œä¸ç†Ÿæ‚‰ namespace çš„è¯»è€…è¯·çœ‹ä¸‹é¢è´´å‡ºæ¥çš„ xmlï¼Œè¿™é‡Œçš„ç¬¬äºŒè¡Œ xmlns å°±æ˜¯å’¯ã€‚</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>
            http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name">default-autowire</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>byName<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è€Œå¯¹äºå…¶ä»–çš„æ ‡ç­¾ï¼Œå°†è¿›å…¥åˆ° delegate.parseCustomElement(element) è¿™ä¸ªåˆ†æ”¯ã€‚å¦‚æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨åˆ°çš„ <!---->ã€<!---->ã€<!---->ã€<!---->ç­‰ã€‚</p><p>è¿™äº›å±äºæ‰©å±•ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ä¸Šé¢è¿™äº› â€é defaultâ€œ æ ‡ç­¾ï¼Œé‚£ä¹ˆä¸Šé¢çš„ xml å¤´éƒ¨çš„åœ°æ–¹ä¹Ÿè¦å¼•å…¥ç›¸åº”çš„ namespace å’Œ .xsd æ–‡ä»¶çš„è·¯å¾„ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚åŒæ—¶ä»£ç ä¸­éœ€è¦æä¾›ç›¸åº”çš„ parser æ¥è§£æï¼Œå¦‚ MvcNamespaceHandlerã€TaskNamespaceHandlerã€ContextNamespaceHandlerã€AopNamespaceHandler ç­‰ã€‚</p><p>å‡å¦‚è¯»è€…æƒ³åˆ†æ &lt;context:property-placeholder location=&quot;classpath:xx.properties&quot; /&gt; çš„å®ç°åŸç†ï¼Œå°±åº”è¯¥åˆ° ContextNamespaceHandler ä¸­æ‰¾ç­”æ¡ˆã€‚</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/context<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name"><span class="token namespace">xmlns:</span>mvc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/mvc<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>
           http://www.springframework.org/schema/beans 
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd
           http://www.springframework.org/schema/mvc   
           http://www.springframework.org/schema/mvc/spring-mvc.xsd  
       <span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">default-autowire</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>byName<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŒç†ï¼Œä»¥åä½ è¦æ˜¯ç¢°åˆ° <!----> è¿™ç§æ ‡ç­¾ï¼Œé‚£ä¹ˆå°±åº”è¯¥æœä¸€æœæ˜¯ä¸æ˜¯æœ‰ DubboNamespaceHandler è¿™ä¸ªå¤„ç†ç±»ã€‚</p><p>å›è¿‡ç¥æ¥ï¼Œçœ‹çœ‹å¤„ç† default æ ‡ç­¾çš„æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseDefaultElement</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">nodeNameEquals</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> <span class="token constant">IMPORT_ELEMENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¤„ç† &lt;import /&gt; æ ‡ç­¾</span>
      <span class="token function">importBeanDefinitionResource</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">nodeNameEquals</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> <span class="token constant">ALIAS_ELEMENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¤„ç† &lt;alias /&gt; æ ‡ç­¾å®šä¹‰</span>
      <span class="token comment">// &lt;alias name=&quot;fromName&quot; alias=&quot;toName&quot;/&gt;</span>
      <span class="token function">processAliasRegistration</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">nodeNameEquals</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> <span class="token constant">BEAN_ELEMENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¤„ç† &lt;bean /&gt; æ ‡ç­¾å®šä¹‰ï¼Œè¿™ä¹Ÿç®—æ˜¯æˆ‘ä»¬çš„é‡ç‚¹å§</span>
      <span class="token function">processBeanDefinition</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> delegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">nodeNameEquals</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> <span class="token constant">NESTED_BEANS_ELEMENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœç¢°åˆ°çš„æ˜¯åµŒå¥—çš„ &lt;beans /&gt; æ ‡ç­¾ï¼Œéœ€è¦é€’å½’</span>
      <span class="token function">doRegisterBeanDefinitions</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ¯ä¸ªæ ‡ç­¾éƒ½è¯´ï¼Œé‚£æˆ‘ä¸åè¡€ï¼Œä½ ä»¬éƒ½è¦åè¡€äº†ã€‚æˆ‘ä»¬æŒ‘æˆ‘ä»¬çš„é‡ç‚¹ <!----> æ ‡ç­¾å‡ºæ¥è¯´ã€‚</p><h5 id="processbeandefinition-è§£æ-bean-æ ‡ç­¾" tabindex="-1"><a class="header-anchor" href="#processbeandefinition-è§£æ-bean-æ ‡ç­¾" aria-hidden="true">#</a> processBeanDefinition è§£æ bean æ ‡ç­¾</h5><p>ä¸‹é¢æ˜¯ processBeanDefinition è§£æ <!----> æ ‡ç­¾ï¼š</p><p>// DefaultBeanDefinitionDocumentReader 298</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// å°† &lt;bean /&gt; èŠ‚ç‚¹ä¸­çš„ä¿¡æ¯æå–å‡ºæ¥ï¼Œç„¶åå°è£…åˆ°ä¸€ä¸ª BeanDefinitionHolder ä¸­ï¼Œç»†èŠ‚å¾€ä¸‹çœ‹</span>
   <span class="token class-name">BeanDefinitionHolder</span> bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// ä¸‹é¢çš„å‡ è¡Œå…ˆä¸è¦çœ‹ï¼Œè·³è¿‡å…ˆï¼Œè·³è¿‡å…ˆï¼Œè·³è¿‡å…ˆï¼Œåé¢ä¼šç»§ç»­è¯´çš„</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>bdHolder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">decorateBeanDefinitionIfRequired</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bdHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// Register the final decorated instance.</span>
         <span class="token class-name">BeanDefinitionReaderUtils</span><span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionStoreException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to register bean definition with name &#39;&quot;</span> <span class="token operator">+</span>
               bdHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Send registration event.</span>
      <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireComponentRegistered</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanComponentDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç»§ç»­å¾€ä¸‹çœ‹æ€ä¹ˆè§£æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹ <!----> æ ‡ç­¾ä¸­å¯ä»¥å®šä¹‰å“ªäº›å±æ€§ï¼š</p><table><thead><tr><th>Property</th><th></th></tr></thead><tbody><tr><td>class</td><td>ç±»çš„å…¨é™å®šå</td></tr><tr><td>name</td><td>å¯æŒ‡å®š idã€name(ç”¨é€—å·ã€åˆ†å·ã€ç©ºæ ¼åˆ†éš”)</td></tr><tr><td>scope</td><td>ä½œç”¨åŸŸ</td></tr><tr><td>constructor arguments</td><td>æŒ‡å®šæ„é€ å‚æ•°</td></tr><tr><td>properties</td><td>è®¾ç½®å±æ€§çš„å€¼</td></tr><tr><td>autowiring mode</td><td>no(é»˜è®¤å€¼)ã€byNameã€byTypeã€ constructor</td></tr><tr><td>lazy-initialization mode</td><td>æ˜¯å¦æ‡’åŠ è½½(å¦‚æœè¢«éæ‡’åŠ è½½çš„beanä¾èµ–äº†é‚£ä¹ˆå…¶å®ä¹Ÿå°±ä¸èƒ½æ‡’åŠ è½½äº†)</td></tr><tr><td>initialization method</td><td>bean å±æ€§è®¾ç½®å®Œæˆåï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•</td></tr><tr><td>destruction method</td><td>bean é”€æ¯åçš„å›è°ƒæ–¹æ³•</td></tr></tbody></table><p>ä¸Šé¢è¡¨æ ¼ä¸­çš„å†…å®¹æˆ‘æƒ³å¤§å®¶éƒ½éå¸¸ç†Ÿæ‚‰å§ï¼Œå¦‚æœä¸ç†Ÿæ‚‰ï¼Œé‚£å°±æ˜¯ä½ ä¸å¤Ÿäº†è§£ Spring çš„é…ç½®äº†ã€‚</p><p>ç®€å•åœ°è¯´å°±æ˜¯åƒä¸‹é¢è¿™æ ·å­ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>exampleBean<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name1, name2, name3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.javadoop.ExampleBean<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>singleton<span class="token punctuation">&quot;</span></span> <span class="token attr-name">lazy-init</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>init<span class="token punctuation">&quot;</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cleanup<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- å¯ä»¥ç”¨ä¸‹é¢ä¸‰ç§å½¢å¼æŒ‡å®šæ„é€ å‚æ•° --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>int<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>7500000<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>years<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>7500000<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>7500000<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!-- property çš„å‡ ç§æƒ…å†µ --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beanOne<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ref</span> <span class="token attr-name">bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>anotherExampleBean<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beanTwo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yetAnotherBean<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>integerProperty<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ç„¶ï¼Œé™¤äº†ä¸Šé¢ä¸¾ä¾‹å‡ºæ¥çš„è¿™äº›ï¼Œè¿˜æœ‰ factory-beanã€factory-methodã€<!---->ã€<!---->ã€<meta>ã€<!----> è¿™å‡ ä¸ªï¼Œå¤§å®¶æ˜¯ä¸æ˜¯ç†Ÿæ‚‰å‘¢ï¼Ÿè‡ªå·±æ£€éªŒä¸€ä¸‹è‡ªå·±å¯¹ Spring ä¸­ bean çš„äº†è§£ç¨‹åº¦ã€‚</p><p>æœ‰äº†ä»¥ä¸Šè¿™äº›çŸ¥è¯†ä»¥åï¼Œæˆ‘ä»¬å†ç»§ç»­å¾€é‡Œçœ‹æ€ä¹ˆè§£æ bean å…ƒç´ ï¼Œæ˜¯æ€ä¹ˆè½¬æ¢åˆ° BeanDefinitionHolder çš„ã€‚</p><p>// BeanDefinitionParserDelegate 428</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">BeanDefinitionHolder</span> <span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">BeanDefinitionHolder</span> <span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> containingBean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">String</span> id <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">ID_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> nameAttr <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">NAME_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> aliases <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// å°† name å±æ€§çš„å®šä¹‰æŒ‰ç…§ â€œé€—å·ã€åˆ†å·ã€ç©ºæ ¼â€ åˆ‡åˆ†ï¼Œå½¢æˆä¸€ä¸ª åˆ«ååˆ—è¡¨æ•°ç»„ï¼Œ</span>
   <span class="token comment">// å½“ç„¶ï¼Œå¦‚æœä½ ä¸å®šä¹‰ name å±æ€§çš„è¯ï¼Œå°±æ˜¯ç©ºçš„äº†</span>
   <span class="token comment">// æˆ‘åœ¨é™„å½•ä¸­ç®€å•ä»‹ç»äº†ä¸€ä¸‹ id å’Œ name çš„é…ç½®ï¼Œå¤§å®¶å¯ä»¥çœ‹ä¸€çœ¼ï¼Œæœ‰ä¸ª20ç§’å°±å¯ä»¥äº†</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>nameAttr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nameArr <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span>nameAttr<span class="token punctuation">,</span> <span class="token constant">MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      aliases<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>nameArr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token class-name">String</span> beanName <span class="token operator">=</span> id<span class="token punctuation">;</span>
   <span class="token comment">// å¦‚æœæ²¡æœ‰æŒ‡å®šid, é‚£ä¹ˆç”¨åˆ«ååˆ—è¡¨çš„ç¬¬ä¸€ä¸ªåå­—ä½œä¸ºbeanName</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>aliases<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      beanName <span class="token operator">=</span> aliases<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;No XML &#39;id&#39; specified - using &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
               <span class="token string">&quot;&#39; as bean name and &quot;</span> <span class="token operator">+</span> aliases <span class="token operator">+</span> <span class="token string">&quot; as aliases&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>containingBean <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkNameUniqueness</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> aliases<span class="token punctuation">,</span> ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// æ ¹æ® &lt;bean ...&gt;...&lt;/bean&gt; ä¸­çš„é…ç½®åˆ›å»º BeanDefinitionï¼Œç„¶åæŠŠé…ç½®ä¸­çš„ä¿¡æ¯éƒ½è®¾ç½®åˆ°å®ä¾‹ä¸­,</span>
   <span class="token comment">// ç»†èŠ‚åé¢ç»†è¯´ï¼Œå…ˆçŸ¥é“ä¸‹é¢è¿™è¡Œç»“æŸåï¼Œä¸€ä¸ª BeanDefinition å®ä¾‹å°±å‡ºæ¥äº†ã€‚</span>
   <span class="token class-name">AbstractBeanDefinition</span> beanDefinition <span class="token operator">=</span> <span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> containingBean<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// åˆ°è¿™é‡Œï¼Œæ•´ä¸ª &lt;bean /&gt; æ ‡ç­¾å°±ç®—è§£æç»“æŸäº†ï¼Œä¸€ä¸ª BeanDefinition å°±å½¢æˆäº†ã€‚</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinition <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœéƒ½æ²¡æœ‰è®¾ç½® id å’Œ nameï¼Œé‚£ä¹ˆæ­¤æ—¶çš„ beanName å°±ä¼šä¸º nullï¼Œè¿›å…¥ä¸‹é¢è¿™å—ä»£ç äº§ç”Ÿ</span>
      <span class="token comment">// å¦‚æœè¯»è€…ä¸æ„Ÿå…´è¶£çš„è¯ï¼Œæˆ‘è§‰å¾—ä¸éœ€è¦å…³å¿ƒè¿™å—ä»£ç ï¼Œå¯¹æœ¬æ–‡æºç åˆ†ææ¥è¯´ï¼Œè¿™äº›ä¸œè¥¿ä¸é‡è¦</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>containingBean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// æŒ‰ç…§æˆ‘ä»¬çš„æ€è·¯ï¼Œè¿™é‡Œ containingBean æ˜¯ null çš„</span>
               beanName <span class="token operator">=</span> <span class="token class-name">BeanDefinitionReaderUtils</span><span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>
                     beanDefinition<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token comment">// å¦‚æœæˆ‘ä»¬ä¸å®šä¹‰ id å’Œ nameï¼Œé‚£ä¹ˆæˆ‘ä»¬å¼•è¨€é‡Œçš„é‚£ä¸ªä¾‹å­ï¼š</span>
               <span class="token comment">//   1. beanName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl#0</span>
               <span class="token comment">//   2. beanClassName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl</span>

               beanName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>

               <span class="token class-name">String</span> beanClassName <span class="token operator">=</span> beanDefinition<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>beanClassName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                     beanName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>beanClassName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> beanName<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> beanClassName<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                     <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBeanNameInUse</span><span class="token punctuation">(</span>beanClassName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment">// æŠŠ beanClassName è®¾ç½®ä¸º Bean çš„åˆ«å</span>
                  aliases<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Neither XML &#39;id&#39; nor &#39;name&#39; specified - &quot;</span> <span class="token operator">+</span>
                     <span class="token string">&quot;using generated bean name [&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aliasesArray <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toStringArray</span><span class="token punctuation">(</span>aliases<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è¿”å› BeanDefinitionHolder</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> aliasesArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼Œæˆ‘ä»¬å†çœ‹çœ‹æ€ä¹ˆæ ¹æ®é…ç½®åˆ›å»º BeanDefinition å®ä¾‹çš„ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AbstractBeanDefinition</span> <span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>
      <span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> containingBean<span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token keyword">this</span><span class="token punctuation">.</span>parseState<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanEntry</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">CLASS_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      className <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">CLASS_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> parent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">PARENT_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         parent <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">PARENT_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// åˆ›å»º BeanDefinitionï¼Œç„¶åè®¾ç½®ç±»ä¿¡æ¯è€Œå·²ï¼Œå¾ˆç®€å•ï¼Œå°±ä¸è´´ä»£ç äº†</span>
      <span class="token class-name">AbstractBeanDefinition</span> bd <span class="token operator">=</span> <span class="token function">createBeanDefinition</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// è®¾ç½® BeanDefinition çš„ä¸€å †å±æ€§ï¼Œè¿™äº›å±æ€§å®šä¹‰åœ¨ AbstractBeanDefinition ä¸­</span>
      <span class="token function">parseBeanDefinitionAttributes</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> containingBean<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      bd<span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token class-name">DomUtils</span><span class="token punctuation">.</span><span class="token function">getChildElementValueByTagName</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> <span class="token constant">DESCRIPTION_ELEMENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token doc-comment comment">/**
       * ä¸‹é¢çš„ä¸€å †æ˜¯è§£æ <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span><span class="token punctuation">&gt;</span></span>......<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span> å†…éƒ¨çš„å­å…ƒç´ ï¼Œ
       * è§£æå‡ºæ¥ä»¥åçš„ä¿¡æ¯éƒ½æ”¾åˆ° bd çš„å±æ€§ä¸­
       */</span>

      <span class="token comment">// è§£æ &lt;meta /&gt;</span>
      <span class="token function">parseMetaElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è§£æ &lt;lookup-method /&gt;</span>
      <span class="token function">parseLookupOverrideSubElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">.</span><span class="token function">getMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è§£æ &lt;replaced-method /&gt;</span>
      <span class="token function">parseReplacedMethodSubElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">.</span><span class="token function">getMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è§£æ &lt;constructor-arg /&gt;</span>
      <span class="token function">parseConstructorArgElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è§£æ &lt;property /&gt;</span>
      <span class="token function">parsePropertyElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è§£æ &lt;qualifier /&gt;</span>
      <span class="token function">parseQualifierElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span>

      bd<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bd<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token function">extractSource</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> bd<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Bean class [&quot;</span> <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">&quot;] not found&quot;</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoClassDefFoundError</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Class that bean class [&quot;</span> <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">&quot;] depends on not found&quot;</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected failure during bean definition parsing&quot;</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>parseState<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ ¹æ® <!----> é…ç½®åˆ›å»ºäº†ä¸€ä¸ª BeanDefinitionHolder å®ä¾‹ã€‚æ³¨æ„ï¼Œæ˜¯ä¸€ä¸ªã€‚</p><p>æˆ‘ä»¬å›åˆ°è§£æ <!----> çš„å…¥å£æ–¹æ³•:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// å°† &lt;bean /&gt; èŠ‚ç‚¹è½¬æ¢ä¸º BeanDefinitionHolderï¼Œå°±æ˜¯ä¸Šé¢è¯´çš„ä¸€å †</span>
   <span class="token class-name">BeanDefinitionHolder</span> bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>bdHolder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœæœ‰è‡ªå®šä¹‰å±æ€§çš„è¯ï¼Œè¿›è¡Œç›¸åº”çš„è§£æï¼Œå…ˆå¿½ç•¥</span>
      bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">decorateBeanDefinitionIfRequired</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bdHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// æˆ‘ä»¬æŠŠè¿™æ­¥å«åš æ³¨å†ŒBean å§</span>
         <span class="token class-name">BeanDefinitionReaderUtils</span><span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionStoreException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to register bean definition with name &#39;&quot;</span> <span class="token operator">+</span>
               bdHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ³¨å†Œå®Œæˆåï¼Œå‘é€äº‹ä»¶ï¼Œæœ¬æ–‡ä¸å±•å¼€è¯´è¿™ä¸ª</span>
      <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireComponentRegistered</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanComponentDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¤§å®¶å†ä»”ç»†çœ‹ä¸€ä¸‹è¿™å—å§ï¼Œæˆ‘ä»¬åé¢å°±ä¸å›æ¥è¯´è¿™ä¸ªäº†ã€‚è¿™é‡Œå·²ç»æ ¹æ®ä¸€ä¸ª <!----> æ ‡ç­¾äº§ç”Ÿäº†ä¸€ä¸ª BeanDefinitionHolder çš„å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹é‡Œé¢ä¹Ÿå°±æ˜¯ä¸€ä¸ª BeanDefinition çš„å®ä¾‹å’Œå®ƒçš„ beanNameã€aliases è¿™ä¸‰ä¸ªä¿¡æ¯ï¼Œæ³¨æ„ï¼Œæˆ‘ä»¬çš„å…³æ³¨ç‚¹å§‹ç»ˆåœ¨ BeanDefinition ä¸Šï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanDefinitionHolder</span> <span class="token keyword">implements</span> <span class="token class-name">BeanMetadataElement</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BeanDefinition</span> beanDefinition<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aliases<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åæˆ‘ä»¬å‡†å¤‡æ³¨å†Œè¿™ä¸ª BeanDefinitionï¼Œæœ€åï¼ŒæŠŠè¿™ä¸ªæ³¨å†Œäº‹ä»¶å‘é€å‡ºå»ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹è¯´è¯´æ³¨å†Œ Bean å§ã€‚</p><h5 id="æ³¨å†Œ-bean" tabindex="-1"><a class="header-anchor" href="#æ³¨å†Œ-bean" aria-hidden="true">#</a> æ³¨å†Œ Bean</h5><p>// BeanDefinitionReaderUtils 143</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>
      <span class="token class-name">BeanDefinitionHolder</span> definitionHolder<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>

   <span class="token class-name">String</span> beanName <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// æ³¨å†Œè¿™ä¸ª Bean</span>
   registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// å¦‚æœè¿˜æœ‰åˆ«åçš„è¯ï¼Œä¹Ÿè¦æ ¹æ®åˆ«åå…¨éƒ¨æ³¨å†Œä¸€éï¼Œä¸ç„¶æ ¹æ®åˆ«åå°±ä¼šæ‰¾ä¸åˆ° Bean äº†</span>
   <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aliases <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getAliases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>aliases <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> alias <span class="token operator">:</span> aliases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// alias -&gt; beanName ä¿å­˜å®ƒä»¬çš„åˆ«åä¿¡æ¯ï¼Œè¿™ä¸ªå¾ˆç®€å•ï¼Œç”¨ä¸€ä¸ª map ä¿å­˜ä¸€ä¸‹å°±å¯ä»¥äº†ï¼Œ</span>
         <span class="token comment">// è·å–çš„æ—¶å€™ï¼Œä¼šå…ˆå°† alias è½¬æ¢ä¸º beanNameï¼Œç„¶åå†æŸ¥æ‰¾</span>
         registry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> alias<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ«åæ³¨å†Œçš„æ”¾ä¸€è¾¹ï¼Œæ¯•ç«Ÿå®ƒå¾ˆç®€å•ï¼Œæˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆæ³¨å†Œ Beanã€‚</p><p>// DefaultListableBeanFactory 793</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> beanDefinition<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>

   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">&quot;Bean name must not be empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">,</span> <span class="token string">&quot;BeanDefinition must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinition <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// old? è¿˜è®°å¾— â€œå…è®¸ bean è¦†ç›–â€ è¿™ä¸ªé…ç½®å—ï¼ŸallowBeanDefinitionOverriding</span>
   <span class="token class-name">BeanDefinition</span> oldBeanDefinition<span class="token punctuation">;</span>

   <span class="token comment">// ä¹‹åä¼šçœ‹åˆ°ï¼Œæ‰€æœ‰çš„ Bean æ³¨å†Œåä¼šæ”¾å…¥è¿™ä¸ª beanDefinitionMap ä¸­</span>
   oldBeanDefinition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// å¤„ç†é‡å¤åç§°çš„ Bean å®šä¹‰çš„æƒ…å†µ</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>oldBeanDefinition <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAllowBeanDefinitionOverriding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// å¦‚æœä¸å…è®¸è¦†ç›–çš„è¯ï¼ŒæŠ›å¼‚å¸¸</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldBeanDefinition<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> beanDefinition<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// log...ç”¨æ¡†æ¶å®šä¹‰çš„ Bean è¦†ç›–ç”¨æˆ·è‡ªå®šä¹‰çš„ Bean </span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanDefinition<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>oldBeanDefinition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// log...ç”¨æ–°çš„ Bean è¦†ç›–æ—§çš„ Bean</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token comment">// log...ç”¨åŒç­‰çš„ Bean è¦†ç›–æ—§çš„ Beanï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ equals æ–¹æ³•è¿”å› true çš„ Bean</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// è¦†ç›–</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆ¤æ–­æ˜¯å¦å·²ç»æœ‰å…¶ä»–çš„ Bean å¼€å§‹åˆå§‹åŒ–äº†.</span>
      <span class="token comment">// æ³¨æ„ï¼Œ&quot;æ³¨å†ŒBean&quot; è¿™ä¸ªåŠ¨ä½œç»“æŸï¼ŒBean ä¾ç„¶è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œæˆ‘ä»¬åé¢ä¼šæœ‰å¤§ç¯‡å¹…è¯´åˆå§‹åŒ–è¿‡ç¨‹ï¼Œ</span>
      <span class="token comment">// åœ¨ Spring å®¹å™¨å¯åŠ¨çš„æœ€åï¼Œä¼š é¢„åˆå§‹åŒ– æ‰€æœ‰çš„ singleton beans</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasBeanCreationStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// Cannot modify startup-time collection elements anymore (for stable iteration)</span>
         <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> updatedDefinitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            updatedDefinitions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
            updatedDefinitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames <span class="token operator">=</span> updatedDefinitions<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> updatedSingletons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
               updatedSingletons<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames <span class="token operator">=</span> updatedSingletons<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token comment">// æœ€æ­£å¸¸çš„åº”è¯¥æ˜¯è¿›åˆ°è¿™ä¸ªåˆ†æ”¯ã€‚</span>

         <span class="token comment">// å°† BeanDefinition æ”¾åˆ°è¿™ä¸ª map ä¸­ï¼Œè¿™ä¸ª map ä¿å­˜äº†æ‰€æœ‰çš„ BeanDefinition</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// è¿™æ˜¯ä¸ª ArrayListï¼Œæ‰€ä»¥ä¼šæŒ‰ç…§ bean é…ç½®çš„é¡ºåºä¿å­˜æ¯ä¸€ä¸ªæ³¨å†Œçš„ Bean çš„åå­—</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// è¿™æ˜¯ä¸ª LinkedHashSetï¼Œä»£è¡¨çš„æ˜¯æ‰‹åŠ¨æ³¨å†Œçš„ singleton beanï¼Œ</span>
         <span class="token comment">// æ³¨æ„è¿™é‡Œæ˜¯ remove æ–¹æ³•ï¼Œåˆ°è¿™é‡Œçš„ Bean å½“ç„¶ä¸æ˜¯æ‰‹åŠ¨æ³¨å†Œçš„</span>
         <span class="token comment">// æ‰‹åŠ¨æŒ‡çš„æ˜¯é€šè¿‡è°ƒç”¨ä»¥ä¸‹æ–¹æ³•æ³¨å†Œçš„ bean ï¼š</span>
         <span class="token comment">//     registerSingleton(String beanName, Object singletonObject)</span>
         <span class="token comment">// è¿™ä¸æ˜¯é‡ç‚¹ï¼Œè§£é‡Šåªæ˜¯ä¸ºäº†ä¸è®©å¤§å®¶ç–‘æƒ‘ã€‚Spring ä¼šåœ¨åé¢&quot;æ‰‹åŠ¨&quot;æ³¨å†Œä¸€äº› Beanï¼Œ</span>
         <span class="token comment">// å¦‚ &quot;environment&quot;ã€&quot;systemProperties&quot; ç­‰ beanï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶æ³¨å†Œ Bean åˆ°å®¹å™¨ä¸­çš„</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// è¿™ä¸ªä¸é‡è¦ï¼Œåœ¨é¢„åˆå§‹åŒ–çš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œä¸å¿…ç®¡å®ƒã€‚</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>frozenBeanDefinitionNames <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>oldBeanDefinition <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">containsSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resetBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<strong>åˆ°è¿™é‡Œå·²ç»åˆå§‹åŒ–äº† Bean å®¹å™¨ï¼Œ<!----> é…ç½®ä¹Ÿç›¸åº”çš„è½¬æ¢ä¸ºäº†ä¸€ä¸ªä¸ª BeanDefinitionï¼Œç„¶åæ³¨å†Œäº†å„ä¸ª BeanDefinition åˆ°æ³¨å†Œä¸­å¿ƒï¼Œå¹¶ä¸”å‘é€äº†æ³¨å†Œäº‹ä»¶ã€‚</strong></p><hr><p>åˆ°è¿™é‡Œæ˜¯ä¸€ä¸ªåˆ†æ°´å²­ï¼Œå‰é¢çš„å†…å®¹éƒ½è¿˜ç®—æ¯”è¾ƒç®€å•ï¼Œä¸è¿‡åº”è¯¥ä¹Ÿæ¯”è¾ƒç¹çï¼Œå¤§å®¶è¦æ¸…æ¥šåœ°çŸ¥é“å‰é¢éƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚</p><h3 id="bean-å®¹å™¨å®ä¾‹åŒ–å®Œæˆå" tabindex="-1"><a class="header-anchor" href="#bean-å®¹å™¨å®ä¾‹åŒ–å®Œæˆå" aria-hidden="true">#</a> Bean å®¹å™¨å®ä¾‹åŒ–å®Œæˆå</h3><p>è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å›åˆ° refresh() æ–¹æ³•ï¼Œæˆ‘é‡æ–°è´´äº†ä¸€éä»£ç ï¼Œçœ‹çœ‹æˆ‘ä»¬è¯´åˆ°å“ªäº†ã€‚æ˜¯çš„ï¼Œæˆ‘ä»¬æ‰è¯´å®Œ obtainFreshBeanFactory() æ–¹æ³•ã€‚</p><p>è€ƒè™‘åˆ°ç¯‡å¹…ï¼Œè¿™é‡Œå¼€å§‹å¤§å¹…ç¼©å‡æ‰æ²¡å¿…è¦è¯¦ç»†ä»‹ç»çš„éƒ¨åˆ†ï¼Œå¤§å®¶ç›´æ¥çœ‹ä¸‹é¢çš„ä»£ç ä¸­çš„æ³¨é‡Šå°±å¥½äº†ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
   <span class="token comment">// æ¥ä¸ªé”ï¼Œä¸ç„¶ refresh() è¿˜æ²¡ç»“æŸï¼Œä½ åˆæ¥ä¸ªå¯åŠ¨æˆ–é”€æ¯å®¹å™¨çš„æ“ä½œï¼Œé‚£ä¸å°±ä¹±å¥—äº†å˜›</span>
   <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment">// å‡†å¤‡å·¥ä½œï¼Œè®°å½•ä¸‹å®¹å™¨çš„å¯åŠ¨æ—¶é—´ã€æ ‡è®°â€œå·²å¯åŠ¨â€çŠ¶æ€ã€å¤„ç†é…ç½®æ–‡ä»¶ä¸­çš„å ä½ç¬¦</span>
      <span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// è¿™æ­¥æ¯”è¾ƒå…³é”®ï¼Œè¿™æ­¥å®Œæˆåï¼Œé…ç½®æ–‡ä»¶å°±ä¼šè§£ææˆä¸€ä¸ªä¸ª Bean å®šä¹‰ï¼Œæ³¨å†Œåˆ° BeanFactory ä¸­ï¼Œ</span>
      <span class="token comment">// å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„ Bean è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåªæ˜¯é…ç½®ä¿¡æ¯éƒ½æå–å‡ºæ¥äº†ï¼Œ</span>
      <span class="token comment">// æ³¨å†Œä¹Ÿåªæ˜¯å°†è¿™äº›ä¿¡æ¯éƒ½ä¿å­˜åˆ°äº†æ³¨å†Œä¸­å¿ƒ(è¯´åˆ°åº•æ ¸å¿ƒæ˜¯ä¸€ä¸ª beanName-&gt; beanDefinition çš„ map)</span>
      <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæ·»åŠ å‡ ä¸ª BeanPostProcessorï¼Œæ‰‹åŠ¨æ³¨å†Œå‡ ä¸ªç‰¹æ®Šçš„ bean</span>
      <span class="token comment">// è¿™å—å¾…ä¼šä¼šå±•å¼€è¯´</span>
      <span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// ã€è¿™é‡Œéœ€è¦çŸ¥é“ BeanFactoryPostProcessor è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼ŒBean å¦‚æœå®ç°äº†æ­¤æ¥å£ï¼Œ</span>
         <span class="token comment">// é‚£ä¹ˆåœ¨å®¹å™¨åˆå§‹åŒ–ä»¥åï¼ŒSpring ä¼šè´Ÿè´£è°ƒç”¨é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•ã€‚ã€‘</span>

         <span class="token comment">// è¿™é‡Œæ˜¯æä¾›ç»™å­ç±»çš„æ‰©å±•ç‚¹ï¼Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ Bean éƒ½åŠ è½½ã€æ³¨å†Œå®Œæˆäº†ï¼Œä½†æ˜¯éƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–</span>
         <span class="token comment">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™æ­¥çš„æ—¶å€™æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„ BeanFactoryPostProcessor çš„å®ç°ç±»æˆ–åšç‚¹ä»€ä¹ˆäº‹</span>
         <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// è°ƒç”¨ BeanFactoryPostProcessor å„ä¸ªå®ç°ç±»çš„ postProcessBeanFactory(factory) å›è°ƒæ–¹æ³•</span>
         <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æ³¨å†Œ BeanPostProcessor çš„å®ç°ç±»ï¼Œæ³¨æ„çœ‹å’Œ BeanFactoryPostProcessor çš„åŒºåˆ«</span>
         <span class="token comment">// æ­¤æ¥å£ä¸¤ä¸ªæ–¹æ³•: postProcessBeforeInitialization å’Œ postProcessAfterInitialization</span>
         <span class="token comment">// ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰å’Œåˆå§‹åŒ–ä¹‹åå¾—åˆ°æ‰§è¡Œã€‚è¿™é‡Œä»…ä»…æ˜¯æ³¨å†Œï¼Œä¹‹åä¼šçœ‹åˆ°å›è°ƒè¿™ä¸¤æ–¹æ³•çš„æ—¶æœº</span>
         <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„ MessageSourceï¼Œå›½é™…åŒ–è¿™é‡Œå°±ä¸å±•å¼€è¯´äº†ï¼Œä¸ç„¶æ²¡å®Œæ²¡äº†äº†</span>
         <span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„äº‹ä»¶å¹¿æ’­å™¨ï¼Œè¿™é‡Œä¹Ÿä¸å±•å¼€äº†</span>
         <span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// ä»æ–¹æ³•åå°±å¯ä»¥çŸ¥é“ï¼Œå…¸å‹çš„æ¨¡æ¿æ–¹æ³•(é’©å­æ–¹æ³•)ï¼Œä¸å±•å¼€è¯´</span>
         <span class="token comment">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–ä¸€äº›ç‰¹æ®Šçš„ Beanï¼ˆåœ¨åˆå§‹åŒ– singleton beans ä¹‹å‰ï¼‰</span>
         <span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬å™¨éœ€è¦å®ç° ApplicationListener æ¥å£ã€‚è¿™ä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œè¿‡</span>
         <span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// é‡ç‚¹ï¼Œé‡ç‚¹ï¼Œé‡ç‚¹</span>
         <span class="token comment">// åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans</span>
         <span class="token comment">//ï¼ˆlazy-init çš„é™¤å¤–ï¼‰</span>
         <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æœ€åï¼Œå¹¿æ’­äº‹ä»¶ï¼ŒApplicationContext åˆå§‹åŒ–å®Œæˆï¼Œä¸å±•å¼€</span>
         <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Exception encountered during context initialization - &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;cancelling refresh attempt: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

         <span class="token comment">// Destroy already created singletons to avoid dangling resources.</span>
         <span class="token comment">// é”€æ¯å·²ç»åˆå§‹åŒ–çš„ singleton çš„ Beansï¼Œä»¥å…æœ‰äº› bean ä¼šä¸€ç›´å ç”¨èµ„æº</span>
         <span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// Reset &#39;active&#39; flag.</span>
         <span class="token function">cancelRefresh</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æŠŠå¼‚å¸¸å¾€å¤–æŠ›</span>
         <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         <span class="token comment">// Reset common introspection caches in Spring&#39;s core, since we</span>
         <span class="token comment">// might not ever need metadata for singleton beans anymore...</span>
         <span class="token function">resetCommonCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å‡†å¤‡-bean-å®¹å™¨-preparebeanfactory" tabindex="-1"><a class="header-anchor" href="#å‡†å¤‡-bean-å®¹å™¨-preparebeanfactory" aria-hidden="true">#</a> å‡†å¤‡ Bean å®¹å™¨: prepareBeanFactory</h3><p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒSpring æŠŠæˆ‘ä»¬åœ¨ xml é…ç½®çš„ bean éƒ½æ³¨å†Œä»¥åï¼Œä¼š&quot;æ‰‹åŠ¨&quot;æ³¨å†Œä¸€äº›ç‰¹æ®Šçš„ beanã€‚</p><p>è¿™é‡Œç®€å•ä»‹ç»ä¸‹ prepareBeanFactory(factory) æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Configure the factory&#39;s standard context characteristics,
 * such as the context&#39;s ClassLoader and post-processors.
 * <span class="token keyword">@param</span> <span class="token parameter">beanFactory</span> the BeanFactory to configure
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæˆ‘ä»¬çŸ¥é“ BeanFactory éœ€è¦åŠ è½½ç±»ï¼Œä¹Ÿå°±éœ€è¦ç±»åŠ è½½å™¨ï¼Œ</span>
   <span class="token comment">// è¿™é‡Œè®¾ç½®ä¸ºåŠ è½½å½“å‰ ApplicationContext ç±»çš„ç±»åŠ è½½å™¨</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">setBeanClassLoader</span><span class="token punctuation">(</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è®¾ç½® BeanExpressionResolver</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">setBeanExpressionResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StandardBeanExpressionResolver</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// </span>
   beanFactory<span class="token punctuation">.</span><span class="token function">addPropertyEditorRegistrar</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceEditorRegistrar</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ·»åŠ ä¸€ä¸ª BeanPostProcessorï¼Œè¿™ä¸ª processor æ¯”è¾ƒç®€å•ï¼š</span>
   <span class="token comment">// å®ç°äº† Aware æ¥å£çš„ beans åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè¿™ä¸ª processor è´Ÿè´£å›è°ƒï¼Œ</span>
   <span class="token comment">// è¿™ä¸ªæˆ‘ä»¬å¾ˆå¸¸ç”¨ï¼Œå¦‚æˆ‘ä»¬ä¼šä¸ºäº†è·å– ApplicationContext è€Œ implement ApplicationContextAware</span>
   <span class="token comment">// æ³¨æ„ï¼šå®ƒä¸ä»…ä»…å›è°ƒ ApplicationContextAwareï¼Œ</span>
   <span class="token comment">//   è¿˜ä¼šè´Ÿè´£å›è°ƒ EnvironmentAwareã€ResourceLoaderAware ç­‰ï¼Œçœ‹ä¸‹æºç å°±æ¸…æ¥šäº†</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationContextAwareProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// ä¸‹é¢å‡ è¡Œçš„æ„æ€å°±æ˜¯ï¼Œå¦‚æœæŸä¸ª bean ä¾èµ–äºä»¥ä¸‹å‡ ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œåœ¨è‡ªåŠ¨è£…é…çš„æ—¶å€™å¿½ç•¥å®ƒä»¬ï¼Œ</span>
   <span class="token comment">// Spring ä¼šé€šè¿‡å…¶ä»–æ–¹å¼æ¥å¤„ç†è¿™äº›ä¾èµ–ã€‚</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">EnvironmentAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">EmbeddedValueResolverAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">ResourceLoaderAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEventPublisherAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">MessageSourceAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContextAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token doc-comment comment">/**
    * ä¸‹é¢å‡ è¡Œå°±æ˜¯ä¸ºç‰¹æ®Šçš„å‡ ä¸ª bean èµ‹å€¼ï¼Œå¦‚æœæœ‰ bean ä¾èµ–äº†ä»¥ä¸‹å‡ ä¸ªï¼Œä¼šæ³¨å…¥è¿™è¾¹ç›¸åº”çš„å€¼ï¼Œ
    * ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œ&quot;å½“å‰ ApplicationContext æŒæœ‰ä¸€ä¸ª BeanFactory&quot;ï¼Œè¿™é‡Œè§£é‡Šäº†ç¬¬ä¸€è¡Œã€‚
    * ApplicationContext è¿˜ç»§æ‰¿äº† ResourceLoaderã€ApplicationEventPublisherã€MessageSource
    * æ‰€ä»¥å¯¹äºè¿™å‡ ä¸ªä¾èµ–ï¼Œå¯ä»¥èµ‹å€¼ä¸º thisï¼Œæ³¨æ„ this æ˜¯ä¸€ä¸ª ApplicationContext
    * é‚£è¿™é‡Œæ€ä¹ˆæ²¡çœ‹åˆ°ä¸º MessageSource èµ‹å€¼å‘¢ï¼Ÿé‚£æ˜¯å› ä¸º MessageSource è¢«æ³¨å†Œæˆä¸ºäº†ä¸€ä¸ªæ™®é€šçš„ bean
    */</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">BeanFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">ResourceLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEventPublisher</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è¿™ä¸ª BeanPostProcessor ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨ bean å®ä¾‹åŒ–åï¼Œå¦‚æœæ˜¯ ApplicationListener çš„å­ç±»ï¼Œ</span>
   <span class="token comment">// é‚£ä¹ˆå°†å…¶æ·»åŠ åˆ° listener åˆ—è¡¨ä¸­ï¼Œå¯ä»¥ç†è§£æˆï¼šæ³¨å†Œ äº‹ä»¶ç›‘å¬å™¨</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationListenerDetector</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è¿™é‡Œæ¶‰åŠåˆ°ç‰¹æ®Šçš„ beanï¼Œåä¸ºï¼šloadTimeWeaverï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œå¿½ç•¥å®ƒ</span>
   <span class="token comment">// tips: ltw æ˜¯ AspectJ çš„æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯åœ¨è¿è¡ŒæœŸè¿›è¡Œç»‡å…¥ï¼Œè¿™ä¸ªå’Œ Spring AOP ä¸ä¸€æ ·ï¼Œ</span>
   <span class="token comment">//    æ„Ÿå…´è¶£çš„è¯»è€…è¯·å‚è€ƒæˆ‘å†™çš„å…³äº AspectJ çš„å¦ä¸€ç¯‡æ–‡ç«  https://www.javadoop.com/post/aspectj</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span><span class="token constant">LOAD_TIME_WEAVER_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoadTimeWeaverAwareProcessor</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Set a temporary ClassLoader for type matching.</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">setTempClassLoader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextTypeMatchClassLoader</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token doc-comment comment">/**
    * ä»ä¸‹é¢å‡ è¡Œä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒSpring å¾€å¾€å¾ˆ &quot;æ™ºèƒ½&quot; å°±æ˜¯å› ä¸ºå®ƒä¼šå¸®æˆ‘ä»¬é»˜è®¤æ³¨å†Œä¸€äº›æœ‰ç”¨çš„ beanï¼Œ
    * æˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©è¦†ç›–
    */</span>

   <span class="token comment">// å¦‚æœæ²¡æœ‰å®šä¹‰ &quot;environment&quot; è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š &quot;æ‰‹åŠ¨&quot; æ³¨å†Œä¸€ä¸ª</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsLocalBean</span><span class="token punctuation">(</span><span class="token constant">ENVIRONMENT_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span><span class="token constant">ENVIRONMENT_BEAN_NAME</span><span class="token punctuation">,</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// å¦‚æœæ²¡æœ‰å®šä¹‰ &quot;systemProperties&quot; è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š &quot;æ‰‹åŠ¨&quot; æ³¨å†Œä¸€ä¸ª</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsLocalBean</span><span class="token punctuation">(</span><span class="token constant">SYSTEM_PROPERTIES_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span><span class="token constant">SYSTEM_PROPERTIES_BEAN_NAME</span><span class="token punctuation">,</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// å¦‚æœæ²¡æœ‰å®šä¹‰ &quot;systemEnvironment&quot; è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š &quot;æ‰‹åŠ¨&quot; æ³¨å†Œä¸€ä¸ª</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsLocalBean</span><span class="token punctuation">(</span><span class="token constant">SYSTEM_ENVIRONMENT_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span><span class="token constant">SYSTEM_ENVIRONMENT_BEAN_NAME</span><span class="token punctuation">,</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢è¿™å—ä»£ç ä¸­ï¼ŒSpring å¯¹ä¸€äº›ç‰¹æ®Šçš„ bean è¿›è¡Œäº†å¤„ç†ï¼Œè¯»è€…å¦‚æœæš‚æ—¶è¿˜ä¸èƒ½æ¶ˆåŒ–å®ƒä»¬ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œæ…¢æ…¢å¾€ä¸‹çœ‹ã€‚</p><h3 id="åˆå§‹åŒ–æ‰€æœ‰çš„-singleton-beans" tabindex="-1"><a class="header-anchor" href="#åˆå§‹åŒ–æ‰€æœ‰çš„-singleton-beans" aria-hidden="true">#</a> åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans</h3><p>æˆ‘ä»¬çš„é‡ç‚¹å½“ç„¶æ˜¯ <code>finishBeanFactoryInitialization(beanFactory);</code>è¿™ä¸ªå·¨å¤´äº†ï¼Œè¿™é‡Œä¼šè´Ÿè´£åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beansã€‚</p><p>æ³¨æ„ï¼Œåé¢çš„æè¿°ä¸­ï¼Œæˆ‘éƒ½ä¼šä½¿ç”¨åˆå§‹åŒ–æˆ–é¢„åˆå§‹åŒ–æ¥ä»£è¡¨è¿™ä¸ªé˜¶æ®µï¼ŒSpring ä¼šåœ¨è¿™ä¸ªé˜¶æ®µå®Œæˆæ‰€æœ‰çš„ singleton beans çš„å®ä¾‹åŒ–ã€‚</p><p>æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œåº”è¯¥è¯´ BeanFactory å·²ç»åˆ›å»ºå®Œæˆï¼Œå¹¶ä¸”æ‰€æœ‰çš„å®ç°äº† BeanFactoryPostProcessor æ¥å£çš„ Bean éƒ½å·²ç»åˆå§‹åŒ–å¹¶ä¸”å…¶ä¸­çš„ postProcessBeanFactory(factory) æ–¹æ³•å·²ç»å¾—åˆ°å›è°ƒæ‰§è¡Œäº†ã€‚è€Œä¸” Spring å·²ç»â€œæ‰‹åŠ¨â€æ³¨å†Œäº†ä¸€äº›ç‰¹æ®Šçš„ Beanï¼Œå¦‚ environmentã€systemProperties ç­‰ã€‚</p><p>å‰©ä¸‹çš„å°±æ˜¯åˆå§‹åŒ– singleton beans äº†ï¼Œæˆ‘ä»¬çŸ¥é“å®ƒä»¬æ˜¯å•ä¾‹çš„ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®æ‡’åŠ è½½ï¼Œé‚£ä¹ˆ Spring ä¼šåœ¨æ¥ä¸‹æ¥åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beansã€‚</p><p>// AbstractApplicationContext.java 834</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// åˆå§‹åŒ–å‰©ä½™çš„ singleton beans</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token comment">// é¦–å…ˆï¼Œåˆå§‹åŒ–åå­—ä¸º conversionService çš„ Beanã€‚æœ¬ç€é€ä½›é€åˆ°è¥¿çš„ç²¾ç¥ï¼Œæˆ‘åœ¨é™„å½•ä¸­ç®€å•ä»‹ç»äº†ä¸€ä¸‹ ConversionServiceï¼Œå› ä¸ºè¿™å®åœ¨å¤ªå®ç”¨äº†</span>
   <span class="token comment">// ä»€ä¹ˆï¼Œçœ‹ä»£ç è¿™é‡Œæ²¡æœ‰åˆå§‹åŒ– Bean å•Šï¼</span>
   <span class="token comment">// æ³¨æ„äº†ï¼Œåˆå§‹åŒ–çš„åŠ¨ä½œåŒ…è£…åœ¨ beanFactory.getBean(...) ä¸­ï¼Œè¿™é‡Œå…ˆä¸è¯´ç»†èŠ‚ï¼Œå…ˆå¾€ä¸‹çœ‹å§</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span><span class="token constant">CONVERSION_SERVICE_BEAN_NAME</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
         beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span><span class="token constant">CONVERSION_SERVICE_BEAN_NAME</span><span class="token punctuation">,</span> <span class="token class-name">ConversionService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">setConversionService</span><span class="token punctuation">(</span>
            beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token constant">CONVERSION_SERVICE_BEAN_NAME</span><span class="token punctuation">,</span> <span class="token class-name">ConversionService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// Register a default embedded value resolver if no bean post-processor</span>
   <span class="token comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span>
   <span class="token comment">// at this point, primarily for resolution in annotation attribute values.</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">hasEmbeddedValueResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">addEmbeddedValueResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringValueResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token annotation punctuation">@Override</span>
         <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">resolveStringValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> strVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolvePlaceholders</span><span class="token punctuation">(</span>strVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// å…ˆåˆå§‹åŒ– LoadTimeWeaverAware ç±»å‹çš„ Bean</span>
   <span class="token comment">// ä¹‹å‰ä¹Ÿè¯´è¿‡ï¼Œè¿™æ˜¯ AspectJ ç›¸å…³çš„å†…å®¹ï¼Œæ”¾å¿ƒè·³è¿‡å§</span>
   <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> weaverAwareNames <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">LoadTimeWeaverAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> weaverAwareName <span class="token operator">:</span> weaverAwareNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">getBean</span><span class="token punctuation">(</span>weaverAwareName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// Stop using the temporary ClassLoader for type matching.</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">setTempClassLoader</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ²¡ä»€ä¹ˆåˆ«çš„ç›®çš„ï¼Œå› ä¸ºåˆ°è¿™ä¸€æ­¥çš„æ—¶å€™ï¼ŒSpring å·²ç»å¼€å§‹é¢„åˆå§‹åŒ– singleton beans äº†ï¼Œ</span>
   <span class="token comment">// è‚¯å®šä¸å¸Œæœ›è¿™ä¸ªæ—¶å€™è¿˜å‡ºç° bean å®šä¹‰è§£æã€åŠ è½½ã€æ³¨å†Œã€‚</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">freezeConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// å¼€å§‹åˆå§‹åŒ–</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ä¸Šé¢æœ€åä¸€è¡Œå¾€é‡Œçœ‹ï¼Œæˆ‘ä»¬å°±åˆå›åˆ° DefaultListableBeanFactory è¿™ä¸ªç±»äº†ï¼Œè¿™ä¸ªç±»å¤§å®¶åº”è¯¥éƒ½ä¸é™Œç”Ÿäº†å§ã€‚</p><h4 id="preinstantiatesingletons" tabindex="-1"><a class="header-anchor" href="#preinstantiatesingletons" aria-hidden="true">#</a> preInstantiateSingletons</h4><p>// DefaultListableBeanFactory 728</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Pre-instantiating singletons in &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// this.beanDefinitionNames ä¿å­˜äº†æ‰€æœ‰çš„ beanNames</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> beanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// ä¸‹é¢è¿™ä¸ªå¾ªç¯ï¼Œè§¦å‘æ‰€æœ‰çš„éæ‡’åŠ è½½çš„ singleton beans çš„åˆå§‹åŒ–æ“ä½œ</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment">// åˆå¹¶çˆ¶ Bean ä¸­çš„é…ç½®ï¼Œæ³¨æ„ &lt;bean id=&quot;&quot; class=&quot;&quot; parent=&quot;&quot; /&gt; ä¸­çš„ parentï¼Œç”¨çš„ä¸å¤šå§ï¼Œ</span>
      <span class="token comment">// è€ƒè™‘åˆ°è¿™å¯èƒ½ä¼šå½±å“å¤§å®¶çš„ç†è§£ï¼Œæˆ‘åœ¨é™„å½•ä¸­è§£é‡Šäº†ä¸€ä¸‹ &quot;Bean ç»§æ‰¿&quot;ï¼Œä¸äº†è§£çš„è¯·åˆ°é™„å½•ä¸­çœ‹ä¸€ä¸‹</span>
      <span class="token class-name">RootBeanDefinition</span> bd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// éæŠ½è±¡ã€éæ‡’åŠ è½½çš„ singletonsã€‚å¦‚æœé…ç½®äº† &#39;abstract = true&#39;ï¼Œé‚£æ˜¯ä¸éœ€è¦åˆå§‹åŒ–çš„</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// å¤„ç† FactoryBean(è¯»è€…å¦‚æœä¸ç†Ÿæ‚‰ FactoryBeanï¼Œè¯·ç§»æ­¥é™„å½•åŒºäº†è§£)</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// FactoryBean çš„è¯ï¼Œåœ¨ beanName å‰é¢åŠ ä¸Š â€˜&amp;â€™ ç¬¦å·ã€‚å†è°ƒç”¨ getBeanï¼ŒgetBean æ–¹æ³•åˆ«æ€¥</span>
            <span class="token keyword">final</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> factory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token constant">FACTORY_BEAN_PREFIX</span> <span class="token operator">+</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åˆ¤æ–­å½“å‰ FactoryBean æ˜¯å¦æ˜¯ SmartFactoryBean çš„å®ç°ï¼Œæ­¤å¤„å¿½ç•¥ï¼Œç›´æ¥è·³è¿‡</span>
            <span class="token keyword">boolean</span> isEagerInit<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               isEagerInit <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token annotation punctuation">@Override</span>
                  <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SmartFactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEagerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
               <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               isEagerInit <span class="token operator">=</span> <span class="token punctuation">(</span>factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span> <span class="token operator">&amp;&amp;</span>
                     <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SmartFactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEagerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isEagerInit<span class="token punctuation">)</span> <span class="token punctuation">{</span>

               <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¯¹äºæ™®é€šçš„ Beanï¼Œåªè¦è°ƒç”¨ getBean(beanName) è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥è¿›è¡Œåˆå§‹åŒ–äº†</span>
            <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// åˆ°è¿™é‡Œè¯´æ˜æ‰€æœ‰çš„éæ‡’åŠ è½½çš„ singleton beans å·²ç»å®Œæˆäº†åˆå§‹åŒ–</span>
   <span class="token comment">// å¦‚æœæˆ‘ä»¬å®šä¹‰çš„ bean æ˜¯å®ç°äº† SmartInitializingSingleton æ¥å£çš„ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå¾—åˆ°å›è°ƒï¼Œå¿½ç•¥</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Object</span> singletonInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonInstance <span class="token keyword">instanceof</span> <span class="token class-name">SmartInitializingSingleton</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">final</span> <span class="token class-name">SmartInitializingSingleton</span> smartSingleton <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SmartInitializingSingleton</span><span class="token punctuation">)</span> singletonInstance<span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token annotation punctuation">@Override</span>
               <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  smartSingleton<span class="token punctuation">.</span><span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            smartSingleton<span class="token punctuation">.</span><span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¿›å…¥åˆ° <strong>getBean(beanName) æ–¹æ³•äº†ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ç»å¸¸ç”¨æ¥ä» BeanFactory ä¸­è·å–ä¸€ä¸ª Beanï¼Œè€Œåˆå§‹åŒ–çš„è¿‡ç¨‹ä¹Ÿå°è£…åˆ°äº†è¿™ä¸ªæ–¹æ³•é‡Œã€‚</strong></p><h4 id="getbean" tabindex="-1"><a class="header-anchor" href="#getbean" aria-hidden="true">#</a> getBean</h4><p>åœ¨ç»§ç»­å‰è¿›ä¹‹å‰ï¼Œè¯»è€…åº”è¯¥å…·å¤‡ FactoryBean çš„çŸ¥è¯†ï¼Œå¦‚æœè¯»è€…è¿˜ä¸ç†Ÿæ‚‰ï¼Œè¯·ç§»æ­¥é™„å½•éƒ¨åˆ†äº†è§£ FactoryBeanã€‚</p><p>// AbstractBeanFactory 196</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// æˆ‘ä»¬åœ¨å‰–æåˆå§‹åŒ– Bean çš„è¿‡ç¨‹ï¼Œä½†æ˜¯ getBean æ–¹æ³•æˆ‘ä»¬ç»å¸¸æ˜¯ç”¨æ¥ä»å®¹å™¨ä¸­è·å– Bean ç”¨çš„ï¼Œæ³¨æ„åˆ‡æ¢æ€è·¯ï¼Œ</span>
<span class="token comment">// å·²ç»åˆå§‹åŒ–è¿‡äº†å°±ä»å®¹å™¨ä¸­ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°±å…ˆåˆå§‹åŒ–å†è¿”å›</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span>
      <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> requiredType<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token keyword">boolean</span> typeCheckOnly<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
   <span class="token comment">// è·å–ä¸€ä¸ª â€œæ­£ç»Ÿçš„â€ beanNameï¼Œå¤„ç†ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªæ˜¯å‰é¢è¯´çš„ FactoryBean(å‰é¢å¸¦ â€˜&amp;â€™)ï¼Œ</span>
   <span class="token comment">// ä¸€ä¸ªæ˜¯åˆ«åé—®é¢˜ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯ getBeanï¼Œè·å– Bean ç”¨çš„ï¼Œä½ è¦æ˜¯ä¼ ä¸€ä¸ªåˆ«åè¿›æ¥ï¼Œæ˜¯å®Œå…¨å¯ä»¥çš„</span>
   <span class="token keyword">final</span> <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ³¨æ„è·Ÿç€è¿™ä¸ªï¼Œè¿™ä¸ªæ˜¯è¿”å›å€¼</span>
   <span class="token class-name">Object</span> bean<span class="token punctuation">;</span> 

   <span class="token comment">// æ£€æŸ¥ä¸‹æ˜¯ä¸æ˜¯å·²ç»åˆ›å»ºè¿‡äº†</span>
   <span class="token class-name">Object</span> sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è¿™é‡Œè¯´ä¸‹ args å‘—ï¼Œè™½ç„¶çœ‹ä¸Šå»ä¸€ç‚¹ä¸é‡è¦ã€‚å‰é¢æˆ‘ä»¬ä¸€è·¯è¿›æ¥çš„æ—¶å€™éƒ½æ˜¯ getBean(beanName)ï¼Œ</span>
   <span class="token comment">// æ‰€ä»¥ args ä¼ å‚å…¶å®æ˜¯ null çš„ï¼Œä½†æ˜¯å¦‚æœ args ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œé‚£ä¹ˆæ„å‘³ç€è°ƒç”¨æ–¹ä¸æ˜¯å¸Œæœ›è·å– Beanï¼Œè€Œæ˜¯åˆ›å»º Bean</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Returning cached instance of singleton bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼šå¦‚æœæ˜¯æ™®é€š Bean çš„è¯ï¼Œç›´æ¥è¿”å› sharedInstanceï¼Œ</span>
      <span class="token comment">// å¦‚æœæ˜¯ FactoryBean çš„è¯ï¼Œè¿”å›å®ƒåˆ›å»ºçš„é‚£ä¸ªå®ä¾‹å¯¹è±¡</span>
      <span class="token comment">// (FactoryBean çŸ¥è¯†ï¼Œè¯»è€…è‹¥ä¸æ¸…æ¥šè¯·ç§»æ­¥é™„å½•)</span>
      bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrototypeCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// åˆ›å»ºè¿‡äº†æ­¤ beanName çš„ prototype ç±»å‹çš„ beanï¼Œé‚£ä¹ˆæŠ›å¼‚å¸¸ï¼Œ</span>
         <span class="token comment">// å¾€å¾€æ˜¯å› ä¸ºé™·å…¥äº†å¾ªç¯å¼•ç”¨</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ª BeanDefinition åœ¨å®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨</span>
      <span class="token class-name">BeanFactory</span> parentBeanFactory <span class="token operator">=</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// å¦‚æœå½“å‰å®¹å™¨ä¸å­˜åœ¨è¿™ä¸ª BeanDefinitionï¼Œè¯•è¯•çˆ¶å®¹å™¨ä¸­æœ‰æ²¡æœ‰</span>
         <span class="token class-name">String</span> nameToLookup <span class="token operator">=</span> <span class="token function">originalBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è¿”å›çˆ¶å®¹å™¨çš„æŸ¥è¯¢ç»“æœ</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// No args -&gt; delegate to standard getBean method.</span>
            <span class="token keyword">return</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>typeCheckOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// typeCheckOnly ä¸º falseï¼Œå°†å½“å‰ beanName æ”¾å…¥ä¸€ä¸ª alreadyCreated çš„ Set é›†åˆä¸­ã€‚</span>
         <span class="token function">markBeanAsCreated</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">/*
       * ç¨ç¨æ€»ç»“ä¸€ä¸‹ï¼š
       * åˆ°è¿™é‡Œçš„è¯ï¼Œè¦å‡†å¤‡åˆ›å»º Bean äº†ï¼Œå¯¹äº singleton çš„ Bean æ¥è¯´ï¼Œå®¹å™¨ä¸­è¿˜æ²¡åˆ›å»ºè¿‡æ­¤ Beanï¼›
       * å¯¹äº prototype çš„ Bean æ¥è¯´ï¼Œæœ¬æ¥å°±æ˜¯è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ Beanã€‚
       */</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">checkMergedBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// å…ˆåˆå§‹åŒ–ä¾èµ–çš„æ‰€æœ‰ Beanï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚</span>
         <span class="token comment">// æ³¨æ„ï¼Œè¿™é‡Œçš„ä¾èµ–æŒ‡çš„æ˜¯ depends-on ä¸­å®šä¹‰çš„ä¾èµ–</span>
         <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependsOn <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getDependsOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>dependsOn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dep <span class="token operator">:</span> dependsOn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// æ£€æŸ¥æ˜¯ä¸æ˜¯æœ‰å¾ªç¯ä¾èµ–ï¼Œè¿™é‡Œçš„å¾ªç¯ä¾èµ–å’Œæˆ‘ä»¬å‰é¢è¯´çš„å¾ªç¯ä¾èµ–åˆä¸ä¸€æ ·ï¼Œè¿™é‡Œè‚¯å®šæ˜¯ä¸å…è®¸å‡ºç°çš„ï¼Œä¸ç„¶è¦ä¹±å¥—äº†ï¼Œè¯»è€…æƒ³ä¸€ä¸‹å°±çŸ¥é“äº†</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDependent</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                        <span class="token string">&quot;Circular depends-on relationship between &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39; and &#39;&quot;</span> <span class="token operator">+</span> dep <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               <span class="token comment">// æ³¨å†Œä¸€ä¸‹ä¾èµ–å…³ç³»</span>
               <span class="token function">registerDependentBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// å…ˆåˆå§‹åŒ–è¢«ä¾èµ–é¡¹</span>
               <span class="token function">getBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>

         <span class="token comment">// å¦‚æœæ˜¯ singleton scope çš„ï¼Œåˆ›å»º singleton çš„å®ä¾‹</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token annotation punctuation">@Override</span>
               <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
                  <span class="token keyword">try</span> <span class="token punctuation">{</span>
                     <span class="token comment">// æ‰§è¡Œåˆ›å»º Beanï¼Œè¯¦æƒ…åé¢å†è¯´</span>
                     <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token function">destroySingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœæ˜¯ prototype scope çš„ï¼Œåˆ›å»º prototype çš„å®ä¾‹</span>
            <span class="token comment">// It&#39;s a prototype -&gt; create a new instance.</span>
            <span class="token class-name">Object</span> prototypeInstance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
               <span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// æ‰§è¡Œåˆ›å»º Bean</span>
               prototypeInstance <span class="token operator">=</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
               <span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>prototypeInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœä¸æ˜¯ singleton å’Œ prototype çš„è¯ï¼Œéœ€è¦å§”æ‰˜ç»™ç›¸åº”çš„å®ç°ç±»æ¥å¤„ç†</span>
            <span class="token class-name">String</span> scopeName <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Scope</span> scope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>scopeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;No Scope registered for scope name &#39;&quot;</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
               <span class="token class-name">Object</span> scopedInstance <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token annotation punctuation">@Override</span>
                  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
                     <span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">// æ‰§è¡Œåˆ›å»º Bean</span>
                        <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>scopedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
                     <span class="token string">&quot;Scope &#39;&quot;</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">&quot;&#39; is not active for the current thread; consider &quot;</span> <span class="token operator">+</span>
                     <span class="token string">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span><span class="token punctuation">,</span>
                     ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">cleanupAfterBeanCreationFailure</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// æœ€åï¼Œæ£€æŸ¥ä¸€ä¸‹ç±»å‹å¯¹ä¸å¯¹ï¼Œä¸å¯¹çš„è¯å°±æŠ›å¼‚å¸¸ï¼Œå¯¹çš„è¯å°±è¿”å›äº†</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredType <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> bean <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requiredType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token function">getTypeConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TypeMismatchException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to convert bean &#39;&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;&#39; to required type &#39;&quot;</span> <span class="token operator">+</span>
                  <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getQualifiedName</span><span class="token punctuation">(</span>requiredType<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanNotOfRequiredTypeException</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¤§å®¶åº”è¯¥ä¹ŸçŒœåˆ°äº†ï¼Œæ¥ä¸‹æ¥å½“ç„¶æ˜¯åˆ†æ createBean æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">Object</span> <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ç¬¬ä¸‰ä¸ªå‚æ•° args æ•°ç»„ä»£è¡¨åˆ›å»ºå®ä¾‹éœ€è¦çš„å‚æ•°ï¼Œä¸å°±æ˜¯ç»™æ„é€ æ–¹æ³•ç”¨çš„å‚æ•°ï¼Œæˆ–è€…æ˜¯å·¥å‚ Bean çš„å‚æ•°å˜›ï¼Œä¸è¿‡è¦æ³¨æ„ï¼Œåœ¨æˆ‘ä»¬çš„åˆå§‹åŒ–é˜¶æ®µï¼Œargs æ˜¯ nullã€‚</p><p>è¿™å›æˆ‘ä»¬è¦åˆ°ä¸€ä¸ªæ–°çš„ç±»äº† <strong>AbstractAutowireCapableBeanFactory</strong>ï¼Œçœ‹ç±»åï¼ŒAutowireCapableï¼Ÿç±»åæ˜¯ä¸æ˜¯ä¹Ÿè¯´æ˜äº†ç‚¹é—®é¢˜äº†ã€‚</p><p><strong>ä¸»è¦æ˜¯ä¸ºäº†ä»¥ä¸‹åœºæ™¯ï¼Œé‡‡ç”¨ @Autowired æ³¨è§£æ³¨å…¥å±æ€§å€¼</strong>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MessageService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">&quot;messageService&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;com.javadoop.example.MessageServiceImpl&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šè¿™ç§å±äºæ··ç”¨äº† xml å’Œ æ³¨è§£ ä¸¤ç§æ–¹å¼çš„é…ç½®æ–¹å¼ï¼ŒSpring ä¼šå¤„ç†è¿™ç§æƒ…å†µã€‚</p><p>å¥½äº†ï¼Œè¯»è€…è¦çŸ¥é“è¿™ä¹ˆå›äº‹å°±å¯ä»¥äº†ï¼Œç»§ç»­å‘å‰ã€‚</p><p>// AbstractAutowireCapableBeanFactory 447</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Central method of this class: creates a bean instance,
 * populates the bean instance, applies post-processors, etc.
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">doCreateBean</span></span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Creating instance of bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">RootBeanDefinition</span> mbdToUse <span class="token operator">=</span> mbd<span class="token punctuation">;</span>

   <span class="token comment">// ç¡®ä¿ BeanDefinition ä¸­çš„ Class è¢«åŠ è½½</span>
   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> resolvedClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">hasBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mbdToUse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mbdToUse<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span>resolvedClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// å‡†å¤‡æ–¹æ³•è¦†å†™ï¼Œè¿™é‡Œåˆæ¶‰åŠåˆ°ä¸€ä¸ªæ¦‚å¿µï¼šMethodOverridesï¼Œå®ƒæ¥è‡ªäº bean å®šä¹‰ä¸­çš„ &lt;lookup-method /&gt; </span>
   <span class="token comment">// å’Œ &lt;replaced-method /&gt;ï¼Œå¦‚æœè¯»è€…æ„Ÿå…´è¶£ï¼Œå›åˆ° bean è§£æçš„åœ°æ–¹çœ‹çœ‹å¯¹è¿™ä¸¤ä¸ªæ ‡ç­¾çš„è§£æã€‚</span>
   <span class="token comment">// æˆ‘åœ¨é™„å½•ä¸­ä¹Ÿå¯¹è¿™ä¸¤ä¸ªæ ‡ç­¾çš„ç›¸å…³çŸ¥è¯†ç‚¹è¿›è¡Œäº†ä»‹ç»ï¼Œè¯»è€…å¯ä»¥ç§»æ­¥å»çœ‹çœ‹</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      mbdToUse<span class="token punctuation">.</span><span class="token function">prepareMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            beanName<span class="token punctuation">,</span> <span class="token string">&quot;Validation of method overrides failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// è®© InstantiationAwareBeanPostProcessor åœ¨è¿™ä¸€æ­¥æœ‰æœºä¼šè¿”å›ä»£ç†ï¼Œ</span>
      <span class="token comment">// åœ¨ ã€ŠSpring AOP æºç åˆ†æã€‹é‚£ç¯‡æ–‡ç« ä¸­æœ‰è§£é‡Šï¼Œè¿™é‡Œå…ˆè·³è¿‡</span>
      <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> bean<span class="token punctuation">;</span> 
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
            <span class="token string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// é‡å¤´æˆï¼Œåˆ›å»º bean</span>
   <span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Finished creating instance of bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åˆ›å»º-bean" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º-bean" aria-hidden="true">#</a> åˆ›å»º Bean</h4><p>æˆ‘ä»¬ç»§ç»­å¾€é‡Œçœ‹ doCreateBean è¿™ä¸ªæ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Actually create the specified bean. Pre-creation processing has already happened
 * at this point, e.g. checking <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">postProcessBeforeInstantiation</span></span><span class="token punctuation">}</span> callbacks.
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Differentiates between default bean instantiation, use of a
 * factory method, and autowiring a constructor.
 * <span class="token keyword">@param</span> <span class="token parameter">beanName</span> the name of the bean
 * <span class="token keyword">@param</span> <span class="token parameter">mbd</span> the merged bean definition for the bean
 * <span class="token keyword">@param</span> <span class="token parameter">args</span> explicit arguments to use for constructor or factory method invocation
 * <span class="token keyword">@return</span> a new instance of the bean
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">BeanCreationException</span></span> if the bean could not be created
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">instantiateBean</span></span>
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">instantiateUsingFactoryMethod</span></span>
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">autowireConstructor</span></span>
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">{</span>

   <span class="token comment">// Instantiate the bean.</span>
   <span class="token class-name">BeanWrapper</span> instanceWrapper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      instanceWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanInstanceCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¯´æ˜ä¸æ˜¯ FactoryBeanï¼Œè¿™é‡Œå®ä¾‹åŒ– Beanï¼Œè¿™é‡Œéå¸¸å…³é”®ï¼Œç»†èŠ‚ä¹‹åå†è¯´</span>
      instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// è¿™ä¸ªå°±æ˜¯ Bean é‡Œé¢çš„ æˆ‘ä»¬å®šä¹‰çš„ç±» çš„å®ä¾‹ï¼Œå¾ˆå¤šåœ°æ–¹æˆ‘ç›´æ¥æè¿°æˆ &quot;bean å®ä¾‹&quot;</span>
   <span class="token keyword">final</span> <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// ç±»å‹</span>
   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanType <span class="token operator">=</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mbd<span class="token punctuation">.</span>resolvedTargetType <span class="token operator">=</span> beanType<span class="token punctuation">;</span>

   <span class="token comment">// å»ºè®®è·³è¿‡å§ï¼Œæ¶‰åŠæ¥å£ï¼šMergedBeanDefinitionPostProcessor</span>
   <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>postProcessingLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span>postProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// MergedBeanDefinitionPostProcessorï¼Œè¿™ä¸ªæˆ‘çœŸä¸å±•å¼€è¯´äº†ï¼Œç›´æ¥è·³è¿‡å§ï¼Œå¾ˆå°‘ç”¨çš„</span>
            <span class="token function">applyMergedBeanDefinitionPostProcessors</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                  <span class="token string">&quot;Post-processing of merged bean definition failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         mbd<span class="token punctuation">.</span>postProcessed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// Eagerly cache singletons to be able to resolve circular references</span>
   <span class="token comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
   <span class="token comment">// ä¸‹é¢è¿™å—ä»£ç æ˜¯ä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œä»¥åæœ‰æ—¶é—´ï¼Œæˆ‘å†å¯¹å¾ªç¯ä¾èµ–è¿™ä¸ªé—®é¢˜è¿›è¡Œè§£æå§</span>
   <span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span>
         <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Eagerly caching bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
               <span class="token string">&quot;&#39; to allow for resolving potential circular references&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token annotation punctuation">@Override</span>
         <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// Initialize the bean instance.</span>
   <span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿™ä¸€æ­¥ä¹Ÿæ˜¯éå¸¸å…³é”®çš„ï¼Œè¿™ä¸€æ­¥è´Ÿè´£å±æ€§è£…é…ï¼Œå› ä¸ºå‰é¢çš„å®ä¾‹åªæ˜¯å®ä¾‹åŒ–äº†ï¼Œå¹¶æ²¡æœ‰è®¾å€¼ï¼Œè¿™é‡Œå°±æ˜¯è®¾å€¼</span>
      <span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>exposedObject <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// è¿˜è®°å¾— init-method å—ï¼Ÿè¿˜æœ‰ InitializingBean æ¥å£ï¼Ÿè¿˜æœ‰ BeanPostProcessor æ¥å£ï¼Ÿ</span>
         <span class="token comment">// è¿™é‡Œå°±æ˜¯å¤„ç† bean åˆå§‹åŒ–å®Œæˆåçš„å„ç§å›è°ƒ</span>
         exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">BeanCreationException</span> <span class="token operator">&amp;&amp;</span> beanName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> ex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
               mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">&quot;Initialization of bean failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// </span>
      <span class="token class-name">Object</span> earlySingletonReference <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonReference <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>exposedObject <span class="token operator">==</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            exposedObject <span class="token operator">=</span> earlySingletonReference<span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowRawInjectionDespiteWrapping <span class="token operator">&amp;&amp;</span> <span class="token function">hasDependentBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependentBeans <span class="token operator">=</span> <span class="token function">getDependentBeans</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> actualDependentBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>dependentBeans<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dependentBean <span class="token operator">:</span> dependentBeans<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">removeSingletonIfCreatedForTypeCheckOnly</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  actualDependentBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>actualDependentBeans<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
                     <span class="token string">&quot;Bean with name &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39; has been injected into other beans [&quot;</span> <span class="token operator">+</span>
                     <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">collectionToCommaDelimitedString</span><span class="token punctuation">(</span>actualDependentBeans<span class="token punctuation">)</span> <span class="token operator">+</span>
                     <span class="token string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> <span class="token operator">+</span>
                     <span class="token string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> <span class="token operator">+</span>
                     <span class="token string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> <span class="token operator">+</span>
                     <span class="token string">&quot;&#39;getBeanNamesOfType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// Register bean as disposable.</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
            mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">&quot;Invalid destruction signature&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»åˆ†æå®Œäº† doCreateBean æ–¹æ³•ï¼Œæ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å·²ç»è¯´å®Œäº†æ•´ä¸ªåˆå§‹åŒ–æµç¨‹ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æŒ‘ doCreateBean ä¸­çš„ä¸‰ä¸ªç»†èŠ‚å‡ºæ¥è¯´è¯´ã€‚ä¸€ä¸ªæ˜¯åˆ›å»º Bean å®ä¾‹çš„ createBeanInstance æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ä¾èµ–æ³¨å…¥çš„ populateBean æ–¹æ³•ï¼Œè¿˜æœ‰å°±æ˜¯å›è°ƒæ–¹æ³• initializeBeanã€‚</p><p>æ³¨æ„äº†ï¼Œæ¥ä¸‹æ¥çš„è¿™ä¸‰ä¸ªæ–¹æ³•è¦è®¤çœŸè¯´é‚£ä¹Ÿæ˜¯æå…¶å¤æ‚çš„ï¼Œå¾ˆå¤šåœ°æ–¹æˆ‘å°±ç‚¹åˆ°ä¸ºæ­¢äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±å¾€é‡Œçœ‹ï¼Œæœ€å¥½å°±æ˜¯ç¢°åˆ°ä¸æ‡‚çš„ï¼Œè‡ªå·±å†™ä»£ç å»è°ƒè¯•å®ƒã€‚</p><h5 id="åˆ›å»º-bean-å®ä¾‹" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º-bean-å®ä¾‹" aria-hidden="true">#</a> åˆ›å»º Bean å®ä¾‹</h5><p>æˆ‘ä»¬å…ˆçœ‹çœ‹ createBeanInstance æ–¹æ³•ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•å¦‚æœæ¯ä¸ªåˆ†æ”¯éƒ½åˆ†æä¸‹å»ï¼Œå¿…ç„¶ä¹Ÿæ˜¯æå…¶å¤æ‚å†—é•¿çš„ï¼Œæˆ‘ä»¬æŒ‘é‡ç‚¹è¯´ã€‚æ­¤æ–¹æ³•çš„ç›®çš„å°±æ˜¯å®ä¾‹åŒ–æˆ‘ä»¬æŒ‡å®šçš„ç±»ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">BeanWrapper</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// ç¡®ä¿å·²ç»åŠ è½½äº†æ­¤ class</span>
   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ ¡éªŒä¸€ä¸‹è¿™ä¸ªç±»çš„è®¿é—®æƒé™</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>beanClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isNonPublicAccessAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
            <span class="token string">&quot;Bean class isn&#39;t public, and non-public access not allowed: &quot;</span> <span class="token operator">+</span> beanClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getFactoryMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
      <span class="token comment">// é‡‡ç”¨å·¥å‚æ–¹æ³•å®ä¾‹åŒ–ï¼Œä¸ç†Ÿæ‚‰è¿™ä¸ªæ¦‚å¿µçš„è¯»è€…è¯·çœ‹é™„å½•ï¼Œæ³¨æ„ï¼Œä¸æ˜¯ FactoryBean</span>
      <span class="token keyword">return</span> <span class="token function">instantiateUsingFactoryMethod</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œæ¯”å¦‚ç¬¬äºŒæ¬¡åˆ›å»º prototype beanã€‚</span>
   <span class="token comment">// è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»ç¬¬ä¸€æ¬¡åˆ›å»ºçŸ¥é“ï¼Œé‡‡ç”¨æ— å‚æ„é€ å‡½æ•°ï¼Œè¿˜æ˜¯æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥ æ¥å®Œæˆå®ä¾‹åŒ–</span>
   <span class="token keyword">boolean</span> resolved <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token keyword">boolean</span> autowireNecessary <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>constructorArgumentLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            resolved <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            autowireNecessary <span class="token operator">=</span> mbd<span class="token punctuation">.</span>constructorArgumentsResolved<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>autowireNecessary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥</span>
         <span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token comment">// æ— å‚æ„é€ å‡½æ•°</span>
         <span class="token keyword">return</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// åˆ¤æ–­æ˜¯å¦é‡‡ç”¨æœ‰å‚æ„é€ å‡½æ•°</span>
   <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctors <span class="token operator">=</span> <span class="token function">determineConstructorsFromBeanPostProcessors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>ctors <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
         mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_CONSTRUCTOR</span> <span class="token operator">||</span>
         mbd<span class="token punctuation">.</span><span class="token function">hasConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
      <span class="token comment">// æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥</span>
      <span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> ctors<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// è°ƒç”¨æ— å‚æ„é€ å‡½æ•°</span>
   <span class="token keyword">return</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æŒ‘ä¸ªç®€å•çš„æ— å‚æ„é€ å‡½æ•°æ„é€ å®ä¾‹æ¥çœ‹çœ‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">BeanWrapper</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">Object</span> beanInstance<span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token class-name">BeanFactory</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         beanInstance <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

               <span class="token keyword">return</span> <span class="token function">getInstantiationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token comment">// å®ä¾‹åŒ–</span>
         beanInstance <span class="token operator">=</span> <span class="token function">getInstantiationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// åŒ…è£…ä¸€ä¸‹ï¼Œè¿”å›</span>
      <span class="token class-name">BeanWrapper</span> bw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanWrapperImpl</span><span class="token punctuation">(</span>beanInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">initBeanWrapper</span><span class="token punctuation">(</span>bw<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> bw<span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
            mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">&quot;Instantiation of bean failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…³é”®çš„åœ°æ–¹åœ¨äºï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>beanInstance <span class="token operator">=</span> <span class="token function">getInstantiationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™é‡Œä¼šè¿›è¡Œå®é™…çš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿›å»çœ‹çœ‹:</p><p>// SimpleInstantiationStrategy 59</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span> bd<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanFactory</span> owner<span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token comment">// å¦‚æœä¸å­˜åœ¨æ–¹æ³•è¦†å†™ï¼Œé‚£å°±ä½¿ç”¨ java åå°„è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¦åˆ™ä½¿ç”¨ CGLIB,</span>
   <span class="token comment">// æ–¹æ³•è¦†å†™ è¯·å‚è§é™„å½•&quot;æ–¹æ³•æ³¨å…¥&quot;ä¸­å¯¹ lookup-method å’Œ replaced-method çš„ä»‹ç»</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> constructorToUse<span class="token punctuation">;</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>bd<span class="token punctuation">.</span>constructorArgumentLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         constructorToUse <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> bd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod<span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>constructorToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> bd<span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanInstantiationException</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">&quot;Specified class is an interface&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  constructorToUse <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constructor</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token annotation punctuation">@Override</span>
                     <span class="token keyword">public</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  constructorToUse <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               bd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod <span class="token operator">=</span> constructorToUse<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanInstantiationException</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">&quot;No default constructor found&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// åˆ©ç”¨æ„é€ æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–</span>
      <span class="token keyword">return</span> <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>constructorToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// å­˜åœ¨æ–¹æ³•è¦†å†™ï¼Œåˆ©ç”¨ CGLIB æ¥å®Œæˆå®ä¾‹åŒ–ï¼Œéœ€è¦ä¾èµ–äº CGLIB ç”Ÿæˆå­ç±»ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</span>
      <span class="token comment">// tips: å› ä¸ºå¦‚æœä¸ä½¿ç”¨ CGLIB çš„è¯ï¼Œå­˜åœ¨ override çš„æƒ…å†µ JDK å¹¶æ²¡æœ‰æä¾›ç›¸åº”çš„å®ä¾‹åŒ–æ”¯æŒ</span>
      <span class="token keyword">return</span> <span class="token function">instantiateWithMethodInjection</span><span class="token punctuation">(</span>bd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±ç®—å®ä¾‹åŒ–å®Œæˆäº†ã€‚æˆ‘ä»¬å¼€å§‹è¯´æ€ä¹ˆè¿›è¡Œå±æ€§æ³¨å…¥ã€‚</p><h5 id="bean-å±æ€§æ³¨å…¥" tabindex="-1"><a class="header-anchor" href="#bean-å±æ€§æ³¨å…¥" aria-hidden="true">#</a> bean å±æ€§æ³¨å…¥</h5><p>çœ‹å®Œäº† createBeanInstance(...) æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ populateBean(...) æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è´Ÿè´£è¿›è¡Œå±æ€§è®¾å€¼ï¼Œå¤„ç†ä¾èµ–ã€‚</p><p>// AbstractAutowireCapableBeanFactory 1203</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">populateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">BeanWrapper</span> bw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// bean å®ä¾‹çš„æ‰€æœ‰å±æ€§éƒ½åœ¨è¿™é‡Œäº†</span>
   <span class="token class-name">PropertyValues</span> pvs <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>bw <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pvs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
               mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">&quot;Cannot apply property values to null instance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token comment">// Skip property population phase for null instance.</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// åˆ°è¿™æ­¥çš„æ—¶å€™ï¼Œbean å®ä¾‹åŒ–å®Œæˆï¼ˆé€šè¿‡å·¥å‚æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ï¼‰ï¼Œä½†æ˜¯è¿˜æ²¡å¼€å§‹å±æ€§è®¾å€¼ï¼Œ</span>
   <span class="token comment">// InstantiationAwareBeanPostProcessor çš„å®ç°ç±»å¯ä»¥åœ¨è¿™é‡Œå¯¹ bean è¿›è¡ŒçŠ¶æ€ä¿®æ”¹ï¼Œ</span>
   <span class="token comment">// æˆ‘ä¹Ÿæ²¡æ‰¾åˆ°æœ‰å®é™…çš„ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æš‚ä¸”å¿½ç•¥è¿™å—å§</span>
   <span class="token keyword">boolean</span> continueWithPropertyPopulation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
            <span class="token comment">// å¦‚æœè¿”å› falseï¼Œä»£è¡¨ä¸éœ€è¦è¿›è¡Œåç»­çš„å±æ€§è®¾å€¼ï¼Œä¹Ÿä¸éœ€è¦å†ç»è¿‡å…¶ä»–çš„ BeanPostProcessor çš„å¤„ç†</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ibp<span class="token punctuation">.</span><span class="token function">postProcessAfterInstantiation</span><span class="token punctuation">(</span>bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               continueWithPropertyPopulation <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>continueWithPropertyPopulation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_BY_NAME</span> <span class="token operator">||</span>
         mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_BY_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">MutablePropertyValues</span> newPvs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutablePropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// é€šè¿‡åå­—æ‰¾åˆ°æ‰€æœ‰å±æ€§å€¼ï¼Œå¦‚æœæ˜¯ bean ä¾èµ–ï¼Œå…ˆåˆå§‹åŒ–ä¾èµ–çš„ beanã€‚è®°å½•ä¾èµ–å…³ç³»</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_BY_NAME</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">autowireByName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> newPvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// é€šè¿‡ç±»å‹è£…é…ã€‚å¤æ‚ä¸€äº›</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_BY_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">autowireByType</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> newPvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      pvs <span class="token operator">=</span> newPvs<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">boolean</span> hasInstAwareBpps <span class="token operator">=</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">boolean</span> needsDepCheck <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getDependencyCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">DEPENDENCY_CHECK_NONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>hasInstAwareBpps <span class="token operator">||</span> needsDepCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">PropertyDescriptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> filteredPds <span class="token operator">=</span> <span class="token function">filterPropertyDescriptorsForDependencyCheck</span><span class="token punctuation">(</span>bw<span class="token punctuation">,</span> mbd<span class="token punctuation">.</span>allowCaching<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasInstAwareBpps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
               <span class="token comment">// è¿™é‡Œæœ‰ä¸ªéå¸¸æœ‰ç”¨çš„ BeanPostProcessor è¿›åˆ°è¿™é‡Œ: AutowiredAnnotationBeanPostProcessor</span>
               <span class="token comment">// å¯¹é‡‡ç”¨ @Autowiredã€@Value æ³¨è§£çš„ä¾èµ–è¿›è¡Œè®¾å€¼ï¼Œè¿™é‡Œçš„å†…å®¹ä¹Ÿæ˜¯éå¸¸ä¸°å¯Œçš„ï¼Œä¸è¿‡æœ¬æ–‡ä¸ä¼šå±•å¼€è¯´äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…è¯·è‡ªè¡Œç ”ç©¶</span>
               pvs <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessPropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>needsDepCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">checkDependencies</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// è®¾ç½® bean å®ä¾‹çš„å±æ€§å€¼</span>
   <span class="token function">applyPropertyValues</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="initializebean" tabindex="-1"><a class="header-anchor" href="#initializebean" aria-hidden="true">#</a> initializeBean</h5><p>å±æ€§æ³¨å…¥å®Œæˆåï¼Œè¿™ä¸€æ­¥å…¶å®å°±æ˜¯å¤„ç†å„ç§å›è°ƒäº†ï¼Œè¿™å—ä»£ç æ¯”è¾ƒç®€å•ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token annotation punctuation">@Override</span>
         <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœ bean å®ç°äº† BeanNameAwareã€BeanClassLoaderAware æˆ– BeanFactoryAware æ¥å£ï¼Œå›è°ƒ</span>
      <span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token class-name">Object</span> wrappedBean <span class="token operator">=</span> bean<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// BeanPostProcessor çš„ postProcessBeforeInitialization å›è°ƒ</span>
      wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsBeforeInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¤„ç† bean ä¸­å®šä¹‰çš„ init-methodï¼Œ</span>
      <span class="token comment">// æˆ–è€…å¦‚æœ bean å®ç°äº† InitializingBean æ¥å£ï¼Œè°ƒç”¨ afterPropertiesSet() æ–¹æ³•</span>
      <span class="token function">invokeInitMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> wrappedBean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span>mbd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            beanName<span class="token punctuation">,</span> <span class="token string">&quot;Invocation of init method failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// BeanPostProcessor çš„ postProcessAfterInitialization å›è°ƒ</span>
      wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> wrappedBean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¤§å®¶å‘ç°æ²¡æœ‰ï¼ŒBeanPostProcessor çš„ä¸¤ä¸ªå›è°ƒéƒ½å‘ç”Ÿåœ¨è¿™è¾¹ï¼Œåªä¸è¿‡ä¸­é—´å¤„ç†äº† init-methodï¼Œæ˜¯ä¸æ˜¯å’Œè¯»è€…åŸæ¥çš„è®¤çŸ¥æœ‰ç‚¹ä¸ä¸€æ ·äº†ï¼Ÿ</p><h2 id="é™„å½•" tabindex="-1"><a class="header-anchor" href="#é™„å½•" aria-hidden="true">#</a> é™„å½•</h2><h3 id="id-å’Œ-name" tabindex="-1"><a class="header-anchor" href="#id-å’Œ-name" aria-hidden="true">#</a> id å’Œ name</h3><p><strong>æ¯ä¸ª Bean åœ¨ Spring å®¹å™¨ä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åå­—ï¼ˆbeanNameï¼‰å’Œ 0 ä¸ªæˆ–å¤šä¸ªåˆ«åï¼ˆaliasesï¼‰ã€‚</strong></p><p>æˆ‘ä»¬ä» Spring å®¹å™¨ä¸­è·å– Bean çš„æ—¶å€™ï¼Œå¯ä»¥æ ¹æ® beanNameï¼Œä¹Ÿå¯ä»¥é€šè¿‡åˆ«åã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;beanName or alias&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åœ¨é…ç½® <!----> çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½® id å’Œ nameï¼Œçœ‹å‡ ä¸ªä¾‹å­å°±çŸ¥é“æ˜¯æ€ä¹ˆå›äº‹äº†ã€‚</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>messageService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>m1, m2, m3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.javadoop.example.MessageServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º messageServiceï¼Œåˆ«åæœ‰ 3 ä¸ªï¼Œåˆ†åˆ«ä¸º m1ã€m2ã€m3ã€‚</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>m1, m2, m3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.javadoop.example.MessageServiceImpl<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º m1ï¼Œåˆ«åæœ‰ 2 ä¸ªï¼Œåˆ†åˆ«ä¸º m2ã€m3ã€‚</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.javadoop.example.MessageServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>beanName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl#0ï¼Œ</p><p>åˆ«å 1 ä¸ªï¼Œä¸ºï¼š com.javadoop.example.MessageServiceImpl</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>messageService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.javadoop.example.MessageServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º messageServiceï¼Œæ²¡æœ‰åˆ«åã€‚</p><h3 id="é…ç½®æ˜¯å¦å…è®¸-bean-è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#é…ç½®æ˜¯å¦å…è®¸-bean-è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–" aria-hidden="true">#</a> é…ç½®æ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–</h3><p>æˆ‘ä»¬è¯´è¿‡ï¼Œ<strong>é»˜è®¤æƒ…å†µä¸‹ï¼ŒallowBeanDefinitionOverriding å±æ€§ä¸º nullã€‚å¦‚æœåœ¨åŒä¸€é…ç½®æ–‡ä»¶ä¸­ Bean id æˆ– name é‡å¤äº†ï¼Œä¼šæŠ›é”™ï¼Œä½†æ˜¯å¦‚æœä¸æ˜¯åŒä¸€é…ç½®æ–‡ä»¶ä¸­ï¼Œä¼šå‘ç”Ÿè¦†ç›–ã€‚</strong></p><p>å¯æ˜¯æœ‰äº›æ—¶å€™æˆ‘ä»¬å¸Œæœ›åœ¨ç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹ä¸­å°±ä¸¥æ ¼æœç»å‘ç”Ÿ Bean è¦†ç›–ï¼Œå› ä¸ºä¸‡ä¸€å‡ºç°è¿™ç§æƒ…å†µï¼Œä¼šå¢åŠ æˆ‘ä»¬æ’æŸ¥é—®é¢˜çš„æˆæœ¬ã€‚</p><p>å¾ªç¯ä¾èµ–è¯´çš„æ˜¯ A ä¾èµ– Bï¼Œè€Œ B åˆä¾èµ– Aã€‚æˆ–è€…æ˜¯ A ä¾èµ– Bï¼ŒB ä¾èµ– Cï¼Œè€Œ C å´ä¾èµ– Aã€‚<strong>é»˜è®¤ allowCircularReferences ä¹Ÿæ˜¯ nullã€‚</strong></p><p>å®ƒä»¬ä¸¤ä¸ªå±æ€§æ˜¯ä¸€èµ·å‡ºç°çš„ï¼Œå¿…ç„¶å¯ä»¥åœ¨åŒä¸€ä¸ªåœ°æ–¹ä¸€èµ·è¿›è¡Œé…ç½®ã€‚</p><p>æ·»åŠ è¿™ä¸¤ä¸ªå±æ€§çš„ä½œè€… Juergen Hoeller åœ¨è¿™ä¸ª <a href="https://jira.spring.io/browse/SPR-4374" target="_blank" rel="noopener noreferrer">jira<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> çš„è®¨è®ºä¸­è¯´æ˜äº†æ€ä¹ˆé…ç½®è¿™ä¸¤ä¸ªå±æ€§ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NoBeanOverridingContextLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ContextLoader</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">customizeContext</span><span class="token punctuation">(</span><span class="token class-name">ServletContext</span> servletContext<span class="token punctuation">,</span> <span class="token class-name">ConfigurableWebApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">customizeContext</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">,</span> applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AbstractRefreshableApplicationContext</span> arac <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AbstractRefreshableApplicationContext</span><span class="token punctuation">)</span> applicationContext<span class="token punctuation">;</span>
    arac<span class="token punctuation">.</span><span class="token function">setAllowBeanDefinitionOverriding</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyContextLoaderListener</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span>ContextLoaderListener</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token class-name">ContextLoader</span> <span class="token function">createContextLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NoBeanOverridingContextLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token generics"><span class="token punctuation">&lt;</span>listener<span class="token punctuation">&gt;</span></span>
    <span class="token operator">&lt;</span>listener<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">&gt;</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>javadoop<span class="token punctuation">.</span></span>MyContextLoaderListener</span><span class="token operator">&lt;</span><span class="token operator">/</span>listener<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">&gt;</span>  
<span class="token operator">&lt;</span><span class="token operator">/</span>listener<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœä»¥ä¸Šæ–¹å¼ä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œè¯·å‚è€ƒè¿™ä¸ªé“¾æ¥ï¼š<a href="http://blog.csdn.net/zgmzyr/article/details/39380477" target="_blank" rel="noopener noreferrer">è§£å†³springä¸­ä¸åŒé…ç½®æ–‡ä»¶ä¸­å­˜åœ¨nameæˆ–è€…idç›¸åŒçš„beanå¯èƒ½å¼•èµ·çš„é—®é¢˜<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="profile" tabindex="-1"><a class="header-anchor" href="#profile" aria-hidden="true">#</a> profile</h3><p>æˆ‘ä»¬<strong>å¯ä»¥æŠŠä¸åŒç¯å¢ƒçš„é…ç½®åˆ†åˆ«é…ç½®åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­</strong>ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">profile</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>development<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>jdbc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/jdbc<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>...<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jdbc:</span>embedded-database</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jdbc:</span>script</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classpath:com/bank/config/sql/schema.sql<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jdbc:</span>script</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classpath:com/bank/config/sql/test-data.sql<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">jdbc:</span>embedded-database</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">profile</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>production<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>jee</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/jee<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>...<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jee:</span>jndi-lookup</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">jndi-name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>java:comp/env/jdbc/datasource<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åº”è¯¥ä¸å¿…åšè¿‡å¤šè§£é‡Šäº†å§ï¼Œçœ‹æ¯ä¸ªæ–‡ä»¶ç¬¬ä¸€è¡Œçš„ profile=&quot;&quot;ã€‚</p><p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>jdbc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/jdbc<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>jee</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/jee<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>...<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">profile</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>development<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jdbc:</span>embedded-database</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jdbc:</span>script</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classpath:com/bank/config/sql/schema.sql<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jdbc:</span>script</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classpath:com/bank/config/sql/test-data.sql<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">jdbc:</span>embedded-database</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">profile</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>production<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jee:</span>jndi-lookup</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">jndi-name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>java:comp/env/jdbc/datasource<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç†è§£èµ·æ¥ä¹Ÿå¾ˆç®€å•å§ã€‚</p><p>æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯ï¼Œæ€ä¹ˆä½¿ç”¨ç‰¹å®šçš„ profile å‘¢ï¼Ÿ**Spring åœ¨å¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå»å¯»æ‰¾ â€œspring.profiles.activeâ€ çš„å±æ€§å€¼ï¼Œæ ¹æ®è¿™ä¸ªå±æ€§å€¼æ¥çš„ã€‚**é‚£æ€ä¹ˆé…ç½®è¿™ä¸ªå€¼å‘¢ï¼Ÿ</p><p>Spring ä¼šåœ¨è¿™å‡ ä¸ªåœ°æ–¹å¯»æ‰¾ spring.profiles.active çš„å±æ€§å€¼ï¼šæ“ä½œç³»ç»Ÿç¯å¢ƒå˜é‡ã€JVM ç³»ç»Ÿå˜é‡ã€web.xml ä¸­å®šä¹‰çš„å‚æ•°ã€JNDIã€‚</p><p>æœ€ç®€å•çš„æ–¹å¼è«è¿‡äºåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™æŒ‡å®šï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token parameter variable">-Dspring.profiles.active</span><span class="token operator">=</span><span class="token string">&quot;profile1,profile2&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>profile å¯ä»¥æ¿€æ´»å¤šä¸ª</p><p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç çš„å½¢å¼ä» Environment ä¸­è®¾ç½® profileï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">AnnotationConfigApplicationContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setActiveProfiles</span><span class="token punctuation">(</span><span class="token string">&quot;development&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">SomeConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">StandaloneDataConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">JndiDataConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é‡å¯</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ˜¯ <strong>Spring Boot çš„è¯æ›´ç®€å•ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šåˆ›å»º application.propertiesã€application-dev.propertiesã€application-prod.properties ç­‰æ–‡ä»¶ï¼Œå…¶ä¸­ application.properties é…ç½®å„ä¸ªç¯å¢ƒé€šç”¨çš„é…ç½®ï¼Œapplication-{profile}.properties ä¸­é…ç½®ç‰¹å®šç¯å¢ƒçš„é…ç½®ï¼Œç„¶ååœ¨å¯åŠ¨çš„æ—¶å€™æŒ‡å®š profile</strong>ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">java</span> <span class="token parameter variable">-Dspring.profiles.active</span><span class="token operator">=</span>prod <span class="token parameter variable">-jar</span> JavaDoop.jar
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>å¦‚æœæ˜¯å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨çš„è¯ï¼Œåœ¨æµ‹è¯•ç±»ä¸­ä½¿ç”¨ @ActiveProfiles æŒ‡å®š</strong>ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</p><h3 id="å·¥å‚æ¨¡å¼ç”Ÿæˆ-bean" tabindex="-1"><a class="header-anchor" href="#å·¥å‚æ¨¡å¼ç”Ÿæˆ-bean" aria-hidden="true">#</a> å·¥å‚æ¨¡å¼ç”Ÿæˆ Bean</h3><p>è¯·è¯»è€…æ³¨æ„ factory-bean å’Œ FactoryBean çš„åŒºåˆ«ã€‚è¿™èŠ‚è¯´çš„æ˜¯å‰è€…ï¼Œæ˜¯è¯´é™æ€å·¥å‚æˆ–å®ä¾‹å·¥å‚ï¼Œè€Œåè€…æ˜¯ Spring ä¸­çš„ç‰¹æ®Šæ¥å£ï¼Œä»£è¡¨ä¸€ç±»ç‰¹æ®Šçš„ Beanï¼Œé™„å½•çš„ä¸‹é¢ä¸€èŠ‚ä¼šä»‹ç» FactoryBeanã€‚</p><p>è®¾è®¡æ¨¡å¼é‡Œï¼Œå·¥å‚æ–¹æ³•æ¨¡å¼åˆ†é™æ€å·¥å‚å’Œå®ä¾‹å·¥å‚ï¼Œæˆ‘ä»¬åˆ†åˆ«çœ‹çœ‹ Spring ä¸­æ€ä¹ˆé…ç½®è¿™ä¸¤ä¸ªï¼Œæ¥ä¸ªä»£ç ç¤ºä¾‹å°±ä»€ä¹ˆéƒ½æ¸…æ¥šäº†ã€‚</p><p>é™æ€å·¥å‚ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>clientService<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>examples.ClientService<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>createInstance<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
public class ClientService {
    private static ClientService clientService = new ClientService();
    private ClientService() {}

    // é™æ€æ–¹æ³•
    public static ClientService createInstance() {
        return clientService;
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ä¾‹å·¥å‚ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>serviceLocator<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>examples.DefaultServiceLocator<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- inject any dependencies required by this locator bean --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>clientService<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">factory-bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>serviceLocator<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>createClientServiceInstance<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>accountService<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">factory-bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>serviceLocator<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>createAccountServiceInstance<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
public class DefaultServiceLocator {

    private static ClientService clientService = new ClientServiceImpl();

    private static AccountService accountService = new AccountServiceImpl();

    public ClientService createClientServiceInstance() {
        return clientService;
    }

    public AccountService createAccountServiceInstance() {
        return accountService;
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="factorybean" tabindex="-1"><a class="header-anchor" href="#factorybean" aria-hidden="true">#</a> FactoryBean</h3><p><strong>FactoryBean é€‚ç”¨äº Bean çš„åˆ›å»ºè¿‡ç¨‹æ¯”è¾ƒå¤æ‚çš„åœºæ™¯</strong>ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥æ± çš„åˆ›å»ºã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token class-name">T</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span> 
    <span class="token keyword">private</span> <span class="token class-name">Car</span> car <span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setCar</span><span class="token punctuation">(</span><span class="token class-name">Car</span> car<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>car <span class="token operator">=</span> car<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å‡è®¾ç°åœ¨éœ€è¦åˆ›å»ºä¸€ä¸ª Person çš„ Beanï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ª Car çš„å®ä¾‹ï¼Œæˆ‘ä»¬è¿™é‡Œå‡è®¾ Car çš„å®ä¾‹åˆ›å»ºå¾ˆéº»çƒ¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠåˆ›å»º Car çš„å¤æ‚è¿‡ç¨‹åŒ…è£…èµ·æ¥ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCarFactoryBean</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Car</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> make<span class="token punctuation">;</span> 
    <span class="token keyword">private</span> <span class="token keyword">int</span> year <span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMake</span><span class="token punctuation">(</span><span class="token class-name">String</span> m<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>make <span class="token operator">=</span>m <span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setYear</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>year <span class="token operator">=</span> y<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Car</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
      <span class="token comment">// è¿™é‡Œæˆ‘ä»¬å‡è®¾ Car çš„å®ä¾‹åŒ–è¿‡ç¨‹éå¸¸å¤æ‚ï¼Œåæ­£å°±ä¸æ˜¯å‡ è¡Œä»£ç å¯ä»¥å†™å®Œçš„é‚£ç§</span>
      <span class="token class-name">CarBuilder</span> cb <span class="token operator">=</span> <span class="token class-name">CarBuilder</span><span class="token punctuation">.</span><span class="token function">car</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span><span class="token punctuation">(</span>year<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> cb<span class="token punctuation">.</span><span class="token function">setYear</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>year<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>make<span class="token punctuation">)</span><span class="token punctuation">)</span> cb<span class="token punctuation">.</span><span class="token function">setMake</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>make <span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span> cb<span class="token punctuation">.</span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Car</span><span class="token punctuation">&gt;</span></span> <span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token class-name">Car</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">;</span> <span class="token punctuation">}</span> 

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬çœ‹çœ‹è£…é…çš„æ—¶å€™æ˜¯æ€ä¹ˆé…ç½®çš„ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">&quot;</span>com.javadoop.MyCarFactoryBean<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">&quot;</span>car<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">&quot;</span>make<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Honda<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">&quot;</span>year<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1984<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">&quot;</span>com.javadoop.Person<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">&quot;</span>josh<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">&quot;</span>car<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">&quot;</span>car<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çœ‹åˆ°ä¸ä¸€æ ·äº†å—ï¼Ÿid ä¸º â€œcarâ€ çš„ bean å…¶å®æŒ‡å®šçš„æ˜¯ä¸€ä¸ª FactoryBeanï¼Œä¸è¿‡é…ç½®çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç›´æ¥è®©é…ç½® Person çš„ Bean ç›´æ¥ä¾èµ–äºè¿™ä¸ª FactoryBean å°±å¯ä»¥äº†ã€‚ä¸­é—´çš„è¿‡ç¨‹ Spring å·²ç»å°è£…å¥½äº†ã€‚</p><p>è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¥ç‚¹å¹²è´§ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç°åœ¨è¿˜ç”¨ xml é…ç½® Bean ä¾èµ–çš„è¶Šæ¥è¶Šå°‘äº†ï¼Œæ›´å¤šæ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡‡ç”¨ java config çš„æ–¹å¼æ¥é…ç½®ï¼Œè¿™é‡Œæœ‰ä»€ä¹ˆä¸ä¸€æ ·å‘¢ï¼Ÿ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CarConfiguration</span> <span class="token punctuation">{</span> 

    <span class="token annotation punctuation">@Bean</span> 
    <span class="token keyword">public</span> <span class="token class-name">MyCarFactoryBean</span> <span class="token function">carFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
      <span class="token class-name">MyCarFactoryBean</span> cfb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyCarFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cfb<span class="token punctuation">.</span><span class="token function">setMake</span><span class="token punctuation">(</span><span class="token string">&quot;Honda&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cfb<span class="token punctuation">.</span><span class="token function">setYear</span><span class="token punctuation">(</span><span class="token number">1984</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> cfb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Person</span> <span class="token function">aPerson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// æ³¨æ„è¿™é‡Œçš„ä¸åŒ</span>
    person<span class="token punctuation">.</span><span class="token function">setCar</span><span class="token punctuation">(</span><span class="token function">carFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> person<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªæ—¶å€™ï¼Œå…¶å®æˆ‘ä»¬çš„æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼ŒæŠŠ MyCarFactoryBean çœ‹æˆæ˜¯ä¸€ä¸ªç®€å•çš„ Bean å°±å¯ä»¥äº†ï¼Œä¸å¿…ç†ä¼šä»€ä¹ˆ FactoryBeanï¼Œå®ƒæ˜¯ä¸æ˜¯ FactoryBean å’Œæˆ‘ä»¬æ²¡å…³ç³»ã€‚</p><h3 id="åˆå§‹åŒ–-bean-çš„å›è°ƒ" tabindex="-1"><a class="header-anchor" href="#åˆå§‹åŒ–-bean-çš„å›è°ƒ" aria-hidden="true">#</a> åˆå§‹åŒ– Bean çš„å›è°ƒ</h3><p>æœ‰ä»¥ä¸‹å››ç§æ–¹æ¡ˆï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>exampleInitBean<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>examples.ExampleBean<span class="token punctuation">&quot;</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>init<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
public class AnotherExampleBean implements InitializingBean {

    public void afterPropertiesSet() {
        // do some initialization work
    }
}
@Bean(initMethod = &quot;init&quot;)
public Foo foo() {
    return new Foo();
}
@PostConstruct
public void init() {

}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="é”€æ¯-bean-çš„å›è°ƒ" tabindex="-1"><a class="header-anchor" href="#é”€æ¯-bean-çš„å›è°ƒ" aria-hidden="true">#</a> é”€æ¯ Bean çš„å›è°ƒ</h3><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>exampleInitBean<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>examples.ExampleBean<span class="token punctuation">&quot;</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cleanup<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
public class AnotherExampleBean implements DisposableBean {

    public void destroy() {
        // do some destruction work (like releasing pooled connections)
    }
}
@Bean(destroyMethod = &quot;cleanup&quot;)
public Bar bar() {
    return new Bar();
}
@PreDestroy
public void cleanup() {

}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="conversionservice" tabindex="-1"><a class="header-anchor" href="#conversionservice" aria-hidden="true">#</a> ConversionService</h3><p>æ—¢ç„¶æ–‡ä¸­è¯´åˆ°äº†è¿™ä¸ªï¼Œé¡ºä¾¿æä¸€ä¸‹å¥½äº†ã€‚</p><p><strong>æœ€æœ‰ç”¨çš„åœºæ™¯å°±æ˜¯ï¼Œå®ƒç”¨æ¥å°†å‰ç«¯ä¼ è¿‡æ¥çš„å‚æ•°å’Œåç«¯çš„ controller æ–¹æ³•ä¸Šçš„å‚æ•°è¿›è¡Œç»‘å®šçš„æ—¶å€™ç”¨ã€‚</strong></p><p>åƒå‰ç«¯ä¼ è¿‡æ¥çš„å­—ç¬¦ä¸²ã€æ•´æ•°è¦è½¬æ¢ä¸ºåç«¯çš„ Stringã€Integer å¾ˆå®¹æ˜“ï¼Œä½†æ˜¯å¦‚æœ controller æ–¹æ³•éœ€è¦çš„æ˜¯ä¸€ä¸ªæšä¸¾å€¼ï¼Œæˆ–è€…æ˜¯ Date è¿™äº›éåŸºç¡€ç±»å‹ï¼ˆå«åŸºç¡€ç±»å‹åŒ…è£…ç±»ï¼‰å€¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘é‡‡ç”¨ ConversionService æ¥è¿›è¡Œè½¬æ¢ã€‚</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>conversionService<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.springframework.context.support.ConversionServiceFactoryBean<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>converters<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.javadoop.learning.utils.StringToEnumConverterFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ConversionService æ¥å£å¾ˆç®€å•ï¼Œæ‰€ä»¥è¦è‡ªå®šä¹‰ä¸€ä¸ª convert çš„è¯ä¹Ÿå¾ˆç®€å•ã€‚</p><p>ä¸‹é¢å†è¯´ä¸€ä¸ªå®ç°è¿™ç§è½¬æ¢å¾ˆç®€å•çš„æ–¹å¼ï¼Œé‚£å°±æ˜¯å®ç° Converter æ¥å£ã€‚</p><p>æ¥çœ‹ä¸€ä¸ªå¾ˆç®€å•çš„ä¾‹å­ï¼Œè¿™æ ·æ¯”ä»€ä¹ˆéƒ½ç®¡ç”¨ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringToDateConverter</span> <span class="token keyword">implements</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">String</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">DateUtils</span><span class="token punctuation">.</span><span class="token function">parseDate</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;yyyy-MM-dd HH:mm&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;HH:mm:ss&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;HH:mm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åªè¦æ³¨å†Œè¿™ä¸ª Bean å°±å¯ä»¥äº†ã€‚è¿™æ ·ï¼Œå‰ç«¯å¾€åç«¯ä¼ çš„æ—¶é—´æè¿°å­—ç¬¦ä¸²å°±å¾ˆå®¹æ˜“ç»‘å®šæˆ Date ç±»å‹äº†ï¼Œä¸éœ€è¦å…¶ä»–ä»»ä½•æ“ä½œã€‚</p><h3 id="bean-ç»§æ‰¿" tabindex="-1"><a class="header-anchor" href="#bean-ç»§æ‰¿" aria-hidden="true">#</a> Bean ç»§æ‰¿</h3><p>åœ¨åˆå§‹åŒ– Bean çš„åœ°æ–¹ï¼Œæˆ‘ä»¬è¯´è¿‡äº†è¿™ä¸ªï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">RootBeanDefinition</span> bd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™é‡Œæ¶‰åŠåˆ°çš„å°±æ˜¯ <!----> ä¸­çš„ parent å±æ€§ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Spring ä¸­æ˜¯ç”¨è¿™ä¸ªæ¥å¹²ä»€ä¹ˆçš„ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç™½ï¼Œè¿™é‡Œçš„ç»§æ‰¿å’Œ java è¯­æ³•ä¸­çš„ç»§æ‰¿æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä¸è¿‡æ€è·¯æ˜¯ç›¸é€šçš„ã€‚child bean ä¼šç»§æ‰¿ parent bean çš„æ‰€æœ‰é…ç½®ï¼Œä¹Ÿå¯ä»¥è¦†ç›–ä¸€äº›é…ç½®ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ–°å¢é¢å¤–çš„é…ç½®ã€‚</p><p>Spring ä¸­æä¾›äº†ç»§æ‰¿è‡ª AbstractBeanDefinition çš„ ChildBeanDefinition æ¥è¡¨ç¤º child beanã€‚</p><p>çœ‹å¦‚ä¸‹ä¸€ä¸ªä¾‹å­:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">&quot;inheritedTestBean&quot;</span> <span class="token keyword">abstract</span><span class="token operator">=</span><span class="token string">&quot;true&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;org.springframework.beans.TestBean&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">&quot;name&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;parent&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">&quot;age&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;1&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">&quot;inheritsWithDifferentClass&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;org.springframework.beans.DerivedTestBean&quot;</span>
        parent<span class="token operator">=</span><span class="token string">&quot;inheritedTestBean&quot;</span> init<span class="token operator">-</span>method<span class="token operator">=</span><span class="token string">&quot;initialize&quot;</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">&quot;name&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;override&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>parent bean è®¾ç½®äº† abstract=&quot;true&quot; æ‰€ä»¥å®ƒä¸ä¼šè¢«å®ä¾‹åŒ–ï¼Œchild bean ç»§æ‰¿äº† parent bean çš„ä¸¤ä¸ªå±æ€§ï¼Œä½†æ˜¯å¯¹ name å±æ€§è¿›è¡Œäº†è¦†å†™ã€‚</p><p>child bean ä¼šç»§æ‰¿ scopeã€æ„é€ å™¨å‚æ•°å€¼ã€å±æ€§å€¼ã€init-methodã€destroy-method ç­‰ç­‰ã€‚</p><p>å½“ç„¶ï¼Œæˆ‘ä¸æ˜¯è¯´ parent bean ä¸­çš„ abstract = true åœ¨è¿™é‡Œæ˜¯å¿…é¡»çš„ï¼Œåªæ˜¯è¯´å¦‚æœåŠ ä¸Šäº†ä»¥å Spring åœ¨å®ä¾‹åŒ– singleton beans çš„æ—¶å€™ä¼šå¿½ç•¥è¿™ä¸ª beanã€‚</p><p>æ¯”å¦‚ä¸‹é¢è¿™ä¸ªæç«¯ parent beanï¼Œå®ƒæ²¡æœ‰æŒ‡å®š classï¼Œæ‰€ä»¥æ¯«æ— ç–‘é—®ï¼Œè¿™ä¸ª bean çš„ä½œç”¨å°±æ˜¯ç”¨æ¥å……å½“æ¨¡æ¿ç”¨çš„ parent beanï¼Œæ­¤å¤„å°±å¿…é¡»åŠ ä¸Š abstract = trueã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">&quot;inheritedTestBeanWithoutClass&quot;</span> <span class="token keyword">abstract</span><span class="token operator">=</span><span class="token string">&quot;true&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">&quot;name&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;parent&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">&quot;age&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;1&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ–¹æ³•æ³¨å…¥" tabindex="-1"><a class="header-anchor" href="#æ–¹æ³•æ³¨å…¥" aria-hidden="true">#</a> æ–¹æ³•æ³¨å…¥</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬çš„åº”ç”¨ä¸­å¤§å¤šæ•°çš„ Bean éƒ½æ˜¯ singleton çš„ã€‚singleton ä¾èµ– singletonï¼Œæˆ–è€… prototype ä¾èµ– prototype éƒ½å¾ˆå¥½è§£å†³ï¼Œç›´æ¥è®¾ç½®å±æ€§ä¾èµ–å°±å¯ä»¥äº†ã€‚</p><p>ä½†æ˜¯ï¼Œ<strong>å¦‚æœæ˜¯ singleton ä¾èµ– prototype</strong> å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™ä¸èƒ½ç”¨å±æ€§ä¾èµ–ï¼Œå› ä¸º<strong>å¦‚æœç”¨å±æ€§ä¾èµ–çš„è¯ï¼Œæˆ‘ä»¬æ¯æ¬¡å…¶å®æ‹¿åˆ°çš„è¿˜æ˜¯ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶å€™çš„ bean</strong>ã€‚</p><p>ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯ä¸è¦ç”¨å±æ€§ä¾èµ–ï¼Œ<strong>æ¯æ¬¡è·å–ä¾èµ–çš„ bean çš„æ—¶å€™ä» BeanFactory ä¸­å–</strong>ã€‚è¿™ä¸ªä¹Ÿæ˜¯å¤§å®¶æœ€å¸¸ç”¨çš„æ–¹å¼äº†å§ã€‚æ€ä¹ˆå–ï¼Œæˆ‘å°±ä¸ä»‹ç»äº†ï¼Œå¤§éƒ¨åˆ† Spring é¡¹ç›®å¤§å®¶éƒ½ä¼šå®šä¹‰é‚£ä¹ˆä¸ªå·¥å…·ç±»çš„ã€‚</p><p>å¦ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯è¿™é‡Œè¦ä»‹ç»çš„é€šè¿‡ä½¿ç”¨ Lookup methodã€‚</p><h4 id="lookup-method" tabindex="-1"><a class="header-anchor" href="#lookup-method" aria-hidden="true">#</a> lookup-method</h4><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Spring Reference ä¸­æä¾›çš„ä¸€ä¸ªä¾‹å­ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">fiona<span class="token punctuation">.</span>apple</span><span class="token punctuation">;</span>

<span class="token comment">// no more Spring imports!</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CommandManager</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">Object</span> commandState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// grab a new instance of the appropriate Command interface</span>
        <span class="token class-name">Command</span> command <span class="token operator">=</span> <span class="token function">createCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// set the state on the (hopefully brand new) Command instance</span>
        command<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>commandState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// okay... but where is the implementation of this method?</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">Command</span> <span class="token function">createCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>xml é…ç½® <!---->ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- a stateful bean deployed as a prototype (non-singleton) --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myCommand<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fiona.apple.AsyncCommand<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>prototype<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- inject dependencies here as required --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- commandProcessor uses statefulCommandHelper --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>commandManager<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fiona.apple.CommandManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lookup-method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>createCommand<span class="token punctuation">&quot;</span></span> <span class="token attr-name">bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myCommand<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Spring é‡‡ç”¨ CGLIB ç”Ÿæˆå­—èŠ‚ç çš„æ–¹å¼æ¥ç”Ÿæˆä¸€ä¸ªå­ç±»ã€‚æˆ‘ä»¬å®šä¹‰çš„ç±»ä¸èƒ½å®šä¹‰ä¸º final classï¼ŒæŠ½è±¡æ–¹æ³•ä¸Šä¹Ÿä¸èƒ½åŠ  finalã€‚</p><p>lookup-method ä¸Šçš„é…ç½®ä¹Ÿå¯ä»¥é‡‡ç”¨æ³¨è§£æ¥å®Œæˆï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨é…ç½® <!----> äº†ï¼Œå…¶ä»–ä¸å˜ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CommandManager</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">Object</span> commandState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyCommand</span> command <span class="token operator">=</span> <span class="token function">createCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        command<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>commandState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Lookup</span><span class="token punctuation">(</span><span class="token string">&quot;myCommand&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">Command</span> <span class="token function">createCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼Œæ—¢ç„¶ç”¨äº†æ³¨è§£ï¼Œè¦é…ç½®æ³¨è§£æ‰«æï¼š&lt;context:component-scan base-package=&quot;com.javadoop&quot; /&gt;</p><p>ç”šè‡³ï¼Œæˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CommandManager</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">Object</span> commandState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyCommand</span> command <span class="token operator">=</span> <span class="token function">createCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        command<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>commandState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Lookup</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">MyCommand</span> <span class="token function">createCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„è¿”å›å€¼ç”¨äº† MyCommandï¼Œå½“ç„¶ï¼Œå¦‚æœ Command åªæœ‰ä¸€ä¸ªå®ç°ç±»ï¼Œé‚£è¿”å›å€¼ä¹Ÿå¯ä»¥å†™ Commandã€‚</p><h4 id="replaced-method" tabindex="-1"><a class="header-anchor" href="#replaced-method" aria-hidden="true">#</a> replaced-method</h4><p>è®°ä½å®ƒçš„åŠŸèƒ½ï¼Œå°±æ˜¯æ›¿æ¢æ‰ bean ä¸­çš„ä¸€äº›æ–¹æ³•ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyValueCalculator</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">computeValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some real code...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// some other methods...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ–¹æ³•è¦†å†™ï¼Œæ³¨æ„è¦å®ç° MethodReplacer æ¥å£ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReplacementComputeValue</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>MethodReplacer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">reimplement</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">Method</span> m<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">// get the input value, work with it, and return a computed result</span>
        <span class="token class-name">String</span> input <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é…ç½®ä¹Ÿå¾ˆç®€å•ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myValueCalculator<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x.y.z.MyValueCalculator<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- å®šä¹‰ computeValue è¿™ä¸ªæ–¹æ³•è¦è¢«æ›¿æ¢æ‰ --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replaced-method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>computeValue<span class="token punctuation">&quot;</span></span> <span class="token attr-name">replacer</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>replacementComputeValue<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg-type</span><span class="token punctuation">&gt;</span></span>String<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg-type</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replaced-method</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>replacementComputeValue<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a.b.c.ReplacementComputeValue<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>arg-type æ˜æ˜¾ä¸æ˜¯å¿…é¡»çš„ï¼Œé™¤éå­˜åœ¨æ–¹æ³•é‡è½½ï¼Œè¿™æ ·å¿…é¡»é€šè¿‡å‚æ•°ç±»å‹åˆ—è¡¨æ¥åˆ¤æ–­è¿™é‡Œè¦è¦†ç›–å“ªä¸ªæ–¹æ³•ã€‚</p><h3 id="beanpostprocessor" tabindex="-1"><a class="header-anchor" href="#beanpostprocessor" aria-hidden="true">#</a> BeanPostProcessor</h3><p>åº”è¯¥è¯´ BeanPostProcessor æ¦‚å¿µåœ¨ Spring ä¸­ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚æˆ‘ä»¬çœ‹ä¸‹æ¥å£å®šä¹‰ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BeanPostProcessor</span> <span class="token punctuation">{</span>

   <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">;</span>

   <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çœ‹è¿™ä¸ªæ¥å£ä¸­çš„ä¸¤ä¸ªæ–¹æ³•åå­—æˆ‘ä»¬å¤§ä½“ä¸Šå¯ä»¥çŒœæµ‹ bean åœ¨åˆå§‹åŒ–ä¹‹å‰ä¼šæ‰§è¡Œ postProcessBeforeInitialization è¿™ä¸ªæ–¹æ³•ï¼Œåˆå§‹åŒ–å®Œæˆä¹‹åä¼šæ‰§è¡Œ postProcessAfterInitialization è¿™ä¸ªæ–¹æ³•ã€‚ä½†æ˜¯ï¼Œè¿™ä¹ˆç†è§£æ˜¯éå¸¸ç‰‡é¢çš„ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç™½ï¼Œé™¤äº†æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ BeanPostProcessor å®ç°å¤–ï¼ŒSpring å®¹å™¨åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨ç»™æˆ‘ä»¬ä¹ŸåŠ äº†å‡ ä¸ªã€‚å¦‚åœ¨è·å– BeanFactory çš„ obtainFactory() æ–¹æ³•ç»“æŸåçš„ prepareBeanFactory(factory)ï¼Œå¤§å®¶ä»”ç»†çœ‹ä¼šå‘ç°ï¼ŒSpring å¾€å®¹å™¨ä¸­æ·»åŠ äº†è¿™ä¸¤ä¸ª BeanPostProcessorï¼šApplicationContextAwareProcessorã€ApplicationListenerDetectorã€‚</p><p>æˆ‘ä»¬å›åˆ°è¿™ä¸ªæ¥å£æœ¬èº«ï¼Œè¯»è€…è¯·çœ‹ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥å—çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ bean å®ä¾‹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ bean çš„åå­—ï¼Œé‡ç‚¹åœ¨è¿”å›å€¼å°†ä¼šä½œä¸ºæ–°çš„ bean å®ä¾‹ï¼Œæ‰€ä»¥ï¼Œæ²¡äº‹çš„è¯è¿™é‡Œä¸èƒ½éšä¾¿è¿”å›ä¸ª nullã€‚</p><p>é‚£æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥å¯¹ä¸€äº›æˆ‘ä»¬æƒ³è¦ä¿®é¥°çš„ bean å®ä¾‹åšä¸€äº›äº‹æƒ…ã€‚ä½†æ˜¯å¯¹äº Spring æ¡†æ¶æ¥è¯´ï¼Œå®ƒä¼šå†³å®šæ˜¯ä¸æ˜¯è¦åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿”å› bean å®ä¾‹çš„ä»£ç†ï¼Œè¿™æ ·å°±æœ‰æ›´å¤§çš„æƒ³è±¡ç©ºé—´äº†ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬è¯´è¯´å¦‚æœæˆ‘ä»¬è‡ªå·±å®šä¹‰ä¸€ä¸ª bean å®ç° BeanPostProcessor çš„è¯ï¼Œå®ƒçš„æ‰§è¡Œæ—¶æœºæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ</p><p>å¦‚æœä»”ç»†çœ‹äº†ä»£ç åˆ†æçš„è¯ï¼Œå…¶å®å¾ˆå®¹æ˜“çŸ¥é“äº†ï¼Œåœ¨ bean å®ä¾‹åŒ–å®Œæˆã€å±æ€§æ³¨å…¥å®Œæˆä¹‹åï¼Œä¼šæ‰§è¡Œå›è°ƒæ–¹æ³•ï¼Œå…·ä½“è¯·å‚è§ç±» AbstractAutowireCapableBeanFactory#initBean æ–¹æ³•ã€‚</p><p>é¦–å…ˆä¼šå›è°ƒå‡ ä¸ªå®ç°äº† Aware æ¥å£çš„ beanï¼Œç„¶åå°±å¼€å§‹å›è°ƒ BeanPostProcessor çš„ postProcessBeforeInitialization æ–¹æ³•ï¼Œä¹‹åæ˜¯å›è°ƒ init-methodï¼Œç„¶åå†å›è°ƒ BeanPostProcessor çš„ postProcessAfterInitialization æ–¹æ³•ã€‚</p><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2><p>æŒ‰ç†è¯´ï¼Œæ€»ç»“åº”è¯¥å†™åœ¨é™„å½•å‰é¢ï¼Œæˆ‘å°±ä¸è®²ç©¶äº†ã€‚</p><p>åœ¨èŠ±äº†é‚£ä¹ˆå¤šæ—¶é—´åï¼Œè¿™ç¯‡æ–‡ç« ç»ˆäºç®—æ˜¯åŸºæœ¬å†™å®Œäº†ï¼Œå¤§å®¶åœ¨æƒŠå¹ Spring ç»™æˆ‘ä»¬åšäº†é‚£ä¹ˆå¤šçš„äº‹çš„æ—¶å€™ï¼Œåº”è¯¥é€è¿‡ç°è±¡çœ‹æœ¬è´¨ï¼Œå»ç†è§£ Spring å†™å¾—å¥½çš„åœ°æ–¹ï¼Œå»ç†è§£å®ƒçš„è®¾è®¡æ€æƒ³ã€‚</p><p>æœ¬æ–‡çš„ç¼ºé™·åœ¨äºå¯¹ Spring é¢„åˆå§‹åŒ– singleton beans çš„è¿‡ç¨‹åˆ†æä¸å¤Ÿï¼Œä¸»è¦æ˜¯ä»£ç é‡çœŸçš„æ¯”è¾ƒå¤§ï¼Œåˆ†æ”¯æ—è·¯ä¼—å¤šã€‚åŒæ—¶ï¼Œè™½ç„¶é™„å½•æ¡ç›®ä¸å°‘ï¼Œä½†æ˜¯åºå¤§çš„ Spring çœŸçš„å¼•å‡ºäº†å¾ˆå¤šçš„æ¦‚å¿µï¼Œå¸Œæœ›æ—¥åæœ‰ç²¾åŠ›å¯ä»¥æ…¢æ…¢è¡¥å……ä¸€äº›ã€‚</p><p>ï¼ˆå…¨æ–‡å®Œï¼‰</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/main/src/knowledgeBase/technicalArticleExtract/Spring/SpringIOCContainerSourceCodeAnalysis.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 1943805462@qq.com">huamus</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="vp-link nav-link prev" href="/myblogs/knowledgeBase/technicalArticleExtract/Spring/SpringAOPSourceCodeParsing.html"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->Spring AOP æºç è§£æ</div></a><!----></nav><div id="comment" class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><!--v-if--><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">æ˜µç§°</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">é‚®ç®±</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">ç½‘å€</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="è¯·ç•™è¨€ã€‚(å¡«å†™é‚®ç®±å¯åœ¨è¢«å›å¤æ—¶æ”¶åˆ°é‚®ä»¶æé†’)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>é¢„è§ˆ:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="è¡¨æƒ…" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="è¡¨æƒ…åŒ…"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="ä¸Šä¼ å›¾ç‰‡"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="é¢„è§ˆ"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <!--v-if--> Â å­—</div><button type="button" class="wl-btn">ç™»å½•</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->æäº¤<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="æœç´¢è¡¨æƒ…åŒ…"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> è¯„è®º</div><ul class="wl-sort"><!--[--><li class="active">æŒ‰æ­£åº</li><li class="">æŒ‰å€’åº</li><li class="">æŒ‰çƒ­åº¦</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><!--[--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><!--]--><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v2.15.5</div></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">é»˜è®¤é¡µè„š</div><div class="vp-copyright">Copyright Â© 2023 huamus</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/myblogs/assets/app-39e7b6f2.js" defer></script>
  </body>
</html>
